<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>基于VictoriaMetrics的大规模监控实战 | 杂烩饭</title><meta name="author" content="张理坤"><meta name="copyright" content="张理坤"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="victoriametrics 原生支持水平扩展，并且大部分兼容 Prometheus 语法，官方文档地址：https:&#x2F;&#x2F;docs.victoriametrics.com&#x2F; 这个是 victoriametrics 官方的集群架构  我公司用到的集群架构  目前用到 3 台机器    IP 部署的服务    10.0.0.21 vmauth、vmselect、vminsert、vmstorage、">
<meta property="og:type" content="article">
<meta property="og:title" content="基于VictoriaMetrics的大规模监控实战">
<meta property="og:url" content="https://zahui.fan/posts/e59d8e32/">
<meta property="og:site_name" content="杂烩饭">
<meta property="og:description" content="victoriametrics 原生支持水平扩展，并且大部分兼容 Prometheus 语法，官方文档地址：https:&#x2F;&#x2F;docs.victoriametrics.com&#x2F; 这个是 victoriametrics 官方的集群架构  我公司用到的集群架构  目前用到 3 台机器    IP 部署的服务    10.0.0.21 vmauth、vmselect、vminsert、vmstorage、">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static.zahui.fan/public/skeleton1.svg">
<meta property="article:published_time" content="2022-06-16T20:02:36.000Z">
<meta property="article:modified_time" content="2024-10-31T03:20:09.000Z">
<meta property="article:author" content="张理坤">
<meta property="article:tag" content="配置记录">
<meta property="article:tag" content="prometheus">
<meta property="article:tag" content="monitor">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static.zahui.fan/public/skeleton1.svg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "基于VictoriaMetrics的大规模监控实战",
  "url": "https://zahui.fan/posts/e59d8e32/",
  "image": "https://static.zahui.fan/public/skeleton1.svg",
  "datePublished": "2022-06-16T20:02:36.000Z",
  "dateModified": "2024-10-31T03:20:09.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "张理坤",
      "url": "https://zahui.fan/"
    }
  ]
}</script><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://zahui.fan/posts/e59d8e32/"><link rel="preconnect"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/site.webmanifest"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?50b516d50102c8c9ac5f80529b81ca17";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-YN0WWZGVYN"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-YN0WWZGVYN')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-YN0WWZGVYN', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于VictoriaMetrics的大规模监控实战',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="杂烩饭" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://static.zahui.fan/public/dog.svg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">362</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">219</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://static.zahui.fan/public/skeleton1.svg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://static.zahui.fan/public/boob.png" alt="Logo"><span class="site-name">杂烩饭</span></a><a class="nav-page-title" href="/"><span class="site-name">基于VictoriaMetrics的大规模监控实战</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">基于VictoriaMetrics的大规模监控实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-16T20:02:36.000Z" title="发表于 2022-06-17 04:02:36">2022-06-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-31T03:20:09.000Z" title="更新于 2024-10-31 11:20:09">2024-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%9B%91%E6%8E%A7/">监控</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;此文章距离发布已经&quot;,&quot;messageNext&quot;:&quot;天了，内容可能已经过时，请自行判断是否可用或联系博主更新。&quot;,&quot;postUpdate&quot;:&quot;2024-10-31 11:20:09&quot;}" hidden></div><p>victoriametrics 原生支持水平扩展，并且大部分兼容 Prometheus 语法，官方文档地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.victoriametrics.com/">https://docs.victoriametrics.com/</a></p>
<p>这个是 victoriametrics 官方的集群架构</p>
<p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20220617162704.png" alt="victoriametrics集群架构"></p>
<p>我公司用到的集群架构</p>
<p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202206182239511.png" alt="我公司用到的集群"></p>
<p>目前用到 3 台机器</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>部署的服务</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.21</td>
<td>vmauth、vmselect、vminsert、vmstorage、vmalert</td>
</tr>
<tr>
<td>10.0.0.22</td>
<td>vmselect、vminsert、vmstorage</td>
</tr>
<tr>
<td>10.0.0.23</td>
<td>vmselect、vminsert、vmstorage</td>
</tr>
</tbody></table>
<h2 id="vmstorage"><a href="#vmstorage" class="headerlink" title="vmstorage"></a>vmstorage</h2><p>首先需要把存储部署上，多个存储之间数据是不同步的，也就是说所有的 storege 组件之间是感知不到彼此的。通过 vmselect 和 vminsert 采用一致性 hash 算法来确定读取&#x2F;写入哪台节点。</p>
<p>vmstorage 启动命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./vmstorage-prod -httpListenAddr <span class="string">&quot;0.0.0.0:8482&quot;</span> \   <span class="comment"># vmstorage监听端口</span></span><br><span class="line">    -storageDataPath ./data \                       <span class="comment"># 数据存储位置</span></span><br><span class="line">    -retentionPeriod 60d \                          <span class="comment"># 数据保留多久</span></span><br><span class="line">    -vminsertAddr <span class="string">&quot;0.0.0.0:8400&quot;</span> \                  <span class="comment"># insert服务连接的端口</span></span><br><span class="line">    -vmselectAddr <span class="string">&quot;0.0.0.0:8401&quot;</span> \                  <span class="comment"># select服务连接的端口</span></span><br><span class="line">    -dedup.minScrapeInterval=30s \                  <span class="comment"># 和vmselect保持一致</span></span><br><span class="line">    -loggerTimezone <span class="string">&quot;Asia/Shanghai&quot;</span> \</span><br><span class="line">    -loggerLevel INFO</span><br></pre></td></tr></table></figure>

<h2 id="vminsert"><a href="#vminsert" class="headerlink" title="vminsert"></a>vminsert</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./vminsert-prod -httpListenAddr <span class="string">&quot;0.0.0.0:8480&quot;</span> \</span><br><span class="line">    -storageNode 10.0.0.21:8400,10.0.0.22:8400,10.0.0.23:8400 \       <span class="comment"># 指定所有storege节点</span></span><br><span class="line">    -replicationFactor 2 \                                                  <span class="comment"># 副本数2</span></span><br><span class="line">    -loggerTimezone<span class="string">&quot;Asia/Shanghai&quot;</span> \</span><br><span class="line">    -loggerLevel INFO</span><br></pre></td></tr></table></figure>

<h2 id="vmselect"><a href="#vmselect" class="headerlink" title="vmselect"></a>vmselect</h2><p>vmselect 启动命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./vmselect-prod -httpListenAddr <span class="string">&quot;0.0.0.0:8481&quot;</span> \</span><br><span class="line">    -selectNode 10.0.0.21:8481,10.0.0.22:8481,10.0.0.23:8481 \    <span class="comment"># select的所有节点</span></span><br><span class="line">    -storageNode 10.0.0.21:8401,10.0.0.22:8401,10.0.0.23:8401 \   <span class="comment"># 指定所有storage节点</span></span><br><span class="line">    -dedup.minScrapeInterval=30s \                                      <span class="comment"># 重复数据删除，如果是从Prometheus写入的话，必须和Prometheus的scrape_interval保持一致。</span></span><br><span class="line">    -loggerTimezone <span class="string">&quot;Asia/Shanghai&quot;</span> \</span><br><span class="line">    -loggerLevel INFO</span><br></pre></td></tr></table></figure>

<h2 id="vmalert"><a href="#vmalert" class="headerlink" title="vmalert"></a>vmalert</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">./vmalert-prod -rule=./rules/* \                            <span class="comment"># 告警规则目录</span></span><br><span class="line">    -datasource.url=http://10.0.0.21:8427 \               <span class="comment"># vmselect的url,一般都是负载均衡地址</span></span><br><span class="line">    -datasource.basicAuth.username admin \                  <span class="comment"># vmselect的url认证用户名</span></span><br><span class="line">    -datasource.basicAuth.password 123456 \                <span class="comment"># vmselect的url认证密码</span></span><br><span class="line">    -notifier.url=http://10.0.0.11:9093 \                 <span class="comment"># alertmanager地址</span></span><br><span class="line">    -remoteWrite.url=http://10.0.0.21:8427 \              <span class="comment"># vminsert的url,一般都是负载均衡地址</span></span><br><span class="line">    -remoteWrite.basicAuth.username admin \                 <span class="comment"># vminsert的url认证用户名</span></span><br><span class="line">    -remoteWrite.basicAuth.password 123456 \               <span class="comment"># vminsert的url认证密码</span></span><br><span class="line">    -evaluationInterval=15s \</span><br><span class="line">    -httpListenAddr=0.0.0.0:8080</span><br></pre></td></tr></table></figure>

<h2 id="负载均衡配置"><a href="#负载均衡配置" class="headerlink" title="负载均衡配置"></a>负载均衡配置</h2><h3 id="vmauth-负载均衡配置"><a href="#vmauth-负载均衡配置" class="headerlink" title="vmauth 负载均衡配置"></a>vmauth 负载均衡配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./vmauth-prod -auth.config=./vmauth.yml</span><br></pre></td></tr></table></figure>

<p>其中 vmauth.yml 的配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">username:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">  <span class="attr">url_map:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">src_paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/api/v1/query&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/api/v1/query_range&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/api/v1/label/[^/]+/values&quot;</span></span><br><span class="line">    <span class="attr">url_prefix:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.21:8481/select/0/prometheus&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.22:8481/select/0/prometheus&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.23:8481/select/0/prometheus&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">src_paths:</span> [<span class="string">&quot;/api/v1/write&quot;</span>]</span><br><span class="line">    <span class="attr">url_prefix:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.21:8480/insert/0/prometheus&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.22:8480/insert/0/prometheus&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.23:8480/insert/0/prometheus&quot;</span></span><br><span class="line"><span class="comment">#    headers:</span></span><br><span class="line"><span class="comment">#    - &quot;X-Scope-OrgID: abc&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="nginx-负载均衡配置"><a href="#nginx-负载均衡配置" class="headerlink" title="nginx 负载均衡配置"></a>nginx 负载均衡配置</h3><p>如果你不想用 vmauth，nginx 功能可以完全覆盖 vmauth</p>
<p>nginx 配置示例：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">upstream  vmselect &#123;</span><br><span class="line">    server  10.0.0.21:8481 weight=5 ;</span><br><span class="line">    server  10.0.0.22:8481 weight=5 ;</span><br><span class="line">    server  10.0.0.23:8481 weight=5 ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 8000;</span><br><span class="line">    server_name _;</span><br><span class="line">    auth_basic &quot;authentication&quot;;                # 开启基本认证</span><br><span class="line">    auth_basic_user_file conf.d/.htpasswd;      # 密码文件</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://vmselect/select/0/prometheus/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream vminsert &#123;</span><br><span class="line">    server  10.0.0.21:8480 weight=5 ;</span><br><span class="line">    server  10.0.0.22:8480 weight=5 ;</span><br><span class="line">    server  10.0.0.23:8480 weight=5 ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 8001;</span><br><span class="line">    server_name _;</span><br><span class="line">    auth_basic &quot;authentication&quot;;                # 开启基本认证</span><br><span class="line">    auth_basic_user_file conf.d/.htpasswd;      # 密码文件</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://vminsert/insert/0/prometheus/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>.htpasswd 文件格式：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin:$1$QYnl4A1Q$I8Q712.eKtG9m7sAb9oeM1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>admin 是用户名, : 后面的是密码， 密码可以使用 <code>openssl passwd -1 123456</code> 来生成（假设原始密码是 123456）</p>
</blockquote>
<h2 id="常用的配置"><a href="#常用的配置" class="headerlink" title="常用的配置"></a>常用的配置</h2><h3 id="Prometheus-通过-remote-write-写入-vm-集群"><a href="#Prometheus-通过-remote-write-写入-vm-集群" class="headerlink" title="Prometheus 通过 remote_write 写入 vm 集群"></a>Prometheus 通过 remote_write 写入 vm 集群</h3><blockquote>
<p>官方文档：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#remote_write">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#remote_write</a></p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">remote_write:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&quot;http://10.0.0.21:8001/api/v1/write&quot;</span>                           <span class="comment"># 通过负载均衡地址</span></span><br><span class="line"><span class="comment"># - url: &quot;http://10.0.0.21:8480/insert/0/prometheus/api/v1/write&quot;     # 直接连接vminsert组件</span></span><br><span class="line">  <span class="attr">basic_auth:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">remote_timeout:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">queue_config:</span></span><br><span class="line">    <span class="attr">capacity:</span> <span class="number">2500</span></span><br><span class="line">    <span class="attr">max_shards:</span> <span class="number">200</span></span><br><span class="line">    <span class="attr">min_shards:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">max_samples_per_send:</span> <span class="number">500</span></span><br><span class="line">    <span class="attr">batch_send_deadline:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">min_backoff:</span> <span class="string">30ms</span></span><br><span class="line">    <span class="attr">max_backoff:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<blockquote>
<p>官方地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://prometheus.io/docs/practices/remote_write/">https://prometheus.io/docs/practices/remote_write/</a></p>
</blockquote>
<ul>
<li><p>capacity</p>
<p>  定义：每个内存队列（shard：分片）的容量。</p>
<p>  一旦 WAL 被阻塞，就无法将样本附加到任何分片，并且所有吞吐量都将停止。所以在大多数情况下，单个队列容量应足够打以避免阻塞其他分片，但是太大的容量可能会导致过多的内存消耗，并导致重新分片期间清除队列的时间更长。</p>
<p>  容量建议：将容量设置为 3-10 倍 <code>max_samples_per_send</code></p>
</li>
<li><p>max_shards</p>
<p>  顾名思义，最大的分片数（即队列数），也可以理解为远程写的并行度。peometheus 远程写的时候会使用所有的分片，只有在写队列落后于远程写的速度，使用的队列数会达到 max_shards,目的在于提高远程写的吞吐量。</p>
<p>  PS：在操作过程中，Prometheus 将根据传入的采样率，未发送的未处理样本数以及发送每个样本所花费的时间，连续计算要使用的最佳分片数。（实际的分片数是动态调整的）</p>
</li>
<li><p>min_shards</p>
<p>  最小分片配置 Prometheus 使用的最小分片数量，并且是远程写入开始时使用的分片数量。如果远程写入落后，Prometheus 将自动扩大分片的数量，因此大多数用户不必调整此参数。但是，增加最小分片数将使 Prometheus 在计算所需分片数时避免在一开始就落后。</p>
</li>
<li><p>max_samples_per_send</p>
<p>  定义：每次远程写发送的最大指标数量，即批处理；</p>
<p>  这个值依赖于远程存储系统，对于一些系统而言，在没有显著增加延迟的情况下发送更多指标数据而运行良好，然而，对于另外一些系统而言，每次请求中发送大量指标数据可能导致其出现故障，使用的默认值是适用于绝大多数系统的。</p>
</li>
<li><p>batch_send_deadline</p>
<p>  定义：单一分片批量发送指标数据的最大等待时间；</p>
<p>  即使排队的分片尚未达到 max_samples_per_send，也会发送请求。 对于对延迟不敏感的小批量系统，可以增加批量发送的截止时间，以提高请求效率。</p>
</li>
<li><p>min_backoff</p>
<p>  定义：远程写失败的最小等待时间；</p>
<p>  min_backoff 是第一次的重试等待时间，第二次等待时间是其 2 倍，以此类推，直到 max_backoff 的值；</p>
</li>
<li><p>max_backoff</p>
<p>  定义：远程写失败的最大等待时间；</p>
</li>
</ul>
<h3 id="Grafana-直接查询-VM-集群"><a href="#Grafana-直接查询-VM-集群" class="headerlink" title="Grafana 直接查询 VM 集群"></a>Grafana 直接查询 VM 集群</h3><p>Grafana 配置地址：</p>
<table>
<thead>
<tr>
<th>说明</th>
<th>地址</th>
</tr>
</thead>
<tbody><tr>
<td>负载均衡地址</td>
<td><code>http://10.0.0.21:8000</code></td>
</tr>
<tr>
<td>vmselect 地址</td>
<td><code>http://10.0.0.21:8481/select/0/prometheus</code></td>
</tr>
</tbody></table>
<h3 id="其他-API-地址"><a href="#其他-API-地址" class="headerlink" title="其他 API 地址"></a>其他 API 地址</h3><p>目录：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://10.0.0.21:8481/select/0/">http://10.0.0.21:8481/select/0/</a></p>
<p>vmui：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://10.0.0.21:8481/select/0/vmui/">http://10.0.0.21:8481/select/0/vmui/</a></p>
<p>每个组件都有 <code>/metrics</code>，可以接入监控</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zahui.fan">张理坤</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zahui.fan/posts/e59d8e32/">https://zahui.fan/posts/e59d8e32/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zahui.fan" target="_blank">杂烩饭</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/">配置记录</a><a class="post-meta__tags" href="/tags/prometheus/">prometheus</a><a class="post-meta__tags" href="/tags/monitor/">monitor</a></div><div class="post-share"><div class="social-share" data-image="https://static.zahui.fan/public/skeleton1.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/0cebb8ae/" title="使用Keepalived来实现Nginx高可用"><img class="cover" src="https://static.zahui.fan/public/Nginx.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">使用Keepalived来实现Nginx高可用</div></div><div class="info-2"><div class="info-item-1">公有云不会考虑这些，不过自建机房，使用 nginx 做入口，keepalived 是唯一的选择。    节点 IP    keepalived 主 10.0.0.45   keepalived 备 10.0.0.44   vip 10.0.0.46   组播模式keepalived1keepalived2123456789101112131415161718192021222324252627282930313233global_defs &#123;    script_user root            # 脚本执行者    enable_script_security      # 标记脚本安全&#125;vrrp_script check_script &#123;    script &quot;killall -0 nginx&quot;          # 脚本路径, 返回值为0则正常，不为0认为不正常    # 可替代的命令:    # /usr/sbin/pidof nginx             这个命令不推荐, 多个进程pid会出问题    #...</div></div></div></a><a class="pagination-related" href="/posts/ac395656/" title="Prometheus手动打标签"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Prometheus手动打标签</div></div><div class="info-2"><div class="info-item-1">有时候需要给 Prometheus 打标签，比如说联邦集群接入，需要知道是哪个集群，remote write 写入的时候也需要做个标记。 直接在集群打标签vim prometheus.yml 12345678910global:  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.  # scrape_timeout is set to the global default (10s).  external_labels:    env: uat    dept: ops    project: xxx...  这样就可以给集群内的所有 metrics...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/lswszwbz/" title="Grafana 监控面板配置"><img class="cover" src="https://static.zahui.fan/public/Grafana.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Grafana 监控面板配置</div></div><div class="info-2"><div class="info-item-1">安装 grafanaoss：开源版本 enterprise: 商业版本 https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1&amp;edition=oss 添加数据源以 grafana 10.3.3 为例， 在 connections –&gt; Data sources 中新增：  面板配置可以手动配置，也可以在 grafana 官网下载别人配置好的模板：https://grafana.com/grafana/dashboards/, 复制 ID 或者下载 json 文件到本地 然后在面板上面，点击 + ， 选择 import dashboard 使用 json 文件导入或者直接输入面板 id 进行导入。  导入后便能看到基础的图形。 做变量筛选比如我们的监控会区分环境， 比如开发环境 dev，生产环境 prod， 现在需要在 grafana 的面板上做一个筛选框，这里是原始的数据：比如我们需要取 env 的值 在面板的设置 – 变量中， 添加一个变量， 变量名可以自定义，...</div></div></div></a><a class="pagination-related" href="/posts/ln38vw8d/" title="快速安装Prometheus监控组件"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-11-18</div><div class="info-item-2">快速安装Prometheus监控组件</div></div><div class="info-2"><div class="info-item-1">复制粘贴就能用，适用于非容器化安装， k8s 环境看这个， 更方便 Kubernetes中使用Prometheus对集群节点做监控 安装方式为二进制安装，使用 systemd 来管理（也可以使用 supervisor 等进程管理工具） 安装 node_exporter123456789101112131415161718192021[ -d /data/src ] || mkdir -p /data/srccd /data/src/curl -OL -C - https://file.babudiu.com/f/rRi2/node_exporter-1.6.1.linux-amd64.tar.gztar xf node_exporter-1.6.1.linux-amd64.tar.gzln -sf /data/src/node_exporter-1.6.1.linux-amd64 ../node_exportercat &gt;/etc/systemd/system/node_exporter.service...</div></div></div></a><a class="pagination-related" href="/posts/61baae6f/" title="Kubernetes中使用Prometheus对集群节点做监控"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Kubernetes中使用Prometheus对集群节点做监控</div></div><div class="info-2"><div class="info-item-1">正常情况下使用 Prometheus 对机器做监控，比如监控 CPU、内存、磁盘等信息， 都是在机器上安装一个 node exporter， 然后将 metrics 接入到 Prometheus 中。在 k8s 环境下， 我们可以使用 k8s 来管理， 实现自动化监控。 node exporter 是针对主机节点的， 需要在每台 node 节点上安装， 那么 daemonset 控制器是最合理的选择。 网络使用 Host Network 模式， 在主机上直接暴露一个端口。 部署 node exporter使用 yaml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263apiVersion: apps/v1kind: DaemonSetmetadata:  name: node-exporter  namespace: monitor  labels:    name:...</div></div></div></a><a class="pagination-related" href="/posts/ac395656/" title="Prometheus手动打标签"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Prometheus手动打标签</div></div><div class="info-2"><div class="info-item-1">有时候需要给 Prometheus 打标签，比如说联邦集群接入，需要知道是哪个集群，remote write 写入的时候也需要做个标记。 直接在集群打标签vim prometheus.yml 12345678910global:  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.  # scrape_timeout is set to the global default (10s).  external_labels:    env: uat    dept: ops    project: xxx...  这样就可以给集群内的所有 metrics...</div></div></div></a><a class="pagination-related" href="/posts/lmeiruso/" title="WSL2 - Ubuntu配置记录"><img class="cover" src="https://static.zahui.fan/public/wsl.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-12-09</div><div class="info-item-2">WSL2 - Ubuntu配置记录</div></div><div class="info-2"><div class="info-item-1">WSL 防火墙规则123Get-NetAdapterNew-NetFirewallRule -DisplayName &quot;WSL&quot; -Direction Inbound  -InterfaceAlias &quot;vEthernet (WSL)&quot;  -Action Allow  基础环境配置更换源使用中科大的源: https://mirrors.ustc.edu.cn/help/ubuntu.html 12345# 老版本Ubuntu# sudo sed -i &#x27;s@//.*.ubuntu.com@//mirrors.ustc.edu.cn@g&#x27; /etc/apt/sources.list# Ubuntu 24 及以上sudo sed -i &#x27;s@//.*.ubuntu.com@//mirrors.ustc.edu.cn@g&#x27; /etc/apt/sources.list.d/ubuntu.sources  安装常用的包12sudo apt update &amp;&amp; sudo apt upgrade...</div></div></div></a><a class="pagination-related" href="/posts/81886814/" title="WSLg配置图形支持和配置rime输入法"><img class="cover" src="https://static.zahui.fan/public/wsl.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">WSLg配置图形支持和配置rime输入法</div></div><div class="info-2"><div class="info-item-1">WSLg 是微软的 wsl2 中自带的显示图形界面的功能，可以和 windows 完美融合在一块，不过由于 wsl 系统比较精简，会缺少一些图形包和输入法等。 设置中文显示安装依赖包12345678# 安装中文字体sudo apt install language-pack-zh-hans fonts-noto-cjk fonts-noto-cjk-extra# locales 配置 en_US.UTF-8 和 zh_CN.UTF-8 sudo sed -i &#x27;s/^# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/g&#x27; /etc/locale.gensudo sed -i &#x27;s/^# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/g&#x27; /etc/locale.gensudo locale-gen  设置显示语言为中文1234sudo tee /etc/default/locale...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://static.zahui.fan/public/dog.svg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">张理坤</div><div class="author-info-description">张理坤的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">362</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">219</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/iuxt"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/iuxt" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:x@zahui.fan" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/165330963" rel="external nofollow noreferrer" target="_blank" title="Bilibili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="https://stackoverflow.com/users/15620461/" rel="external nofollow noreferrer" target="_blank" title="StackOverflow"><i class="fa-brands fa-stack-overflow"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-square-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">此博客为我记录运维工作总结所用，供网友阅读参考，如有侵权，请通知我，我会核实后进行处理。</br>
<strong style="color: red;">欢迎加入技术交流群：</strong>
<div class="aside-qrcode" >
<img src="https://src.babudiu.com/card/wechat_ops_group.JPG" title="微信群" width="100%" height="auto">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#vmstorage"><span class="toc-number">1.</span> <span class="toc-text">vmstorage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vminsert"><span class="toc-number">2.</span> <span class="toc-text">vminsert</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vmselect"><span class="toc-number">3.</span> <span class="toc-text">vmselect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vmalert"><span class="toc-number">4.</span> <span class="toc-text">vmalert</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">负载均衡配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vmauth-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.</span> <span class="toc-text">vmauth 负载均衡配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.</span> <span class="toc-text">nginx 负载均衡配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">6.</span> <span class="toc-text">常用的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus-%E9%80%9A%E8%BF%87-remote-write-%E5%86%99%E5%85%A5-vm-%E9%9B%86%E7%BE%A4"><span class="toc-number">6.1.</span> <span class="toc-text">Prometheus 通过 remote_write 写入 vm 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Grafana-%E7%9B%B4%E6%8E%A5%E6%9F%A5%E8%AF%A2-VM-%E9%9B%86%E7%BE%A4"><span class="toc-number">6.2.</span> <span class="toc-text">Grafana 直接查询 VM 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-API-%E5%9C%B0%E5%9D%80"><span class="toc-number">6.3.</span> <span class="toc-text">其他 API 地址</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/sxztsa/" title="使用blackbox-exporter做域名监控"><img src="https://static.zahui.fan/public/skeleton1.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用blackbox-exporter做域名监控"/></a><div class="content"><a class="title" href="/posts/sxztsa/" title="使用blackbox-exporter做域名监控">使用blackbox-exporter做域名监控</a><time datetime="2025-06-18T07:28:39.000Z" title="更新于 2025-06-18 15:28:39">2025-06-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/so24vr/" title="Windows中的符号连接"><img src="https://static.zahui.fan/public/skeleton1.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows中的符号连接"/></a><div class="content"><a class="title" href="/posts/so24vr/" title="Windows中的符号连接">Windows中的符号连接</a><time datetime="2025-06-12T08:21:55.000Z" title="更新于 2025-06-12 16:21:55">2025-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/sxl41q/" title="MySQL字符集转换导致的故障"><img src="https://static.zahui.fan/public/skeleton1.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL字符集转换导致的故障"/></a><div class="content"><a class="title" href="/posts/sxl41q/" title="MySQL字符集转换导致的故障">MySQL字符集转换导致的故障</a><time datetime="2025-06-10T11:34:42.000Z" title="更新于 2025-06-10 19:34:42">2025-06-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/lrr6ze9h/" title="macOS常用操作记录"><img src="https://static.zahui.fan/public/macos.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="macOS常用操作记录"/></a><div class="content"><a class="title" href="/posts/lrr6ze9h/" title="macOS常用操作记录">macOS常用操作记录</a><time datetime="2025-06-07T17:39:17.000Z" title="更新于 2025-06-08 01:39:17">2025-06-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b670229a/" title="编译安装MySQL5.7"><img src="https://static.zahui.fan/public/MySQL.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="编译安装MySQL5.7"/></a><div class="content"><a class="title" href="/posts/b670229a/" title="编译安装MySQL5.7">编译安装MySQL5.7</a><time datetime="2025-06-05T10:59:40.000Z" title="更新于 2025-06-05 18:59:40">2025-06-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href='https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral'>
  本网站由<img src='https://static.zahui.fan/public/upyun.svg' alt='又拍云' width='70' height='28' style="vertical-align:bottom">
  提供CDN加速/云存储服务
</a>
</br>
<a href="https://beian.miit.gov.cn/" rel="external nofollow noreferrer" target="_blank">沪ICP备2021015230号-1</a>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.babudiu.com/client.js',
      'data-repo': 'iuxt/iuxt.github.io',
      'data-repo-id': 'R_kgDOMszkdA',
      'data-category-id': 'DIC_kwDOMszkdM4CiMyw',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.babudiu.com')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜搜搜" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>