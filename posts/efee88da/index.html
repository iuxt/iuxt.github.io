<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Ubuntu_Charmed_Kubernetes | 杂烩饭</title><meta name="author" content="张理坤"><meta name="copyright" content="张理坤"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="官方文档: https:&#x2F;&#x2F;ubuntu.com&#x2F;kubernetes&#x2F;docs  开始之前集群 ip 规划，所有机器系统都是 ubuntu 20.04    hostname ip    juju-client 10.0.0.10   juju-controller-1 10.0.0.11   juju-master-1 10.0.0.21   juju-master-2 10.0.0.22">
<meta property="og:type" content="article">
<meta property="og:title" content="Ubuntu_Charmed_Kubernetes">
<meta property="og:url" content="https://zahui.fan/posts/efee88da/">
<meta property="og:site_name" content="杂烩饭">
<meta property="og:description" content="官方文档: https:&#x2F;&#x2F;ubuntu.com&#x2F;kubernetes&#x2F;docs  开始之前集群 ip 规划，所有机器系统都是 ubuntu 20.04    hostname ip    juju-client 10.0.0.10   juju-controller-1 10.0.0.11   juju-master-1 10.0.0.21   juju-master-2 10.0.0.22">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static.zahui.fan/public/Canonical%20Kubernetes.svg">
<meta property="article:published_time" content="2021-04-19T09:02:22.000Z">
<meta property="article:modified_time" content="2024-10-31T03:20:09.000Z">
<meta property="article:author" content="张理坤">
<meta property="article:tag" content="配置记录">
<meta property="article:tag" content="Ubuntu">
<meta property="article:tag" content="keepalived">
<meta property="article:tag" content="Container">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static.zahui.fan/public/Canonical%20Kubernetes.svg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ubuntu_Charmed_Kubernetes",
  "url": "https://zahui.fan/posts/efee88da/",
  "image": "https://static.zahui.fan/public/Canonical%20Kubernetes.svg",
  "datePublished": "2021-04-19T09:02:22.000Z",
  "dateModified": "2024-10-31T03:20:09.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "张理坤",
      "url": "https://zahui.fan/"
    }
  ]
}</script><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://zahui.fan/posts/efee88da/"><link rel="preconnect"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/site.webmanifest"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?50b516d50102c8c9ac5f80529b81ca17";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-YN0WWZGVYN"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-YN0WWZGVYN')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-YN0WWZGVYN', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ubuntu_Charmed_Kubernetes',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="https://static.zahui.fan/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="杂烩饭" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://static.zahui.fan/public/dog.svg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">354</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">218</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://static.zahui.fan/public/Canonical%20Kubernetes.svg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://static.zahui.fan/public/boob.png" alt="Logo"><span class="site-name">杂烩饭</span></a><a class="nav-page-title" href="/"><span class="site-name">Ubuntu_Charmed_Kubernetes</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Ubuntu_Charmed_Kubernetes</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-04-19T09:02:22.000Z" title="发表于 2021-04-19 17:02:22">2021-04-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-31T03:20:09.000Z" title="更新于 2024-10-31 11:20:09">2024-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;此文章距离发布已经&quot;,&quot;messageNext&quot;:&quot;天了，内容可能已经过时，请自行判断是否可用或联系博主更新。&quot;,&quot;postUpdate&quot;:&quot;2024-10-31 11:20:09&quot;}" hidden></div><blockquote>
<p>官方文档: <a target="_blank" rel="noopener external nofollow noreferrer" href="https://ubuntu.com/kubernetes/docs">https://ubuntu.com/kubernetes/docs</a></p>
</blockquote>
<h2 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h2><p>集群 ip 规划，所有机器系统都是 <code>ubuntu 20.04</code></p>
<table>
<thead>
<tr>
<th>hostname</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>juju-client</td>
<td>10.0.0.10</td>
</tr>
<tr>
<td>juju-controller-1</td>
<td>10.0.0.11</td>
</tr>
<tr>
<td>juju-master-1</td>
<td>10.0.0.21</td>
</tr>
<tr>
<td>juju-master-2</td>
<td>10.0.0.22</td>
</tr>
<tr>
<td>juju-master-3</td>
<td>10.0.0.23</td>
</tr>
<tr>
<td>juju-worker-1</td>
<td>10.0.0.31</td>
</tr>
<tr>
<td>juju-worker-2</td>
<td>10.0.0.32</td>
</tr>
</tbody></table>
<blockquote>
<p>juju-client 为 juju 客户端和 haproxy 机器<br>juju-controller-1 为 juju 控制器节点 (可以做高可用)</p>
</blockquote>
<p>以下操作都是在 juju-client 上执行</p>
<h3 id="安装-juju"><a href="#安装-juju" class="headerlink" title="安装 juju"></a>安装 juju</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo snap install juju --classic</span><br></pre></td></tr></table></figure>

<h3 id="设置云类型"><a href="#设置云类型" class="headerlink" title="设置云类型"></a>设置云类型</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju add-cloud</span><br><span class="line">输入manual</span><br></pre></td></tr></table></figure>

<h3 id="添加机器-一共-5-台"><a href="#添加机器-一共-5-台" class="headerlink" title="添加机器 (一共 5 台)"></a>添加机器 (一共 5 台)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju bootstrap</span><br><span class="line">juju add-machine ssh:root@x.x.x.x</span><br></pre></td></tr></table></figure>

<blockquote>
<p>机器添加完成后, <code>juju machines</code> 能看到机器 id</p>
</blockquote>
<h3 id="生成-yaml"><a href="#生成-yaml" class="headerlink" title="生成 yaml"></a>生成 yaml</h3><p><del>在<a target="_blank" rel="noopener external nofollow noreferrer" href="https://jujucharms.com/new/">https://jujucharms.com/new/</a>画图，然后导出成 yaml</del><br><code>etcd</code> 还是 和 <code>master</code> 分开部署<br>etcd.yaml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">description:</span> <span class="string">Kubernetes</span> <span class="string">Cluster</span> <span class="string">Deploy.</span></span><br><span class="line"><span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line"><span class="attr">machines:</span></span><br><span class="line">  <span class="attr">&#x27;0&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;1&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;2&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;3&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;4&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line"><span class="attr">applications:</span></span><br><span class="line">  <span class="attr">easyrsa:</span></span><br><span class="line">    <span class="attr">charm:</span> <span class="string">cs:~containers/easyrsa-345</span></span><br><span class="line">    <span class="attr">num_units:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">easyrsa:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="attr">charm:</span> <span class="string">cs:~containers/etcd-553</span></span><br><span class="line">    <span class="attr">num_units:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">channel:</span> <span class="number">3.4</span><span class="string">/stable</span></span><br><span class="line">      <span class="attr">bind_to_all_interfaces:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">core:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">etcd:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">snapshot:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;4&#x27;</span></span><br><span class="line"><span class="attr">relations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">etcd:certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">easyrsa:client</span></span><br></pre></td></tr></table></figure>

<p>core.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">description:</span> <span class="string">Kubernetes</span> <span class="string">Cluster</span> <span class="string">Deploy.</span></span><br><span class="line"><span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line"><span class="attr">machines:</span></span><br><span class="line">  <span class="attr">&#x27;0&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;1&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;2&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;3&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;4&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;5&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;6&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;7&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line">  <span class="attr">&#x27;8&#x27;:</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line"><span class="attr">applications:</span></span><br><span class="line">  <span class="attr">containerd:</span></span><br><span class="line">    <span class="attr">charm:</span> <span class="string">cs:~containers/containerd-102</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">easyrsa:</span></span><br><span class="line">    <span class="attr">charm:</span> <span class="string">cs:~containers/easyrsa-345</span></span><br><span class="line">    <span class="attr">num_units:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">easyrsa:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="attr">charm:</span> <span class="string">cs:~containers/etcd-553</span></span><br><span class="line">    <span class="attr">num_units:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">channel:</span> <span class="number">3.4</span><span class="string">/stable</span></span><br><span class="line">      <span class="attr">bind_to_all_interfaces:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">core:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">etcd:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">snapshot:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;4&#x27;</span></span><br><span class="line">  <span class="attr">kubeapi-load-balancer:</span></span><br><span class="line">    <span class="attr">charm:</span> <span class="string">cs:~containers/kubeapi-load-balancer-757</span></span><br><span class="line">    <span class="attr">expose:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">num_units:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;5&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes-master:</span></span><br><span class="line">    <span class="attr">charm:</span> <span class="string">cs:~containers/kubernetes-master-955</span></span><br><span class="line">    <span class="attr">expose:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">num_units:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">channel:</span> <span class="number">1.20</span><span class="string">/stable</span></span><br><span class="line">      <span class="attr">service-cidr:</span> <span class="number">172.31</span><span class="number">.64</span><span class="number">.0</span><span class="string">/21</span></span><br><span class="line">      <span class="attr">enable-dashboard-addons:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">proxy-extra-args:</span> <span class="string">proxy-mode=ipvs</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">cdk-addons:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">core:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">kube-apiserver:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">kube-controller-manager:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">kube-proxy:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">kube-scheduler:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">kubectl:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;5&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;6&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;7&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes-worker:</span></span><br><span class="line">    <span class="attr">charm:</span> <span class="string">cs:~containers/kubernetes-worker-726</span></span><br><span class="line">    <span class="attr">expose:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">num_units:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">channel:</span> <span class="number">1.20</span><span class="string">/stable</span></span><br><span class="line">      <span class="attr">proxy-extra-args:</span> <span class="string">proxy-mode=ipvs</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">cni-amd64:</span> <span class="number">708</span></span><br><span class="line">      <span class="attr">cni-arm64:</span> <span class="number">699</span></span><br><span class="line">      <span class="attr">cni-s390x:</span> <span class="number">711</span></span><br><span class="line">      <span class="attr">core:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">kube-proxy:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">kubectl:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">kubelet:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;8&#x27;</span></span><br><span class="line">  <span class="attr">canal:</span></span><br><span class="line">    <span class="attr">charm:</span> <span class="string">&#x27;cs:~containers/canal-755&#x27;</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">cidr:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.0</span><span class="string">/18</span></span><br><span class="line">      <span class="attr">iface:</span> <span class="string">eth0</span></span><br><span class="line">      <span class="attr">ignore-loose-rpf:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">series:</span> <span class="string">focal</span></span><br><span class="line"><span class="attr">relations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">kubernetes-master:kube-api-endpoint</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubeapi-load-balancer:apiserver</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">kubernetes-master:loadbalancer</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubeapi-load-balancer:loadbalancer</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">kubernetes-worker:kube-api-endpoint</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubeapi-load-balancer:website</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">kubernetes-master:kube-control</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes-worker:kube-control</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">kubernetes-master:certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">easyrsa:client</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">kubeapi-load-balancer:certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">easyrsa:client</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">kubernetes-master:etcd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">etcd:db</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">kubernetes-worker:certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">easyrsa:client</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">etcd:certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">easyrsa:client</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">canal:etcd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">etcd:db</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">canal:cni</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes-master:cni</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">canal:cni</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes-worker:cni</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">containerd:containerd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes-worker:container-runtime</span></span><br><span class="line"><span class="bullet">-</span> <span class="bullet">-</span> <span class="string">containerd:containerd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubernetes-master:container-runtime</span></span><br></pre></td></tr></table></figure>

<h3 id="根据-yml-来部署"><a href="#根据-yml-来部署" class="headerlink" title="根据 yml 来部署"></a>根据 yml 来部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju deploy ./etcd.yaml --map-machines=existing,0=0,1=1,2=2,3=3,4=4</span><br><span class="line">juju deploy ./core.yaml --map-machines=existing,0=0,1=1,2=2,3=3,4=4,5=5,6=6,7=7,8=8</span><br></pre></td></tr></table></figure>

<p>juju status 全部 idle 就算正常了</p>
<h3 id="扩容-worker-节点"><a href="#扩容-worker-节点" class="headerlink" title="扩容 worker 节点"></a>扩容 worker 节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju add-machine ssh:root@x.x.x.x</span><br><span class="line">juju add-unit kubernetes-worker --to &lt;machine_id&gt;</span><br></pre></td></tr></table></figure>

<h2 id="kata-容器"><a href="#kata-容器" class="headerlink" title="kata 容器"></a>kata 容器</h2><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju deploy cs:~containers/kata</span><br><span class="line">juju add-relation kata kubernetes-master</span><br><span class="line">juju add-relation kata kubernetes-worker</span><br><span class="line">juju add-relation kata:untrusted containerd:untrusted</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>部署的时候加上 <code>io.kubernetes.cri.untrusted-workload: &quot;true&quot;</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-untrusted</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">io.kubernetes.cri.untrusted-workload:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="删除-kata-运行时"><a href="#删除-kata-运行时" class="headerlink" title="删除 kata 运行时"></a>删除 kata 运行时</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju remove-relation --force kata kubernetes-master</span><br><span class="line">juju remove-relation --force kata kubernetes-worker</span><br><span class="line">juju remove-relation --force kata:untrusted containerd:untrusted</span><br><span class="line">juju remove-application kata</span><br></pre></td></tr></table></figure>

<h2 id="更换-master-节点"><a href="#更换-master-节点" class="headerlink" title="更换 master 节点"></a>更换 master 节点</h2><h3 id="先删除节点"><a href="#先删除节点" class="headerlink" title="先删除节点"></a>先删除节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">juju remove-unit etcd/1 --force --no-wait</span><br><span class="line">juju remove-unit kubernetes-master/1 --force --no-wait</span><br><span class="line">juju remove-machine 1 --force --no-wait</span><br></pre></td></tr></table></figure>

<h3 id="etcd-集群删除这个-member"><a href="#etcd-集群删除这个-member" class="headerlink" title="etcd 集群删除这个 member"></a>etcd 集群删除这个 member</h3><blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://ubuntu.com/kubernetes/docs/charm-etcd">https://ubuntu.com/kubernetes/docs/charm-etcd</a></p>
</blockquote>
<p>需要先下载证书到本地 (要解压)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju run-action --<span class="built_in">wait</span> etcd/0 package-client-credentials</span><br><span class="line">juju scp etcd/0:etcd_credentials.tar.gz etcd_credentials.tar.gz</span><br></pre></td></tr></table></figure>

<p>然后使用 etcdctl 删除节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_KEY_FILE=$(<span class="built_in">pwd</span>)/client.key</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CERT_FILE=$(<span class="built_in">pwd</span>)/client.crt</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_CA_FILE=$(<span class="built_in">pwd</span>)/ca.crt</span><br><span class="line"><span class="built_in">export</span> ETCDCTL_ENDPOINT=https://10.0.0.21:2379</span><br><span class="line">etcdctl member list</span><br><span class="line"></span><br><span class="line">etcdctl member remove c2499df1988d1925</span><br></pre></td></tr></table></figure>

<h3 id="增加节点"><a href="#增加节点" class="headerlink" title="增加节点"></a>增加节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">juju add-machine ssh:root@100.64.1.167</span><br><span class="line">juju machines</span><br><span class="line">记住节点ID,假如是9</span><br></pre></td></tr></table></figure>

<h3 id="扩容-master-到节点-9"><a href="#扩容-master-到节点-9" class="headerlink" title="扩容 master 到节点 9"></a>扩容 master 到节点 9</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju add-unit kubernetes-master --to 9</span><br></pre></td></tr></table></figure>

<h3 id="扩容-etcd-到节点-9"><a href="#扩容-etcd-到节点-9" class="headerlink" title="扩容 etcd 到节点 9"></a>扩容 etcd 到节点 9</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju add-unit etcd --to 9</span><br></pre></td></tr></table></figure>

<h2 id="master-节点高可用"><a href="#master-节点高可用" class="headerlink" title="master 节点高可用"></a>master 节点高可用</h2><h3 id="方案-1-搭建-haproxy-负载均衡"><a href="#方案-1-搭建-haproxy-负载均衡" class="headerlink" title="方案 1 搭建 haproxy 负载均衡"></a>方案 1 搭建 haproxy 负载均衡</h3><blockquote>
<p>添加了参数 <code>proxy-extra-args: proxy-mode=ipvs</code> 表示使用 lvs 做负载均衡，可以不用 haproxy</p>
</blockquote>
<ol>
<li><p>haproxy 配置文件</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">...省略</span><br><span class="line"></span><br><span class="line">frontend http_ingress_traffic_fe</span><br><span class="line">    bind 0.0.0.0:80</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend   http_ingress_traffic_be</span><br><span class="line"></span><br><span class="line">backend http_ingress_traffic_be</span><br><span class="line">    mode tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      juju-worker-1 10.0.0.31:80 check</span><br><span class="line">    server      juju-worker-2 10.0.0.32:80 check</span><br><span class="line"></span><br><span class="line">frontend https_ingress_traffic_fe</span><br><span class="line">    bind 0.0.0.0:443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend   https_ingress_traffic_be</span><br><span class="line"></span><br><span class="line">backend https_ingress_traffic_be</span><br><span class="line">    mode tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      juju-worker-1 10.0.0.31:443 check</span><br><span class="line">    server      juju-worker-2 10.0.0.32:443 check</span><br><span class="line"></span><br><span class="line">frontend k8s_api_fe</span><br><span class="line">    bind 0.0.0.0:6443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend   k8s_api_be</span><br><span class="line"></span><br><span class="line">backend k8s_api_be</span><br><span class="line">    mode tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      juju-master-1 10.0.0.21:6443 check</span><br><span class="line">    server      juju-master-2 10.0.0.22:6443 check</span><br><span class="line">    server      juju-master-3 10.0.0.23:6443 check</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改负载均衡的 ip</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju config kubernetes-master loadbalancer-ips=<span class="string">&quot;10.0.0.10&quot;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="方案-2-使用-keepalived"><a href="#方案-2-使用-keepalived" class="headerlink" title="方案 2 使用 keepalived"></a>方案 2 使用 keepalived</h3><p>参考文章：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://ubuntu.com/kubernetes/docs/keepalived">https://ubuntu.com/kubernetes/docs/keepalived</a></p>
<h2 id="juju-controller-高可用"><a href="#juju-controller-高可用" class="headerlink" title="juju-controller 高可用"></a>juju-controller 高可用</h2><h3 id="增加新的-controller-节点"><a href="#增加新的-controller-节点" class="headerlink" title="增加新的 controller 节点"></a>增加新的 controller 节点</h3><p>首先切换到 controller</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju switch controller</span><br><span class="line"><span class="comment"># juju switch default 切换回来</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju add-machine ssh:root@100.64.1.169</span><br></pre></td></tr></table></figure>

<p>查看 controller 机器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju machines</span><br></pre></td></tr></table></figure>

<h3 id="开启高可用"><a href="#开启高可用" class="headerlink" title="开启高可用"></a>开启高可用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju enable-ha --to 5,6</span><br></pre></td></tr></table></figure>

<p>查看 controller 信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">juju controllers --refresh</span><br><span class="line">juju controllers</span><br></pre></td></tr></table></figure>

<h2 id="其他常见问题"><a href="#其他常见问题" class="headerlink" title="其他常见问题"></a>其他常见问题</h2><h3 id="安装-kubectl"><a href="#安装-kubectl" class="headerlink" title="安装 kubectl"></a>安装 kubectl</h3><ol>
<li><p>安装</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo snap install kubectl --classic</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取新的 kubeconfig 配置文件</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju scp kubernetes-master/0:config ~/.kube/config</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="操作-etcd"><a href="#操作-etcd" class="headerlink" title="操作 etcd"></a>操作 etcd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">juju run-action --<span class="built_in">wait</span> etcd/10 package-client-credentials</span><br><span class="line">juju scp etcd/25:etcd_credentials.tar.gz etcd_credentials.tar.gz</span><br><span class="line"></span><br><span class="line">etcdctl --cacert=$(<span class="built_in">pwd</span>)/ca.crt --cert=$(<span class="built_in">pwd</span>)/client.crt --key=$(<span class="built_in">pwd</span>)/client.key --endpoints=<span class="string">&quot;https://172.31.72.5:2379&quot;</span> member list</span><br></pre></td></tr></table></figure>

<h3 id="重新添加节点"><a href="#重新添加节点" class="headerlink" title="重新添加节点"></a>重新添加节点</h3><blockquote>
<p>比如已经添加过的机器，由于配置出错或者其他原因想重新添加进来初始化，可以先移除再添加。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">juju remove-machine &lt;machine-id&gt; --force</span><br></pre></td></tr></table></figure>

<p>在目标机器上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo /sbin/remove-juju-services</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /root/cdk /var/lib/juju/ /opt/calicoctl</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zahui.fan">张理坤</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zahui.fan/posts/efee88da/">https://zahui.fan/posts/efee88da/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zahui.fan" target="_blank">杂烩饭</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/">配置记录</a><a class="post-meta__tags" href="/tags/Ubuntu/">Ubuntu</a><a class="post-meta__tags" href="/tags/keepalived/">keepalived</a><a class="post-meta__tags" href="/tags/Container/">Container</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post-share"><div class="social-share" data-image="https://static.zahui.fan/public/Canonical%20Kubernetes.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/11e2a998/" title="搭建网关服务器"><img class="cover" src="https://static.zahui.fan/public/skeleton1.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">搭建网关服务器</div></div><div class="info-2"><div class="info-item-1">网关服务器的常见用途:1.企业局域网想要访问外网,可以使用网关服务器上网2.可以一个网卡连接公网,一个网卡连接局域网交换机,让网关服务器做路由器使用 Windows 平台外网适配器打开共享打开 控制面板\网络和 Internet\网络连接右键外网网卡, 属性, 共享   允许其他用户通过此计算机的 Internet 连接来连接   注意: 外网打开允许其他用户连接后,内网的 IP 地址会自动改变,这时候得手动修改一下内网适配器的 IP 地址.  内网机器设置 内网机器网关配置成 网关服务器 的内网 IP  注意:内网适配器的固定 IP 不要填写网关,否则会导致路由混乱. Liunx 服务端 (用 firewalld) 多网卡机器做网关做 nat 转发, 局域网其他机器需要配置网关地址.  开启内核转发 123sudo vim /etc/sysctl.conf---net.ipv4.ip_forward = 1  立即生效 1sudo sysctl -p  开启 NAT 转发 12firewall-cmd --permanent --zone=public...</div></div></div></a><a class="pagination-related" href="/posts/542f557/" title="Windows搜索工具everything"><img class="cover" src="https://static.zahui.fan/public/skeleton1.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Windows搜索工具everything</div></div><div class="info-2"><div class="info-item-1">无法弹出移动硬盘?设置👉🏻️索引👉🏻️NTFS 和 REFS取消勾选 自动包含新增固定卷 排除搜索结果设置👉🏻️索引👉🏻️排除列表👉🏻️添加筛选器 1234$RECYCLE.BIN*AppData\Roaming\Microsoft\Windows\Recent**Windows\Prefetch**AppData\Local\Packages\Microsoft.Windows.Search_*  直接修改配置文件需要将 everything 进程完全停止后才能进行修改，不然 everything 关闭的时候会覆盖手动修改的配置文件。  退出 everything  停止 everything 服务 1net stop everything  配置文件地址:%appdata%\Everything\Everything.ini...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/526ffc9a/" title="使用kubeadm部署一套高可用k8s集群 for Ubuntu"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">使用kubeadm部署一套高可用k8s集群 for Ubuntu</div></div><div class="info-2"><div class="info-item-1"> 基于 ubuntu 使用 kubeadm 搭建集群， centos部署文档, 有疑问的地方可以看 官方文档  准备机器 我的机器详情如下, 配置至少为 4C4G     hostname IP 作用    public 10.0.0.3 ingress、apiserver 负载均衡，nfs 存储   master1 10.0.0.11 k8s master 节点   master2 10.0.0.12 k8s master 节点   master3 10.0.0.13 k8s master 节点   worker1 10.0.0.21 k8s worker 节点   worker2 10.0.0.22 k8s worker 节点   每台机器都做域名解析，或者绑定 hosts(可选但建议) 123456vim /etc/hosts10.0.0.3  public kube-apiserver10.0.0.11 master110.0.0.12 master210.0.0.13 master3  基础环境配置 基础环境是不管 master 还是 worker...</div></div></div></a><a class="pagination-related" href="/posts/34d8fad0/" title="Kubeadm之单节点master升级高可用master"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Kubeadm之单节点master升级高可用master</div></div><div class="info-2"><div class="info-item-1">单节点升级 master 总体来说就是两步， 先修改 apiserver 地址为负载均衡地址，然后添加新的 master 节点。 搭建集群的时候我们注意一下就可以减少后期维护的烦恼，比如：  使用 hostname 而不是 ip 来作为 kube-apiserver 地址 单节点也把负载均衡安排上  假设已经有一个没有负载均衡的单节点 master，现在想将它切换为高可用集群，记录以下步骤： 部署负载均衡参考 Kubernetes之master高可用方案 更新证书 因为我们部署了负载均衡，所以需要通过负载均衡的地址来访问 apiserver，因为证书是针对域名或者 ip 做的签名，如果 ip 变了证书就失效了，这也是为什么建议使用 hostname 来代替 ip  如果你是用 kubeadm init 来创建的集群，那么你需要导出一个 kubeadm 配置 1kubectl -n kube-system get configmap kubeadm-config -o...</div></div></div></a><a class="pagination-related" href="/posts/67853ccb/" title="二进制部署Kuberntes"><img class="cover" src="https://static.zahui.fan/public/kubernetes.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-11-18</div><div class="info-item-2">二进制部署Kuberntes</div></div><div class="info-2"><div class="info-item-1">一些基本信息我这里以 AlmaLinux9 系统为例，类似 CentOS9 或 RHEL9 ，其他系统部分操作需要根据情况修改。    主机名称 IP 地址 说明 Kubernetes 组件 其他软件    master1 10.0.0.11 master 节点 kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy haproxy、keepalived、containerd   master2 10.0.0.12 master 节点 kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy haproxy、keepalived、containerd   master3 10.0.0.13 master...</div></div></div></a><a class="pagination-related" href="/posts/lq0y87n5/" title="使用kubeadm部署一套高可用k8s 1.29集群 for AlmaLinux9(RHEL9)"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-12-14</div><div class="info-item-2">使用kubeadm部署一套高可用k8s 1.29集群 for AlmaLinux9(RHEL9)</div></div><div class="info-2"><div class="info-item-1"> 基于 AlmaLinux9 使用 kubeadm 搭建集群， ubuntu部署文档, 有疑问的地方可以看 官方文档, 本教程需要能访问 国际互联网 。不能的话，需要解决镜像拉取问题、yum 安装组件的问题。  准备机器 我的机器详情如下, 配置至少为 4C4G     hostname IP 作用    master1 10.0.0.11 k8s master 节点   master2 10.0.0.12 k8s master 节点   master3 10.0.0.13 k8s master 节点   worker1 10.0.0.21 k8s worker 节点   worker2 10.0.0.22 k8s worker 节点   每台机器都做域名解析，或者绑定 hosts（直接使用 ip 地址会有警告） 123456vim /etc/hosts10.0.0.10  public kube-apiserver10.0.0.11 master110.0.0.12 master210.0.0.13 master3  每台机器都关闭防火墙和...</div></div></div></a><a class="pagination-related" href="/posts/b86d9e9f/" title="使用kubeadm部署一套高可用k8s集群 for CentOS"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">使用kubeadm部署一套高可用k8s集群 for CentOS</div></div><div class="info-2"><div class="info-item-1"> 基于 centos 使用 kubeadm 搭建集群， ubuntu部署文档, 有疑问的地方可以看 官方文档  准备机器 我的机器详情如下, 配置至少为 4C4G     hostname IP 作用    public 10.0.0.3 ingress 和 apiserver 的负载均衡，nfs 存储   master1 10.0.0.11 k8s master 节点   master2 10.0.0.12 k8s master 节点   master3 10.0.0.13 k8s master 节点   worker1 10.0.0.21 k8s worker 节点   worker2 10.0.0.22 k8s worker 节点   每台机器都做域名解析，或者绑定 hosts(可选但建议) 123456vim /etc/hosts10.0.0.3  public kube-apiserver10.0.0.11 master110.0.0.12 master210.0.0.13 master3  每台机器都关闭防火墙和 SELinux  负载均衡机器必须要关闭,因为...</div></div></div></a><a class="pagination-related" href="/posts/6f59afe4/" title="使用kubeasz搭建一套高可用的Kubernetes集群"><img class="cover" src="https://static.zahui.fan/public/kubeasz.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">使用kubeasz搭建一套高可用的Kubernetes集群</div></div><div class="info-2"><div class="info-item-1">kubeasz 是基于 ansible 和 shell 制作的工具，可以快速搭建一个高可用的 k8s 集群（二进制部署），不需要额外的负载均衡。项目地址：https://github.com/easzlab/kubeasz, kubeasz 每个版本对应了支持的 k8s 版本, 可以到项目主页查看, 这里使用 kubeasz 版本 3.6.3, 部署 k8s 1.29.0  另见 kubeadm 部署在centos使用kubeadm部署k8s在ubuntu使用kubeadm部署k8s  安装准备准备机器如下：    机器 IP    kubeasz 操作机 10.0.0.7   master1 10.0.0.31   master2 10.0.0.32   master3 10.0.0.33   worker1 10.0.0.41   首先确保操作机可以通过 ssh 连接到其他所有机器，最好密钥打通（这是使用 ansible 的必要条件） 安装 kubeasz下载 ezdown 部署工具123export release=3.6.3                     #...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://static.zahui.fan/public/dog.svg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">张理坤</div><div class="author-info-description">张理坤的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">354</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">218</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/iuxt"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/iuxt" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:x@zahui.fan" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/165330963" rel="external nofollow noreferrer" target="_blank" title="Bilibili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="https://stackoverflow.com/users/15620461/" rel="external nofollow noreferrer" target="_blank" title="StackOverflow"><i class="fa-brands fa-stack-overflow"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-square-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">此博客为我记录运维工作总结所用，供网友阅读参考，如有侵权，请通知我，我会核实后进行处理。</br>
<strong style="color: red;">欢迎加入技术交流群：</strong>
<div class="aside-qrcode" >
<img src="https://src.babudiu.com/card/wechat_ops_group.JPG" title="微信群" width="100%" height="auto">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D"><span class="toc-number">1.</span> <span class="toc-text">开始之前</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-juju"><span class="toc-number">1.1.</span> <span class="toc-text">安装 juju</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E4%BA%91%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">设置云类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%9C%BA%E5%99%A8-%E4%B8%80%E5%85%B1-5-%E5%8F%B0"><span class="toc-number">1.3.</span> <span class="toc-text">添加机器 (一共 5 台)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90-yaml"><span class="toc-number">1.4.</span> <span class="toc-text">生成 yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE-yml-%E6%9D%A5%E9%83%A8%E7%BD%B2"><span class="toc-number">1.5.</span> <span class="toc-text">根据 yml 来部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9-worker-%E8%8A%82%E7%82%B9"><span class="toc-number">1.6.</span> <span class="toc-text">扩容 worker 节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kata-%E5%AE%B9%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">kata 容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">2.1.</span> <span class="toc-text">部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4-kata-%E8%BF%90%E8%A1%8C%E6%97%B6"><span class="toc-number">2.3.</span> <span class="toc-text">删除 kata 运行时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%8D%A2-master-%E8%8A%82%E7%82%B9"><span class="toc-number">3.</span> <span class="toc-text">更换 master 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%88%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9"><span class="toc-number">3.1.</span> <span class="toc-text">先删除节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etcd-%E9%9B%86%E7%BE%A4%E5%88%A0%E9%99%A4%E8%BF%99%E4%B8%AA-member"><span class="toc-number">3.2.</span> <span class="toc-text">etcd 集群删除这个 member</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E8%8A%82%E7%82%B9"><span class="toc-number">3.3.</span> <span class="toc-text">增加节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9-master-%E5%88%B0%E8%8A%82%E7%82%B9-9"><span class="toc-number">3.4.</span> <span class="toc-text">扩容 master 到节点 9</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9-etcd-%E5%88%B0%E8%8A%82%E7%82%B9-9"><span class="toc-number">3.5.</span> <span class="toc-text">扩容 etcd 到节点 9</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#master-%E8%8A%82%E7%82%B9%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">master 节点高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88-1-%E6%90%AD%E5%BB%BA-haproxy-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">4.1.</span> <span class="toc-text">方案 1 搭建 haproxy 负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88-2-%E4%BD%BF%E7%94%A8-keepalived"><span class="toc-number">4.2.</span> <span class="toc-text">方案 2 使用 keepalived</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#juju-controller-%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">juju-controller 高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E6%96%B0%E7%9A%84-controller-%E8%8A%82%E7%82%B9"><span class="toc-number">5.1.</span> <span class="toc-text">增加新的 controller 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">开启高可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">6.</span> <span class="toc-text">其他常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-kubectl"><span class="toc-number">6.1.</span> <span class="toc-text">安装 kubectl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C-etcd"><span class="toc-number">6.2.</span> <span class="toc-text">操作 etcd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9"><span class="toc-number">6.3.</span> <span class="toc-text">重新添加节点</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/suwpme/" title="使用selenium来实现Grafana的自动截图"><img src="https://static.zahui.fan/public/skeleton1.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用selenium来实现Grafana的自动截图"/></a><div class="content"><a class="title" href="/posts/suwpme/" title="使用selenium来实现Grafana的自动截图">使用selenium来实现Grafana的自动截图</a><time datetime="2025-04-22T07:37:20.000Z" title="更新于 2025-04-22 15:37:20">2025-04-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/shqeci/" title="trzsz 使用记录"><img src="https://static.zahui.fan/images/202411221801168.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="trzsz 使用记录"/></a><div class="content"><a class="title" href="/posts/shqeci/" title="trzsz 使用记录">trzsz 使用记录</a><time datetime="2025-04-18T07:09:10.000Z" title="更新于 2025-04-18 15:09:10">2025-04-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/lrr6ze9h/" title="macOS常用操作记录"><img src="https://static.zahui.fan/public/macos.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="macOS常用操作记录"/></a><div class="content"><a class="title" href="/posts/lrr6ze9h/" title="macOS常用操作记录">macOS常用操作记录</a><time datetime="2025-04-18T07:08:02.000Z" title="更新于 2025-04-18 15:08:02">2025-04-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/suuwju/" title="Filebeat直接输出到Elasticsearch"><img src="https://static.zahui.fan/public/skeleton1.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Filebeat直接输出到Elasticsearch"/></a><div class="content"><a class="title" href="/posts/suuwju/" title="Filebeat直接输出到Elasticsearch">Filebeat直接输出到Elasticsearch</a><time datetime="2025-04-17T10:41:23.000Z" title="更新于 2025-04-17 18:41:23">2025-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/11255f25/" title="Prometheus常用PromQL记录"><img src="https://static.zahui.fan/public/Prometheus.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Prometheus常用PromQL记录"/></a><div class="content"><a class="title" href="/posts/11255f25/" title="Prometheus常用PromQL记录">Prometheus常用PromQL记录</a><time datetime="2025-04-16T08:42:07.000Z" title="更新于 2025-04-16 16:42:07">2025-04-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href='https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral'>
  本网站由<img src='https://static.zahui.fan/public/upyun.svg' alt='又拍云' width='70' height='28' style="vertical-align:bottom">
  提供CDN加速/云存储服务
</a>
</br>
<a href="https://beian.miit.gov.cn/" rel="external nofollow noreferrer" target="_blank">沪ICP备2021015230号-1</a>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.babudiu.com/client.js',
      'data-repo': 'iuxt/iuxt.github.io',
      'data-repo-id': 'R_kgDOMszkdA',
      'data-category-id': 'DIC_kwDOMszkdM4CiMyw',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.babudiu.com')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜搜搜" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>