<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Prometheus开启basic_auth认证 | 杂烩饭</title><meta name="author" content="张理坤"><meta name="copyright" content="张理坤"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="考虑将公司的联邦集群（pull）换成 remote_write（push）这种形式， 所以需要将 Prometheus 开放到公网，看了看认证相关的配置 也可以使用 Nginx 来反向代理，可以参考 Nginx开启基本http认证， 不过 Prometheus 原生带了 basic auth 和 ssl 认证, 官网的说明https:&#x2F;&#x2F;prometheus.io&#x2F;docs&#x2F;guides&#x2F;basi">
<meta property="og:type" content="article">
<meta property="og:title" content="Prometheus开启basic_auth认证">
<meta property="og:url" content="https://zahui.fan/posts/165a0cd3/">
<meta property="og:site_name" content="杂烩饭">
<meta property="og:description" content="考虑将公司的联邦集群（pull）换成 remote_write（push）这种形式， 所以需要将 Prometheus 开放到公网，看了看认证相关的配置 也可以使用 Nginx 来反向代理，可以参考 Nginx开启基本http认证， 不过 Prometheus 原生带了 basic auth 和 ssl 认证, 官网的说明https:&#x2F;&#x2F;prometheus.io&#x2F;docs&#x2F;guides&#x2F;basi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static.zahui.fan/public/Prometheus.svg">
<meta property="article:published_time" content="2022-06-09T09:19:43.000Z">
<meta property="article:modified_time" content="2024-10-31T03:20:09.000Z">
<meta property="article:author" content="张理坤">
<meta property="article:tag" content="Auth">
<meta property="article:tag" content="prometheus">
<meta property="article:tag" content="Prometheus">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static.zahui.fan/public/Prometheus.svg"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://zahui.fan/posts/165a0cd3/"><link rel="preconnect"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/site.webmanifest"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?50b516d50102c8c9ac5f80529b81ca17";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-YN0WWZGVYN"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-YN0WWZGVYN')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-YN0WWZGVYN', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"此文章距离发布已经","messageNext":"天了，内容可能已经过时，请自行判断是否可用或联系博主更新。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Prometheus开启basic_auth认证',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-31 11:20:09'
}</script><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="杂烩饭" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="杂烩饭" type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://static.zahui.fan/public/dog.svg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">331</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">212</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://static.zahui.fan/public/Prometheus.svg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://static.zahui.fan/public/boob.png" alt="Logo"><span class="site-name">杂烩饭</span></a><a class="nav-page-title" href="/"><span class="site-name">Prometheus开启basic_auth认证</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Prometheus开启basic_auth认证</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-09T09:19:43.000Z" title="发表于 2022-06-09 17:19:43">2022-06-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-31T03:20:09.000Z" title="更新于 2024-10-31 11:20:09">2024-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%9B%91%E6%8E%A7/">监控</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>考虑将公司的联邦集群（pull）换成 remote_write（push）这种形式， 所以需要将 Prometheus 开放到公网，看了看认证相关的配置</p>
<p>也可以使用 Nginx 来反向代理，可以参考 <a href="/posts/5855bc56">Nginx开启基本http认证</a>， 不过 Prometheus 原生带了 basic auth 和 ssl 认证, 官网的说明<a target="_blank" rel="noopener external nofollow noreferrer" href="https://prometheus.io/docs/guides/basic-auth/">https://prometheus.io/docs/guides/basic-auth/</a></p>
<h2 id="开启-web-配置文件"><a href="#开启-web-配置文件" class="headerlink" title="开启 web 配置文件"></a>开启 web 配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./prometheus --web.config.file=<span class="string">&quot;web.yml&quot;</span>  --web.listen-address=<span class="string">&quot;0.0.0.0:9001&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="生成密码"><a href="#生成密码" class="headerlink" title="生成密码"></a>生成密码</h2><p>密码需要 bcrypt 加密，这里使用 <code>htpasswd</code> 工具生成</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">Ubuntu和Debian安装</button><button type="button" class="tab">CentOS和Fedora安装</button></div><div class="tab-contents"><div class="tab-item-content active"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install apache2-utils</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd-tools</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -nB <span class="string">&#x27;admin&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="web-配置文件"><a href="#web-配置文件" class="headerlink" title="web 配置文件"></a>web 配置文件</h2><p>vim web.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">basic_auth_users:</span></span><br><span class="line">  <span class="attr">admin:</span> <span class="string">$2y$05$UKSS18ztdsUNoEuXYScr2OE1TCMe1hWnmD6JuwUi/uPTJayHIakae</span></span><br></pre></td></tr></table></figure>

<h3 id="验证一下配置"><a href="#验证一下配置" class="headerlink" title="验证一下配置"></a>验证一下配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">promtool check web-config web.yml</span><br></pre></td></tr></table></figure>

<h2 id="remote-write-访问"><a href="#remote-write-访问" class="headerlink" title="remote write 访问"></a>remote write 访问</h2><p>后面访问控制台页面或者调用接口都需要指定账号密码了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -u admin:xxxxx http://localhost:9090</span><br></pre></td></tr></table></figure>

<p>其他 Prometheus 如果需要往这台写入， 需要在其他的 Prometheus remote_write 配置认证</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">remote_write:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&quot;http://127.0.0.1:9090/api/v1/write&quot;</span></span><br><span class="line">  <span class="attr">basic_auth:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xxxxx</span></span><br><span class="line">  <span class="attr">remote_timeout:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">queue_config:</span></span><br><span class="line">    <span class="attr">capacity:</span> <span class="number">500</span></span><br><span class="line">    <span class="attr">max_shards:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">min_shards:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">max_samples_per_send:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">batch_send_deadline:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">min_backoff:</span> <span class="string">30ms</span></span><br><span class="line">    <span class="attr">max_backoff:</span> <span class="string">100ms</span></span><br></pre></td></tr></table></figure>

<h2 id="联邦配置"><a href="#联邦配置" class="headerlink" title="联邦配置"></a>联邦配置</h2><p>如果此 Prometheus 需要通过联邦机制接入到其他 Prometheus， 需要在对方的配置里面增加：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;federate-http&#x27;</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">&#x27;/federate&#x27;</span></span><br><span class="line">  <span class="attr">basic_auth:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&#x27;xxxxx&#x27;</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="string">&#x27;match[]&#x27;</span><span class="string">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#123;job=~&quot;.+&quot;&#125;&#x27;</span></span><br><span class="line">  <span class="attr">file_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/data/prometheus/conf.d/federate_http.yml</span></span><br><span class="line">      <span class="attr">refresh_interval:</span> <span class="string">30s</span></span><br></pre></td></tr></table></figure>

<h2 id="启用了-Basic-Auth-怎么健康检查"><a href="#启用了-Basic-Auth-怎么健康检查" class="headerlink" title="启用了 Basic Auth 怎么健康检查"></a>启用了 Basic Auth 怎么健康检查</h2><p>在 Kubernetes 环境下，配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成base64的账号密码编码</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;user:pass&quot;</span> |<span class="built_in">base64</span> -w0</span><br></pre></td></tr></table></figure>

<p>在 Liveness 和 Readness 配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">httpGet:</span> </span><br><span class="line">  <span class="attr">httpHeaders:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Authorization</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">Basic</span> <span class="string">dXNlcjpwYXNz</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zahui.fan">张理坤</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zahui.fan/posts/165a0cd3/">https://zahui.fan/posts/165a0cd3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zahui.fan" target="_blank">杂烩饭</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Auth/">Auth</a><a class="post-meta__tags" href="/tags/prometheus/">prometheus</a><a class="post-meta__tags" href="/tags/Prometheus/">Prometheus</a></div><div class="post-share"><div class="social-share" data-image="https://static.zahui.fan/public/Prometheus.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/666e547f/" title="Prometheus通过remote_write写入数据到另一台Prometheus"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Prometheus通过remote_write写入数据到另一台Prometheus</div></div><div class="info-2"><div class="info-item-1">假设 Prometheus1 是一个集群内的 Prometheus，需要远程写入数据到 Prometheus_Core Prometheus_Core 开启 remote_write_receiverPrometheus_Core 需要打开接收远程写入的功能，通过增加启动参数 --web.enable-remote-write-receiver： 1./prometheus --web.enable-remote-write-receiver --web.config.file=web.yml --web.listen-address=0.0.0.0:9090   远程写的接口地址 /api/v1/write  Prometheus_Core 开启认证参考 Prometheus开启basic_auth认证 Prometheus1 配置 remote_writePrometheus1 需要将 remote_write 写入到 Prometheus_Core 的远程接口 12345678910111213141516remote_write:- url:...</div></div></div></a><a class="pagination-related" href="/posts/c86b58e3/" title="Ingress Nginx 的灰度方案"><img class="cover" src="https://static.zahui.fan/public/Nginx.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Ingress Nginx 的灰度方案</div></div><div class="info-2"><div class="info-item-1">在 k8s 环境下进行灰度，ingress-nginx 自带了灰度注解， 这篇文章挺详细的https://v2-1.docs.kubesphere.io/docs/zh-CN/quick-start/ingress-canary/ 再此之前有个需求， 根据请求 header 有没有特定的值，来判断是否进入灰度环境。当时的做法是在集群内用 nginx 12345# 如果有个header叫grayif ($http_gray = &quot;true&quot;) &#123;    proxy_pass http://nginx.test1:80;    break;&#125;  这种方式可以实现需求， 不过不灵活， 也不优雅， 搜了一下， 发现 ingress nginx 原生提供了灰度的方案 ingress 自带 canary 部署简单来说就是部署了两套环境， 这两套一模一样， 只是在不同的 namespace（同一个 namespace 需要取不同的名字），service 和 ingress 域名都配置成一样的， 然后在 canary 环境的 ingress...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/61baae6f/" title="Kubernetes中使用Prometheus对集群节点做监控"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Kubernetes中使用Prometheus对集群节点做监控</div></div><div class="info-2"><div class="info-item-1">正常情况下使用 Prometheus 对机器做监控，比如监控 CPU、内存、磁盘等信息， 都是在机器上安装一个 node exporter， 然后将 metrics 接入到 Prometheus 中。在 k8s 环境下， 我们可以使用 k8s 来管理， 实现自动化监控。 node exporter 是针对主机节点的， 需要在每台 node 节点上安装， 那么 daemonset 控制器是最合理的选择。 网络使用 Host Network 模式， 在主机上直接暴露一个端口。 部署 node exporter使用 yaml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263apiVersion: apps/v1kind: DaemonSetmetadata:  name: node-exporter  namespace: monitor  labels:    name:...</div></div></div></a><a class="pagination-related" href="/posts/11255f25/" title="Prometheus常用PromSQL记录"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Prometheus常用PromSQL记录</div></div><div class="info-2"><div class="info-item-1">prometheus 查询语法叫 promsql，做个记录： 查询条件Prometheus 存储的是时序数据，而它的时序是由名字和一组标签构成的，其实名字也可以写出标签的形式，例如 http_requests_total 等价于 &#123;name=&quot;http_requests_total&quot;&#125;。 一个简单的查询相当于是对各种标签的筛选，例如： 1234http_requests_total&#123;code=&quot;200&quot;&#125;     # 表示查询名字为 http_requests_total，code 为 &quot;200&quot; 的数据http_requests_total&#123;code!=&quot;200&quot;&#125;    # 表示查询 code 不为 &quot;200&quot; 的数据http_requests_total&#123;code=~&quot;2..&quot;&#125;    # 表示查询 code 为 &quot;2xx&quot;...</div></div></div></a><a class="pagination-related" href="/posts/ac395656/" title="Prometheus手动打标签"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Prometheus手动打标签</div></div><div class="info-2"><div class="info-item-1">有时候需要给 Prometheus 打标签，比如说联邦集群接入，需要知道是哪个集群，remote write 写入的时候也需要做个标记。 直接在集群打标签vim prometheus.yml 12345678910global:  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.  # scrape_timeout is set to the global default (10s).  external_labels:    env: uat    dept: ops    project: xxx...  这样就可以给集群内的所有 metrics...</div></div></div></a><a class="pagination-related" href="/posts/prometheus_tag/" title="Prometheus标签处理"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Prometheus标签处理</div></div><div class="info-2"><div class="info-item-1">元标签在被监控端纳入普罗米修斯里面定义了一些元数据标签在 Prometheus 所有的 Target 实例中，都包含一些默认的 Metadata 标签信息。可以通过 Prometheus UI 的 Status 里面的 Service Discovery 查看    Metadata 标签 说明    address 当前 Target 实例的访问地址 host:port   scheme 采集目标服务访问地址的 HTTP Scheme，HTTP 或者 HTTPS   metrics_path 采集目标服务访问地址的访问路径   上面这些标签将会告诉 Prometheus 如何从该 Target 实例中获取监控数据。除了这些默认的标签以外，我们还可以为 Target 添加自定义的标签。 元标签是不会写到数据库当中的，使用 promql 是查询不到这些标签的，如果需要源标签的数据（比如 k8s 部署的 Prometheus 使用自动发现获取 pod 监控），这个时候就需要把一些元标签重新打标签来使用。  比如上图，监控 k8s 的 pod 状态， 因为 pod 是动态的，所以需要...</div></div></div></a><a class="pagination-related" href="/posts/666e547f/" title="Prometheus通过remote_write写入数据到另一台Prometheus"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Prometheus通过remote_write写入数据到另一台Prometheus</div></div><div class="info-2"><div class="info-item-1">假设 Prometheus1 是一个集群内的 Prometheus，需要远程写入数据到 Prometheus_Core Prometheus_Core 开启 remote_write_receiverPrometheus_Core 需要打开接收远程写入的功能，通过增加启动参数 --web.enable-remote-write-receiver： 1./prometheus --web.enable-remote-write-receiver --web.config.file=web.yml --web.listen-address=0.0.0.0:9090   远程写的接口地址 /api/v1/write  Prometheus_Core 开启认证参考 Prometheus开启basic_auth认证 Prometheus1 配置 remote_writePrometheus1 需要将 remote_write 写入到 Prometheus_Core 的远程接口 12345678910111213141516remote_write:- url:...</div></div></div></a><a class="pagination-related" href="/posts/5855bc56/" title="Nginx开启基本http认证"><img class="cover" src="https://static.zahui.fan/public/Nginx.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Nginx开启基本http认证</div></div><div class="info-2"><div class="info-item-1"> Nginx 使用 ngx_http_auth_basic_module 模块支持 HTTP 基本身份验证功能  nginx 配置比如需要&#x2F;api 路径下的资源需要认证 1234location ^~ /api &#123;    auth_basic &quot;authentication&quot;;    auth_basic_user_file conf.d/.htpasswd;&#125;  配置密码文件.htpasswd两种方法二选一 使用 htpasswd 生成12345# Ubuntu or Debianapt install apache2-utils# Rhel or CentOS:yum install httpd-tools  生成密码, 密码文件为 .htpasswd 1htpasswd -bcd .htpasswd username password  使用 openssl 生成 echo -n xxx 不打印换行符  123echo  -n &#x27;username:&#x27; &gt;&gt; .htpasswdopenssl...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://static.zahui.fan/public/dog.svg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">张理坤</div><div class="author-info-description">张理坤的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">331</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">212</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/iuxt"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/iuxt" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:x@zahui.fan" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/165330963" rel="external nofollow noreferrer" target="_blank" title="Bilibili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="https://stackoverflow.com/users/15620461/" rel="external nofollow noreferrer" target="_blank" title="StackOverflow"><i class="fa-brands fa-stack-overflow"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-square-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">此博客为我记录运维工作总结所用，供网友阅读参考，如有侵权，请通知我，我会核实后进行处理。</br>
<strong style="color: red;">欢迎加入技术交流群：</strong>
<div class="aside-qrcode" >
<img src="https://src.babudiu.com/card/wechat_ops_group.JPG" title="微信群" width="100%" height="auto">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-web-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">开启 web 配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%AF%86%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">生成密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">web 配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E4%B8%80%E4%B8%8B%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">验证一下配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#remote-write-%E8%AE%BF%E9%97%AE"><span class="toc-number">4.</span> <span class="toc-text">remote write 访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%94%E9%82%A6%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">联邦配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E4%BA%86-Basic-Auth-%E6%80%8E%E4%B9%88%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">6.</span> <span class="toc-text">启用了 Basic Auth 怎么健康检查</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/097e5b7c/" title="制作和使用自签名证书"><img src="https://static.zahui.fan/images/202411211426166.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="制作和使用自签名证书"/></a><div class="content"><a class="title" href="/posts/097e5b7c/" title="制作和使用自签名证书">制作和使用自签名证书</a><time datetime="2024-12-11T03:24:30.000Z" title="更新于 2024-12-11 11:24:30">2024-12-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/lnd7yqpw/" title="自动清理日志脚本"><img src="https://static.zahui.fan/public/bash.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="自动清理日志脚本"/></a><div class="content"><a class="title" href="/posts/lnd7yqpw/" title="自动清理日志脚本">自动清理日志脚本</a><time datetime="2024-12-10T09:56:56.000Z" title="更新于 2024-12-10 17:56:56">2024-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/so9bdi/" title="Grafana表格绘制"><img src="https://static.zahui.fan/public/Grafana.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Grafana表格绘制"/></a><div class="content"><a class="title" href="/posts/so9bdi/" title="Grafana表格绘制">Grafana表格绘制</a><time datetime="2024-12-10T03:06:06.000Z" title="更新于 2024-12-10 11:06:06">2024-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/lmeiruso/" title="WSL2 - Ubuntu配置记录"><img src="https://static.zahui.fan/public/wsl.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WSL2 - Ubuntu配置记录"/></a><div class="content"><a class="title" href="/posts/lmeiruso/" title="WSL2 - Ubuntu配置记录">WSL2 - Ubuntu配置记录</a><time datetime="2024-12-09T07:22:13.000Z" title="更新于 2024-12-09 15:22:13">2024-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/so24vr/" title="Windows中的符号连接"><img src="https://static.zahui.fan/public/skeleton1.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows中的符号连接"/></a><div class="content"><a class="title" href="/posts/so24vr/" title="Windows中的符号连接">Windows中的符号连接</a><time datetime="2024-12-06T05:53:27.000Z" title="更新于 2024-12-06 13:53:27">2024-12-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href='https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral'>
  本网站由<img src='https://static.zahui.fan/public/upyun.svg' alt='又拍云' width='70' height='28' style="vertical-align:bottom">
  提供CDN加速/云存储服务
</a>
</br>
<a href="https://beian.miit.gov.cn/" rel="external nofollow noreferrer" target="_blank">沪ICP备2021015230号-1</a>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.babudiu.com/client.js',
      'data-repo': 'iuxt/iuxt.github.io',
      'data-repo-id': 'R_kgDOMszkdA',
      'data-category-id': 'DIC_kwDOMszkdM4CiMyw',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },null)

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.babudiu.com')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜搜搜" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>