<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>使用Keepalived来实现Nginx高可用 | 杂烩饭</title><meta name="author" content="张理坤"><meta name="copyright" content="张理坤"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="公有云不会考虑这些，不过自建机房，使用 nginx 做入口，keepalived 是唯一的选择。    节点 IP    keepalived 主 10.0.0.45   keepalived 备 10.0.0.44   vip 10.0.0.46   组播模式keepalived1keepalived212345678910111213141516171819202122232425262728">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Keepalived来实现Nginx高可用">
<meta property="og:url" content="https://zahui.fan/posts/0cebb8ae/">
<meta property="og:site_name" content="杂烩饭">
<meta property="og:description" content="公有云不会考虑这些，不过自建机房，使用 nginx 做入口，keepalived 是唯一的选择。    节点 IP    keepalived 主 10.0.0.45   keepalived 备 10.0.0.44   vip 10.0.0.46   组播模式keepalived1keepalived212345678910111213141516171819202122232425262728">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static.zahui.fan/public/Nginx.svg">
<meta property="article:published_time" content="2022-06-15T09:33:51.000Z">
<meta property="article:modified_time" content="2024-10-31T03:20:09.000Z">
<meta property="article:author" content="张理坤">
<meta property="article:tag" content="配置记录">
<meta property="article:tag" content="keepalived">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="HA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static.zahui.fan/public/Nginx.svg"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://zahui.fan/posts/0cebb8ae/"><link rel="preconnect"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/site.webmanifest"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?50b516d50102c8c9ac5f80529b81ca17";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-YN0WWZGVYN"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-YN0WWZGVYN')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-YN0WWZGVYN', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"此文章距离发布已经","messageNext":"天了，内容可能已经过时，请自行判断是否可用或联系博主更新。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '使用Keepalived来实现Nginx高可用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-31 11:20:09'
}</script><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="杂烩饭" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://static.zahui.fan/public/dog.svg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">346</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">215</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://static.zahui.fan/public/Nginx.svg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://static.zahui.fan/public/boob.png" alt="Logo"><span class="site-name">杂烩饭</span></a><a class="nav-page-title" href="/"><span class="site-name">使用Keepalived来实现Nginx高可用</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">使用Keepalived来实现Nginx高可用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-15T09:33:51.000Z" title="发表于 2022-06-15 17:33:51">2022-06-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-31T03:20:09.000Z" title="更新于 2024-10-31 11:20:09">2024-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/">基础运维</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>公有云不会考虑这些，不过自建机房，使用 nginx 做入口，keepalived 是唯一的选择。</p>
<table>
<thead>
<tr>
<th>节点</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>keepalived 主</td>
<td>10.0.0.45</td>
</tr>
<tr>
<td>keepalived 备</td>
<td>10.0.0.44</td>
</tr>
<tr>
<td>vip</td>
<td>10.0.0.46</td>
</tr>
</tbody></table>
<h2 id="组播模式"><a href="#组播模式" class="headerlink" title="组播模式"></a>组播模式</h2><div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">keepalived1</button><button type="button" class="tab">keepalived2</button></div><div class="tab-contents"><div class="tab-item-content active"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    script_user root            # 脚本执行者</span><br><span class="line">    enable_script_security      # 标记脚本安全</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_script &#123;</span><br><span class="line">    script &quot;killall -0 nginx&quot;          # 脚本路径, 返回值为0则正常，不为0认为不正常</span><br><span class="line">    # 可替代的命令:</span><br><span class="line">    # /usr/sbin/pidof nginx             这个命令不推荐, 多个进程pid会出问题</span><br><span class="line">    # pgrep nginx                       类似于pidof nginx 返回的是pid</span><br><span class="line">    interval 2                              # 脚本执行间隔，单位s</span><br><span class="line">    weight -20                              # -254-254之间，检测失败权重减少</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;                        # 实例名</span><br><span class="line">    state MASTER                            # 当前keepalived状态</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251                   # 组播ID主备需一致，单播无所谓</span><br><span class="line">    priority 100                            # 默认权重</span><br><span class="line">    advert_int 1                            # 发送VRRP通告间隔，单位s</span><br><span class="line">    # nopreempt                             # 设置非抢占模式，原本高优先级的MASER恢复之后，不会去抢现在是低优先级BACKUP, 这项配置只有在两台都配置为state backup才有用。</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS                      # 主备验证信息，需一致</span><br><span class="line">        auth_pass 123456 </span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_script                        # 调用脚本,若脚本最后的执行结果是非0的，则判断端口down掉，此时vip会漂移到keepalived-BACKUP上</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.46                       # vip</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_script &#123;</span><br><span class="line">    script &quot;killall -0 nginx&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_script</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.46</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="单播模式"><a href="#单播模式" class="headerlink" title="单播模式"></a>单播模式</h2><div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">keepalived1</button><button type="button" class="tab">keepalived2</button></div><div class="tab-contents"><div class="tab-item-content active"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    script_user root            # 脚本执行者</span><br><span class="line">    enable_script_security      # 标记脚本安全</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_script &#123;</span><br><span class="line">    script &quot;killall -0 nginx&quot;          # 脚本路径, 返回值为0则正常，不为0认为不正常</span><br><span class="line">    interval 2                              # 脚本执行间隔，单位s</span><br><span class="line">    weight -20                              # -254-254之间，检测失败权重减少, 要大于集群  最大 priority - 最小 priority</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;                        # 实例名</span><br><span class="line">    state MASTER                            # 当前keepalived状态</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251                   # 组播ID主备需一致，单播无所谓</span><br><span class="line">    priority 100                            # 默认权重</span><br><span class="line">    advert_int 1                            # 发送VRRP通告间隔，单位s</span><br><span class="line">    # nopreempt                             # 设置非抢占模式，原本高优先级的MASER恢复之后，不会去抢现在是低优先级BACKUP, 这项配置只有在两台都配置为state backup才有用。</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS                      # 主备验证信息，需一致</span><br><span class="line">        auth_pass 123456 </span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_script                        # 调用脚本,若脚本最后的执行结果是非0的，则判断端口down掉，此时vip会漂移到keepalived-BACKUP上</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.45            # 配置源地址的IP地址</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">       10.0.0.44                         # 配置从节点的目标IP地址</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.46                       # vip</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_script &#123;</span><br><span class="line">    script &quot;killall -0 nginx&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_script</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.44</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">       10.0.0.45</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.46</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="非抢占式说明"><a href="#非抢占式说明" class="headerlink" title="非抢占式说明"></a>非抢占式说明</h2><blockquote>
<p>抢占式 和 非抢占式的区别： 比如 master1 默认的权重（priority）高，vip 当前在 master1 上， master1 挂掉后 vip 会飘到 master2 上，那么如果 master1 恢复正常了，抢占式会重新将 vip 抢过来，再次绑定到 master1 上，非抢占式则保持在 master2 上，除非 master2 也出问题。</p>
</blockquote>
<ul>
<li>必须都为 BACKUP 模式，如果有 MASTER，那么 MASTER 会抢占</li>
<li>必须都配置 nopreempt</li>
<li>去掉 weight -20 配置， 因为非抢占式这种配置， 高优先级的不会去抢占低优先级的 VIP， 所以检测失败降低权重是没有效果的。</li>
<li>配置 <code>rise 1</code> 和 <code>fall 1</code> 含义是检测失败状态变成 fault</li>
</ul>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">keepalived1</button><button type="button" class="tab">keepalived2</button><button type="button" class="tab">keepalived3</button></div><div class="tab-contents"><div class="tab-item-content active"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check &#123;</span><br><span class="line">    script &quot;pgrep nginx&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    rise 1</span><br><span class="line">    fall 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state  BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.11</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">       10.0.0.12</span><br><span class="line">       10.0.0.13</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10 dev eth0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check &#123;</span><br><span class="line">    script &quot;pgrep nginx&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    rise 1</span><br><span class="line">    fall 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state  BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 99</span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.12</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">       10.0.0.11</span><br><span class="line">       10.0.0.13</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10 dev eth0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check &#123;</span><br><span class="line">    script &quot;pgrep nginx&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    rise 1</span><br><span class="line">    fall 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state  BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 98</span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.13</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">       10.0.0.11</span><br><span class="line">       10.0.0.12</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10 dev eth0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<h2 id="两台-Nginx-同步配置文件"><a href="#两台-Nginx-同步配置文件" class="headerlink" title="两台 Nginx 同步配置文件"></a>两台 Nginx 同步配置文件</h2><p>使用 crontab 定时每 5 分钟执行脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -ueo pipefail</span><br><span class="line"></span><br><span class="line">NGINX_CONF_LOCATION=<span class="string">&quot;/usr/local/nginx/conf/&quot;</span></span><br><span class="line">BACKUP_SERVER=<span class="string">&quot;root@10.0.0.44&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里是执行rsync同步配置文件，然后打印结果中的第二行（如果有更新的文件，第二行不为空）</span></span><br><span class="line">rsync_result=$(rsync -av --delete <span class="variable">$&#123;NGINX_CONF_LOCATION&#125;</span> <span class="variable">$&#123;BACKUP_SERVER&#125;</span>:<span class="variable">$&#123;NGINX_CONF_LOCATION&#125;</span> | sed -n <span class="string">&quot;2p&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$&#123;rsync_result&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;the configuration file has not changed&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;changed nginx config, reload Backup Nginx&quot;</span></span><br><span class="line">  ssh <span class="variable">$&#123;BACKUP_SERVER&#125;</span> <span class="string">&quot;sudo /usr/local/nginx/sbin/nginx -s reload&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zahui.fan">张理坤</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zahui.fan/posts/0cebb8ae/">https://zahui.fan/posts/0cebb8ae/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zahui.fan" target="_blank">杂烩饭</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/">配置记录</a><a class="post-meta__tags" href="/tags/keepalived/">keepalived</a><a class="post-meta__tags" href="/tags/nginx/">nginx</a><a class="post-meta__tags" href="/tags/HA/">HA</a></div><div class="post-share"><div class="social-share" data-image="https://static.zahui.fan/public/Nginx.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/e59d8e32/" title="基于VictoriaMetrics的大规模监控实战"><img class="cover" src="https://static.zahui.fan/public/skeleton1.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">基于VictoriaMetrics的大规模监控实战</div></div><div class="info-2"><div class="info-item-1">victoriametrics 原生支持水平扩展，并且大部分兼容 Prometheus 语法，官方文档地址：https://docs.victoriametrics.com/ 这个是 victoriametrics 官方的集群架构  我公司用到的集群架构  目前用到 3 台机器    IP 部署的服务    10.0.0.21 vmauth、vmselect、vminsert、vmstorage、vmalert   10.0.0.22 vmselect、vminsert、vmstorage   10.0.0.23 vmselect、vminsert、vmstorage   vmstorage首先需要把存储部署上，多个存储之间数据是不同步的，也就是说所有的 storege 组件之间是感知不到彼此的。通过 vmselect 和 vminsert 采用一致性 hash 算法来确定读取&#x2F;写入哪台节点。 vmstorage 启动命令 12345678./vmstorage-prod -httpListenAddr &quot;0.0.0.0:8482&quot; \   #...</div></div></div></a><a class="pagination-related" href="/posts/666e547f/" title="Prometheus通过remote_write写入数据到另一台Prometheus"><img class="cover" src="https://static.zahui.fan/public/Prometheus.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Prometheus通过remote_write写入数据到另一台Prometheus</div></div><div class="info-2"><div class="info-item-1">假设 Prometheus1 是一个集群内的 Prometheus，需要远程写入数据到 Prometheus_Core Prometheus_Core 开启 remote_write_receiverPrometheus_Core 需要打开接收远程写入的功能，通过增加启动参数 --web.enable-remote-write-receiver： 1./prometheus --web.enable-remote-write-receiver --web.config.file=web.yml --web.listen-address=0.0.0.0:9090   远程写的接口地址 /api/v1/write  Prometheus_Core 开启认证参考 Prometheus开启basic_auth认证 Prometheus1 配置 remote_writePrometheus1 需要将 remote_write 写入到 Prometheus_Core 的远程接口 12345678910111213141516remote_write:- url:...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/675d47a9/" title="使用keepalived完成LVS高可用"><img class="cover" src="https://static.zahui.fan/public/skeleton1.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">使用keepalived完成LVS高可用</div></div><div class="info-2"><div class="info-item-1"> 有了 keepalived 可以不用执行 ipvsadm 了， 并且可以实现自动剔除节点，还可以两台 Director 做高可用。  手动配置 LVS 请看 内核级负载均衡 LVS DR模式 部署记录 另见：使用Keepalived来实现Nginx高可用 规划：    机器 IP    VIP 10.0.0.8   director 10.0.0.40   realserver1 10.0.0.42   realserver2 10.0.0.43   网卡 interface eth0   单台 Director Serverkeepalived 配置： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950vrrp_sync_group GOP &#123;    group &#123;        VI_PRI_CONNECT        VI_PRI_AUTH    &#125;&#125;vrrp_instance...</div></div></div></a><a class="pagination-related" href="/posts/5fdc91d7/" title="内核级负载均衡 LVS DR模式 部署记录"><img class="cover" src="https://static.zahui.fan/public/skeleton1.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">内核级负载均衡 LVS DR模式 部署记录</div></div><div class="info-2"><div class="info-item-1"> DR 模式，Director 和 realserver 都在一个内网里面，他们都绑定上同一个 VIP, 原理是通过 Director Server 修改数据包的 MAC 地址， 所以得让 realserver 不响应 arp，不然肯定会造成内网 IP 冲突  规划：    机器 IP    VIP 10.0.0.8   director 10.0.0.41   realserver1 10.0.0.42   realserver2 10.0.0.43   网卡 interface eth0   RealServer 设置创建虚拟网卡个人习惯，可选，可以绑定在任何网卡上面 1ip link add ipvs0 type dummy  配置不响应 ARP 请求方法1: 调整内核参数方法2: 采用arptables12345# 不响应ARP请求, 修改内核参数echo &quot;1&quot; &gt; /proc/sys/net/ipv4/conf/ipvs0/arp_ignoreecho &quot;1&quot; &gt;...</div></div></div></a><a class="pagination-related" href="/posts/67853ccb/" title="二进制部署Kuberntes"><img class="cover" src="https://static.zahui.fan/public/kubernetes.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-11-18</div><div class="info-item-2">二进制部署Kuberntes</div></div><div class="info-2"><div class="info-item-1">一些基本信息我这里以 AlmaLinux9 系统为例，类似 CentOS9 或 RHEL9 ，其他系统部分操作需要根据情况修改。    主机名称 IP 地址 说明 Kubernetes 组件 其他软件    master1 10.0.0.11 master 节点 kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy haproxy、keepalived、containerd   master2 10.0.0.12 master 节点 kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy haproxy、keepalived、containerd   master3 10.0.0.13 master...</div></div></div></a><a class="pagination-related" href="/posts/efee88da/" title="Ubuntu_Charmed_Kubernetes"><img class="cover" src="https://static.zahui.fan/public/Canonical%20Kubernetes.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Ubuntu_Charmed_Kubernetes</div></div><div class="info-2"><div class="info-item-1"> 官方文档: https://ubuntu.com/kubernetes/docs  开始之前集群 ip 规划，所有机器系统都是 ubuntu 20.04    hostname ip    juju-client 10.0.0.10   juju-controller-1 10.0.0.11   juju-master-1 10.0.0.21   juju-master-2 10.0.0.22   juju-master-3 10.0.0.23   juju-worker-1 10.0.0.31   juju-worker-2 10.0.0.32    juju-client 为 juju 客户端和 haproxy 机器juju-controller-1 为 juju 控制器节点 (可以做高可用)  以下操作都是在 juju-client 上执行 安装 juju1sudo snap install juju --classic  设置云类型12juju add-cloud输入manual  添加机器 (一共 5 台)12juju bootstrapjuju...</div></div></div></a><a class="pagination-related" href="/posts/526ffc9a/" title="使用kubeadm部署一套高可用k8s集群 for Ubuntu"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">使用kubeadm部署一套高可用k8s集群 for Ubuntu</div></div><div class="info-2"><div class="info-item-1"> 基于 ubuntu 使用 kubeadm 搭建集群， centos部署文档, 有疑问的地方可以看 官方文档  准备机器 我的机器详情如下, 配置至少为 4C4G     hostname IP 作用    public 10.0.0.3 ingress、apiserver 负载均衡，nfs 存储   master1 10.0.0.11 k8s master 节点   master2 10.0.0.12 k8s master 节点   master3 10.0.0.13 k8s master 节点   worker1 10.0.0.21 k8s worker 节点   worker2 10.0.0.22 k8s worker 节点   每台机器都做域名解析，或者绑定 hosts(可选但建议) 123456vim /etc/hosts10.0.0.3  public kube-apiserver10.0.0.11 master110.0.0.12 master210.0.0.13 master3  基础环境配置 基础环境是不管 master 还是 worker...</div></div></div></a><a class="pagination-related" href="/posts/sds4db/" title="zookeeper集群搭建"><img class="cover" src="https://static.zahui.fan/public/apache_zookeeper.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">zookeeper集群搭建</div></div><div class="info-2"><div class="info-item-1">下载1wget https://dlcdn.apache.org/zookeeper/zookeeper-3.8.4/apache-zookeeper-3.8.4-bin.tar.gz  Zookeeper 是为其他分布式程序提供服务的，所以本身自己不能随便就挂了，所以 zookeeper 自身的集群机制就很重要。zookeeper 的集群机制采用的是半数存活机制，也就是整个集群节点中有半数以上的节点存活，那么整个集群环境可用。这也就是说们的集群节点最好是奇数个节点。 1yum install -y java-1.8.0-openjdk  创建配置文件1mkdir -p /data/zookeeper_&#123;log,data&#125;  调整配置文件...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://static.zahui.fan/public/dog.svg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">张理坤</div><div class="author-info-description">张理坤的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">346</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">215</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/iuxt"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/iuxt" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:x@zahui.fan" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/165330963" rel="external nofollow noreferrer" target="_blank" title="Bilibili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="https://stackoverflow.com/users/15620461/" rel="external nofollow noreferrer" target="_blank" title="StackOverflow"><i class="fa-brands fa-stack-overflow"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-square-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">此博客为我记录运维工作总结所用，供网友阅读参考，如有侵权，请通知我，我会核实后进行处理。</br>
<strong style="color: red;">欢迎加入技术交流群：</strong>
<div class="aside-qrcode" >
<img src="https://src.babudiu.com/card/wechat_ops_group.JPG" title="微信群" width="100%" height="auto">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E6%92%AD%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">组播模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E6%92%AD%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">单播模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E6%8A%A2%E5%8D%A0%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="toc-number">3.</span> <span class="toc-text">非抢占式说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A4%E5%8F%B0-Nginx-%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">两台 Nginx 同步配置文件</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/64b52e0d/" title="最后一个Typora免费版0.11.18"><img src="https://static.zahui.fan/images/202303181541059.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="最后一个Typora免费版0.11.18"/></a><div class="content"><a class="title" href="/posts/64b52e0d/" title="最后一个Typora免费版0.11.18">最后一个Typora免费版0.11.18</a><time datetime="2025-02-27T03:24:04.000Z" title="更新于 2025-02-27 11:24:04">2025-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/snui2r/" title="Elasticsearch索引生命周期配置"><img src="https://static.zahui.fan/public/elasticsearch.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Elasticsearch索引生命周期配置"/></a><div class="content"><a class="title" href="/posts/snui2r/" title="Elasticsearch索引生命周期配置">Elasticsearch索引生命周期配置</a><time datetime="2025-02-26T03:53:02.000Z" title="更新于 2025-02-26 11:53:02">2025-02-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ss9srz/" title="Logstash 写入 ES：借助自定义模板优化数据映射与存储"><img src="https://static.zahui.fan/public/skeleton1.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Logstash 写入 ES：借助自定义模板优化数据映射与存储"/></a><div class="content"><a class="title" href="/posts/ss9srz/" title="Logstash 写入 ES：借助自定义模板优化数据映射与存储">Logstash 写入 ES：借助自定义模板优化数据映射与存储</a><time datetime="2025-02-26T03:41:19.000Z" title="更新于 2025-02-26 11:41:19">2025-02-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/a07ebcb/" title="使用 Elasticsearch 二进制 tar 包部署并初始化三节点集群"><img src="https://static.zahui.fan/public/elasticsearch.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用 Elasticsearch 二进制 tar 包部署并初始化三节点集群"/></a><div class="content"><a class="title" href="/posts/a07ebcb/" title="使用 Elasticsearch 二进制 tar 包部署并初始化三节点集群">使用 Elasticsearch 二进制 tar 包部署并初始化三节点集群</a><time datetime="2025-02-22T14:51:58.000Z" title="更新于 2025-02-22 22:51:58">2025-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ss2wk6/" title="使用Python识别验证码 ddddocr"><img src="https://static.zahui.fan/public/skeleton1.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用Python识别验证码 ddddocr"/></a><div class="content"><a class="title" href="/posts/ss2wk6/" title="使用Python识别验证码 ddddocr">使用Python识别验证码 ddddocr</a><time datetime="2025-02-22T09:57:12.000Z" title="更新于 2025-02-22 17:57:12">2025-02-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href='https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral'>
  本网站由<img src='https://static.zahui.fan/public/upyun.svg' alt='又拍云' width='70' height='28' style="vertical-align:bottom">
  提供CDN加速/云存储服务
</a>
</br>
<a href="https://beian.miit.gov.cn/" rel="external nofollow noreferrer" target="_blank">沪ICP备2021015230号-1</a>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.babudiu.com/client.js',
      'data-repo': 'iuxt/iuxt.github.io',
      'data-repo-id': 'R_kgDOMszkdA',
      'data-category-id': 'DIC_kwDOMszkdM4CiMyw',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },null)

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.babudiu.com')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜搜搜" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>