<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>kubeadm 部署的集群 常见问题汇总 | 杂烩饭</title><meta name="author" content="张理坤"><meta name="copyright" content="张理坤"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="扩容节点扩容 Worker 节点 kubeadm init 后会输出在终端上, 有效期 2 小时, 超时后可以重新生成  生成添加命令: 1kubeadm token create --print-join-command  扩容 Master 节点生成加入命令12345678# 生成证书, 记录 certificate keykubeadm init phase upload-certs --u">
<meta property="og:type" content="article">
<meta property="og:title" content="kubeadm 部署的集群 常见问题汇总">
<meta property="og:url" content="https://zahui.fan/posts/sepu3k/">
<meta property="og:site_name" content="杂烩饭">
<meta property="og:description" content="扩容节点扩容 Worker 节点 kubeadm init 后会输出在终端上, 有效期 2 小时, 超时后可以重新生成  生成添加命令: 1kubeadm token create --print-join-command  扩容 Master 节点生成加入命令12345678# 生成证书, 记录 certificate keykubeadm init phase upload-certs --u">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static.zahui.fan/public/Kubeadm.svg">
<meta property="article:published_time" content="2024-06-07T15:09:19.000Z">
<meta property="article:modified_time" content="2024-10-31T03:20:09.000Z">
<meta property="article:author" content="张理坤">
<meta property="article:tag" content="配置记录">
<meta property="article:tag" content="常用操作">
<meta property="article:tag" content="部署">
<meta property="article:tag" content="搭建">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="kubeadm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static.zahui.fan/public/Kubeadm.svg"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://zahui.fan/posts/sepu3k/"><link rel="preconnect"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/site.webmanifest"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?50b516d50102c8c9ac5f80529b81ca17";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-YN0WWZGVYN"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-YN0WWZGVYN')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-YN0WWZGVYN', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"此文章距离发布已经","messageNext":"天了，内容可能已经过时，请自行判断是否可用或联系博主更新。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'kubeadm 部署的集群 常见问题汇总',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-31 11:20:09'
}</script><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="杂烩饭" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://static.zahui.fan/public/dog.svg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">333</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">212</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://static.zahui.fan/public/Kubeadm.svg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://static.zahui.fan/public/boob.png" alt="Logo"><span class="site-name">杂烩饭</span></a><a class="nav-page-title" href="/"><span class="site-name">kubeadm 部署的集群 常见问题汇总</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://bbk-games.zahui.fan/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://aria2.babudiu.com/"><i class="fa-fw fas fa-download"></i><span> Aria2</span></a></li><li><a class="site-page child" target="_blank" rel="noopener external nofollow noreferrer" href="https://file.babudiu.com/"><i class="fa-fw fa-solid fa-file"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa-solid fa-paperclip"></i><span> 林克</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-brands fa-apple fa-bounce"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">kubeadm 部署的集群 常见问题汇总</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-07T15:09:19.000Z" title="发表于 2024-06-07 23:09:19">2024-06-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-31T03:20:09.000Z" title="更新于 2024-10-31 11:20:09">2024-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="扩容节点"><a href="#扩容节点" class="headerlink" title="扩容节点"></a>扩容节点</h2><h3 id="扩容-Worker-节点"><a href="#扩容-Worker-节点" class="headerlink" title="扩容 Worker 节点"></a>扩容 Worker 节点</h3><blockquote>
<p>kubeadm init 后会输出在终端上, 有效期 2 小时, 超时后可以重新生成</p>
</blockquote>
<p>生成添加命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<h3 id="扩容-Master-节点"><a href="#扩容-Master-节点" class="headerlink" title="扩容 Master 节点"></a>扩容 Master 节点</h3><h4 id="生成加入命令"><a href="#生成加入命令" class="headerlink" title="生成加入命令"></a>生成加入命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成证书, 记录 certificate key</span></span><br><span class="line">kubeadm init phase upload-certs --upload-certs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取加入命令</span></span><br><span class="line">kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将上面的输出结果拼接，这个就是加入 master 的命令，在新的 master 上执行</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(kubeadm token create --print-join-command)</span> --control-plane --certificate-key <span class="subst">$(kubeadm init phase upload-certs --upload-certs | tail -1)</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="修改负载均衡配置"><a href="#修改负载均衡配置" class="headerlink" title="修改负载均衡配置"></a>修改负载均衡配置</h4><p>扩容完 master 节点不要忘了将新的节点增加到 Apiserver 的负载均衡上。</p>
<h4 id="证书位置"><a href="#证书位置" class="headerlink" title="证书位置"></a>证书位置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里能看到在用哪个 secret</span></span><br><span class="line">kubectl get secret -n kube-system kubeadm-certs -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看对应的 secret</span></span><br><span class="line">kubectl get secret -n kube-system bootstrap-token-277b0n -o yaml</span><br></pre></td></tr></table></figure>

<h2 id="移除节点"><a href="#移除节点" class="headerlink" title="移除节点"></a>移除节点</h2><h3 id="移除-worker-节点"><a href="#移除-worker-节点" class="headerlink" title="移除 worker 节点"></a>移除 worker 节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain worker2 --ignore-daemonsets</span><br><span class="line">kubectl delete node worker2</span><br></pre></td></tr></table></figure>

<h3 id="移除-etcd-member"><a href="#移除-etcd-member" class="headerlink" title="移除 etcd member"></a>移除 etcd member</h3><p>如果要移除 master 节点，并且 master 节点上部署了 etcd ，那除了上一步操作，还需要从 etcd 集群中移除这个节点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it -n kube-system etcd-master1 -- /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看etcd member list</span></span><br><span class="line">etcdctl --endpoints 127.0.0.1:2379 --cacert /etc/kubernetes/pki/etcd/ca.crt --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key member list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过ID来删除etcd member</span></span><br><span class="line">etcdctl --endpoints 127.0.0.1:2379 --cacert /etc/kubernetes/pki/etcd/ca.crt --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key member remove 12637f5ec2bd02b8</span><br></pre></td></tr></table></figure>

<h2 id="升级集群"><a href="#升级集群" class="headerlink" title="升级集群"></a>升级集群</h2><p>kubeadm 搭建的集群升级比较方便，总体步骤如下：</p>
<ol>
<li>升级第一个 master 节点</li>
<li>升级其余的 master 节点</li>
<li>升级 worker 节点<br>如果集群运行着服务，升级节点前需要先腾空节点 <code>kubectl drain --ignore-daemonsets &lt;节点名称&gt;</code> 升级完成后，再恢复调度 <code>kubectl uncordon &lt;节点名称&gt; </code><br>官方文档：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/</a></li>
</ol>
<h3 id="升级第一个-master-节点"><a href="#升级第一个-master-节点" class="headerlink" title="升级第一个 master 节点"></a>升级第一个 master 节点</h3><p>上面安装的 <code>kubelet</code> <code>kubeadm</code> <code>kubectl</code> 这 3 个是机器上使用 yum 安装的，所以需要通过 yum 来升级。先升级 <code>kubeadm</code> 组件， 新版本每个大版本一个 yum 仓库，需要先修改仓库配置文件，参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/change-package-repository/">https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/change-package-repository/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看可用的版本</span></span><br><span class="line">sudo yum list --showduplicates kubeadm --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级kubeadm到指定的版本</span></span><br><span class="line">sudo yum update kubeadm-1.29.6 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证kubeadm版本</span></span><br><span class="line">kubeadm version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级检查，主要检查兼容性以及建议升级到的版本</span></span><br><span class="line">kubeadm upgrade plan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始升级，升级 `kube-apiserver` `kube-controller-manager` `kube-scheduler` 这些组件在节点上是以静态 Pod 的形式存在的。</span></span><br><span class="line">kubeadm upgrade apply v1.29.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把其他组件也一块升级了</span></span><br><span class="line">sudo yum update kubelet-1.29.6 kubectl-1.29.6 cri-tools kubernetes-cni --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启kubelet</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h3 id="升级其他-master-节点"><a href="#升级其他-master-节点" class="headerlink" title="升级其他 master 节点"></a>升级其他 master 节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级kubeadm到指定的版本</span></span><br><span class="line">sudo yum update kubeadm-1.29.6 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证kubeadm版本</span></span><br><span class="line">kubeadm version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级节点</span></span><br><span class="line">kubeadm upgrade node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级其他软件包</span></span><br><span class="line">sudo yum update kubelet-1.29.6 kubectl-1.29.6 cri-tools kubernetes-cni --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h3 id="升级-worker-节点"><a href="#升级-worker-节点" class="headerlink" title="升级 worker 节点"></a>升级 worker 节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级软件包</span></span><br><span class="line">sudo yum update kubeadm-1.29.6 kubelet-1.29.6 kubectl-1.29.6 cri-tools kubernetes-cni --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h2 id="测试集群是否正常"><a href="#测试集群是否正常" class="headerlink" title="测试集群是否正常"></a>测试集群是否正常</h2><p>创建一个 nginx 的 pod 资源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">kubectl get deploy,svc,pod</span><br></pre></td></tr></table></figure>

<p>访问 nodeport，检查能否访问到 nginx 服务</p>
<h2 id="查看-ETCD-状态"><a href="#查看-ETCD-状态" class="headerlink" title="查看 ETCD 状态"></a>查看 ETCD 状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -n kube-system etcd-master1 -- etcdctl --endpoints=<span class="string">&quot;10.0.0.13:2379,10.0.0.12:2379,10.0.0.11:2379&quot;</span> --cacert /etc/kubernetes/pki/etcd/ca.crt --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key endpoint status --write-out=table</span><br></pre></td></tr></table></figure>

<h2 id="pause-镜像版本问题"><a href="#pause-镜像版本问题" class="headerlink" title="pause 镜像版本问题"></a>pause 镜像版本问题</h2><p>使用 <code>kubeadm image pull</code> 事先把镜像拉取下来，但是后面 <code>kubeadm init</code> 还是报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; journalctl -xeu kubelet -f</span><br><span class="line"></span><br><span class="line">Jul 22 08:35:49 master1 kubelet[2079]: E0722 08:35:49.169395    2079 pod_workers.go:190] <span class="string">&quot;Error syncing pod, skipping&quot;</span> err=<span class="string">&quot;failed to \&quot;CreatePodSandbox\&quot; for \&quot;etcd-master1_kube-system(642dcd53ce8660a2287cd7eaabcd5fdc)\&quot; with CreatePodSandboxError: \&quot;Failed to create sandbox for pod \\\&quot;etcd-master1_kube-system(642dcd53ce8660a2287cd7eaabcd5fdc)\\\&quot;: rpc error: code = Unknown desc = failed to get sandbox image \\\&quot;k8s.gcr.io/pause:3.6\\\&quot;: failed to pull image \\\&quot;k8s.gcr.io/pause:3.6\\\&quot;: failed to pull and unpack image \\\&quot;k8s.gcr.io/pause:3.6\\\&quot;: failed to resolve reference \\\&quot;k8s.gcr.io/pause:3.6\\\&quot;: failed to do request: Head \\\&quot;https://k8s.gcr.io/v2/pause/manifests/3.6\\\&quot;: dial tcp 142.250.157.82:443: connect: connection refused\&quot;&quot;</span> pod=<span class="string">&quot;kube-system/etcd-master1&quot;</span> podUID=642dcd53ce8660a2287cd7eaabcd5fdc</span><br></pre></td></tr></table></figure>

<p>这里我们已经提前拉取了镜像在本地了， 但是 init 的时候还是会从 <code>k8s.gcr.io</code> 拉取镜像，造成 init 失败，如果你的网络可以访问 <code>k8s.gcr.io</code> 的情况下则可以完成初始化, 你会发现这里拉取失败的镜像 tag 和 <code>kubeadm config images pull</code> 拉下来的版本不一致。</p>
<p>问题原因：containerd 的配置文件里面指定了 pause 的镜像，这里会拉取这个版本的镜像，和 <code>kubeadm</code> 不一致。所以两个镜像都需要，或者修改下 containerd 的配置。</p>
<p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202405052245258.png" alt="image.png|522"></p>
<h2 id="修改-NodePort-端口范围"><a href="#修改-NodePort-端口范围" class="headerlink" title="修改 NodePort 端口范围"></a>修改 NodePort 端口范围</h2><p>在 master 节点上修改:</p>
<p>vim &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-apiserver.yaml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.22</span><span class="string">:6443</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--advertise-address=10.0.0.22</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--allow-privileged=true</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="comment"># 增加了这一行</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-node-port-range=1-65535</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.k8s.io/kube-apiserver:v1.27.3</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.22</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/livez</span></span><br></pre></td></tr></table></figure>

<p>修改完成后保存, apiserver 会自动重启.</p>
<h2 id="master-节点允许调度"><a href="#master-节点允许调度" class="headerlink" title="master 节点允许调度"></a>master 节点允许调度</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 老版本Kubernetes执行这个，我测试1.21是这污点</span></span><br><span class="line"><span class="comment"># kubectl taint node --all node-role.kubernetes.io/master:NoSchedule-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.28版本 去掉master上的这个污点即可</span></span><br><span class="line">kubectl taint nodes --all node-role.kubernetes.io/control-plane-</span><br></pre></td></tr></table></figure>

<h2 id="手动证书更新"><a href="#手动证书更新" class="headerlink" title="手动证书更新"></a>手动证书更新</h2><p><a href="/posts/ltckjzor/">使用kubeadm部署的集群证书过期后处理</a></p>
<h2 id="修改-kube-proxy-代理模式"><a href="#修改-kube-proxy-代理模式" class="headerlink" title="修改 kube-proxy 代理模式"></a>修改 kube-proxy 代理模式</h2><p>相比 iptables，使用 ipvs 可以提供更好的性能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system edit configmap kube-proxy</span><br></pre></td></tr></table></figure>

<p>mode 参数修改成 ipvs</p>
<p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202312112232082.png" alt="image.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system rollout restart daemonset kube-proxy</span><br></pre></td></tr></table></figure>

<p>查看 kube-proxy 日志，出现 Using ipvs Proxier 说明修改成功。<br><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202312112236807.png" alt="image.png"></p>
<h2 id="自动补全功能"><a href="#自动补全功能" class="headerlink" title="自动补全功能"></a>自动补全功能</h2><div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">CentOS</button><button type="button" class="tab">Ubuntu</button></div><div class="tab-contents"><div class="tab-item-content active"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bash-completion</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y bash-completion</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; ~/.bashrc &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zahui.fan">张理坤</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zahui.fan/posts/sepu3k/">https://zahui.fan/posts/sepu3k/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zahui.fan" target="_blank">杂烩饭</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/">配置记录</a><a class="post-meta__tags" href="/tags/%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/">常用操作</a><a class="post-meta__tags" href="/tags/%E9%83%A8%E7%BD%B2/">部署</a><a class="post-meta__tags" href="/tags/%E6%90%AD%E5%BB%BA/">搭建</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/kubeadm/">kubeadm</a></div><div class="post-share"><div class="social-share" data-image="https://static.zahui.fan/public/Kubeadm.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/sewhsk/" title="Windows 配置自动登录"><img class="cover" src="https://static.zahui.fan/public/Windows.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Windows 配置自动登录</div></div><div class="info-2"><div class="info-item-1">windows 中有部分应用程序需要登录当前账户才可以自动启动，或者嫌输密码麻烦，都可以设置自动登录，不用删除开机密码（删除开机密码也要鼠标点一下登录才可以登录） 修改注册表旧版本 windows 10 或者 windows 7 可以直接设置，但是新版本 windows 没有了这个选项，需要修改注册表配置 将下面文本保存成 reg 文件，双击导入。 1234Windows Registry Editor Version 5.00[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\PasswordLess\Device]&quot;DevicePasswordLessBuildVersion&quot;=dword:00000000  netplwiz 配置win + R 输入 netplwiz 打开用户管理界面。  取消勾选 要使用本计算机，用户必须输入用户名和密码 选项， 在弹出的框中输入当前用户密码。  </div></div></div></a><a class="pagination-related" href="/posts/seln9g/" title="Windows将网络修改为专用网络或公用网络"><img class="cover" src="https://static.zahui.fan/public/Windows.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Windows将网络修改为专用网络或公用网络</div></div><div class="info-2"><div class="info-item-1">一般来说新增一个网络适配器，会有个提示框， windows 老是改逻辑， 在 windows 7 时代在控制面板里是可以直接修改的， 但是在 Windows 11 已经不能修改了。  有什么影响会影响到防火墙策略， 比如在专用网络下， 局域网内是可以网络发现其他设备的。 比如我用 zerotier ，家里的电脑 zerotier 的网卡设置成了公用网络，那么就不能 rdp 远程连接家里电脑了。 修改方法需要以管理员身份运行 PowerShell 来执行： 12345678910111213141516171819PS C:\Users\iuxt&gt; Get-NetConnectionProfileName                     : CMCC-CaptainInterfaceAlias           : WLANInterfaceIndex           : 13NetworkCategory          : PrivateDomainAuthenticationKind : NoneIPv4Connectivity         :...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/34d8fad0/" title="Kubeadm之单节点master升级高可用master"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Kubeadm之单节点master升级高可用master</div></div><div class="info-2"><div class="info-item-1">单节点升级 master 总体来说就是两步， 先修改 apiserver 地址为负载均衡地址，然后添加新的 master 节点。 搭建集群的时候我们注意一下就可以减少后期维护的烦恼，比如：  使用 hostname 而不是 ip 来作为 kube-apiserver 地址 单节点也把负载均衡安排上  假设已经有一个没有负载均衡的单节点 master，现在想将它切换为高可用集群，记录以下步骤： 部署负载均衡参考 Kubernetes之master高可用方案 更新证书 因为我们部署了负载均衡，所以需要通过负载均衡的地址来访问 apiserver，因为证书是针对域名或者 ip 做的签名，如果 ip 变了证书就失效了，这也是为什么建议使用 hostname 来代替 ip  如果你是用 kubeadm init 来创建的集群，那么你需要导出一个 kubeadm 配置 1kubectl -n kube-system get configmap kubeadm-config -o...</div></div></div></a><a class="pagination-related" href="/posts/lq0y87n5/" title="使用kubeadm部署一套高可用k8s 1.29集群 for AlmaLinux9(RHEL9)"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-12-14</div><div class="info-item-2">使用kubeadm部署一套高可用k8s 1.29集群 for AlmaLinux9(RHEL9)</div></div><div class="info-2"><div class="info-item-1"> 基于 AlmaLinux9 使用 kubeadm 搭建集群， ubuntu部署文档, 有疑问的地方可以看 官方文档, 本教程需要能访问 国际互联网 。不能的话，需要解决镜像拉取问题、yum 安装组件的问题。  准备机器 我的机器详情如下, 配置至少为 4C4G     hostname IP 作用    master1 10.0.0.11 k8s master 节点   master2 10.0.0.12 k8s master 节点   master3 10.0.0.13 k8s master 节点   worker1 10.0.0.21 k8s worker 节点   worker2 10.0.0.22 k8s worker 节点   每台机器都做域名解析，或者绑定 hosts（直接使用 ip 地址会有警告） 123456vim /etc/hosts10.0.0.10  public kube-apiserver10.0.0.11 master110.0.0.12 master210.0.0.13 master3  每台机器都关闭防火墙和...</div></div></div></a><a class="pagination-related" href="/posts/b86d9e9f/" title="使用kubeadm部署一套高可用k8s集群 for CentOS"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">使用kubeadm部署一套高可用k8s集群 for CentOS</div></div><div class="info-2"><div class="info-item-1"> 基于 centos 使用 kubeadm 搭建集群， ubuntu部署文档, 有疑问的地方可以看 官方文档  准备机器 我的机器详情如下, 配置至少为 4C4G     hostname IP 作用    public 10.0.0.3 ingress 和 apiserver 的负载均衡，nfs 存储   master1 10.0.0.11 k8s master 节点   master2 10.0.0.12 k8s master 节点   master3 10.0.0.13 k8s master 节点   worker1 10.0.0.21 k8s worker 节点   worker2 10.0.0.22 k8s worker 节点   每台机器都做域名解析，或者绑定 hosts(可选但建议) 123456vim /etc/hosts10.0.0.3  public kube-apiserver10.0.0.11 master110.0.0.12 master210.0.0.13 master3  每台机器都关闭防火墙和 SELinux  负载均衡机器必须要关闭,因为...</div></div></div></a><a class="pagination-related" href="/posts/526ffc9a/" title="使用kubeadm部署一套高可用k8s集群 for Ubuntu"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">使用kubeadm部署一套高可用k8s集群 for Ubuntu</div></div><div class="info-2"><div class="info-item-1"> 基于 ubuntu 使用 kubeadm 搭建集群， centos部署文档, 有疑问的地方可以看 官方文档  准备机器 我的机器详情如下, 配置至少为 4C4G     hostname IP 作用    public 10.0.0.3 ingress、apiserver 负载均衡，nfs 存储   master1 10.0.0.11 k8s master 节点   master2 10.0.0.12 k8s master 节点   master3 10.0.0.13 k8s master 节点   worker1 10.0.0.21 k8s worker 节点   worker2 10.0.0.22 k8s worker 节点   每台机器都做域名解析，或者绑定 hosts(可选但建议) 123456vim /etc/hosts10.0.0.3  public kube-apiserver10.0.0.11 master110.0.0.12 master210.0.0.13 master3  基础环境配置 基础环境是不管 master 还是 worker...</div></div></div></a><a class="pagination-related" href="/posts/cb24765f/" title="RustDesk服务器搭建记录"><img class="cover" src="https://static.zahui.fan/public/RustDesk.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">RustDesk服务器搭建记录</div></div><div class="info-2"><div class="info-item-1">RustDesk 是一个远程控制工具，开源跨平台，可以使用官方的服务器，也可以自建服务器使用。服务器分为开源版 oss 和付费版 pro，我使用的是开源版。 部署服务器服务端是 rust 开发的，单文件直接运行即可。你可以使用你喜欢的进程管理工具来管理，比如 nodejs 写的 pm2， Python 写的 supervisor， 或者使用 docker 运行，我选择 docker。 启动命令1234567891011docker run -td --name hbbs \    -v ./data:/root \    --net=host \    --restart unless-stopped \    rustdesk/rustdesk-server hbbsdocker run -td --name hbbr \    -v ./data:/root \    --net=host \    --restart unless-stopped \    rustdesk/rustdesk-server hbbr  文件说明data 目录（容器内的 root...</div></div></div></a><a class="pagination-related" href="/posts/sfrqkr/" title="Kubernetes中的静态Pod"><img class="cover" src="https://static.zahui.fan/public/Kubeadm.svg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="fas fa-history fa-fw"></i> 2024-10-31</div><div class="info-item-2">Kubernetes中的静态Pod</div></div><div class="info-2"><div class="info-item-1">啥是静态 Pod静态 pod 就是不通过 Kubernetes 控制器直接运行的 pod，比如下面是一个 nginx 的静态 pod 123456789101112apiVersion: v1kind: Podmetadata:  name: static-webspec:  containers:    - name: web      image: registry.cn-hangzhou.aliyuncs.com/iuxt/nginx:1.27.0      ports:        - name: web          containerPort: 80          protocol: TCP  这种 pod 如果通过 kubectl delete pod static-web 来删除， 那么就直接删除了，不会像控制器一样重建 pod。 kubeadm 集群的组件二进制运行的组件二进制运行的组件就是不通过容器化，直接在机器上运行的组件，有 3 个组件 kubeadm kubelet kubectl ，其中：  kubectl...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://static.zahui.fan/public/dog.svg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">张理坤</div><div class="author-info-description">张理坤的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">333</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">212</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/iuxt"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/iuxt" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:x@zahui.fan" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://space.bilibili.com/165330963" rel="external nofollow noreferrer" target="_blank" title="Bilibili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="https://stackoverflow.com/users/15620461/" rel="external nofollow noreferrer" target="_blank" title="StackOverflow"><i class="fa-brands fa-stack-overflow"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-square-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">此博客为我记录运维工作总结所用，供网友阅读参考，如有侵权，请通知我，我会核实后进行处理。</br>
<strong style="color: red;">欢迎加入技术交流群：</strong>
<div class="aside-qrcode" >
<img src="https://src.babudiu.com/card/wechat_ops_group.JPG" title="微信群" width="100%" height="auto">
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E8%8A%82%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">扩容节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9-Worker-%E8%8A%82%E7%82%B9"><span class="toc-number">1.1.</span> <span class="toc-text">扩容 Worker 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9-Master-%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">扩容 Master 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%8A%A0%E5%85%A5%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.1.</span> <span class="toc-text">生成加入命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.2.</span> <span class="toc-text">修改负载均衡配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.2.3.</span> <span class="toc-text">证书位置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9"><span class="toc-number">2.</span> <span class="toc-text">移除节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%BB%E9%99%A4-worker-%E8%8A%82%E7%82%B9"><span class="toc-number">2.1.</span> <span class="toc-text">移除 worker 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%BB%E9%99%A4-etcd-member"><span class="toc-number">2.2.</span> <span class="toc-text">移除 etcd member</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E9%9B%86%E7%BE%A4"><span class="toc-number">3.</span> <span class="toc-text">升级集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E7%AC%AC%E4%B8%80%E4%B8%AA-master-%E8%8A%82%E7%82%B9"><span class="toc-number">3.1.</span> <span class="toc-text">升级第一个 master 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E5%85%B6%E4%BB%96-master-%E8%8A%82%E7%82%B9"><span class="toc-number">3.2.</span> <span class="toc-text">升级其他 master 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7-worker-%E8%8A%82%E7%82%B9"><span class="toc-number">3.3.</span> <span class="toc-text">升级 worker 节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8"><span class="toc-number">4.</span> <span class="toc-text">测试集群是否正常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-ETCD-%E7%8A%B6%E6%80%81"><span class="toc-number">5.</span> <span class="toc-text">查看 ETCD 状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pause-%E9%95%9C%E5%83%8F%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="toc-number">6.</span> <span class="toc-text">pause 镜像版本问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-NodePort-%E7%AB%AF%E5%8F%A3%E8%8C%83%E5%9B%B4"><span class="toc-number">7.</span> <span class="toc-text">修改 NodePort 端口范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#master-%E8%8A%82%E7%82%B9%E5%85%81%E8%AE%B8%E8%B0%83%E5%BA%A6"><span class="toc-number">8.</span> <span class="toc-text">master 节点允许调度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E8%AF%81%E4%B9%A6%E6%9B%B4%E6%96%B0"><span class="toc-number">9.</span> <span class="toc-text">手动证书更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-kube-proxy-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">10.</span> <span class="toc-text">修改 kube-proxy 代理模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E5%8A%9F%E8%83%BD"><span class="toc-number">11.</span> <span class="toc-text">自动补全功能</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/so9bdi/" title="Grafana表格绘制"><img src="https://static.zahui.fan/public/Grafana.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Grafana表格绘制"/></a><div class="content"><a class="title" href="/posts/so9bdi/" title="Grafana表格绘制">Grafana表格绘制</a><time datetime="2024-12-23T08:45:49.000Z" title="更新于 2024-12-23 16:45:49">2024-12-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/lqacdmqv/" title="使用kubectl进行多集群管理"><img src="https://static.zahui.fan/public/kubernetes.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用kubectl进行多集群管理"/></a><div class="content"><a class="title" href="/posts/lqacdmqv/" title="使用kubectl进行多集群管理">使用kubectl进行多集群管理</a><time datetime="2024-12-23T07:06:10.000Z" title="更新于 2024-12-23 15:06:10">2024-12-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/sootea/" title="nginx反向代理的context path"><img src="https://static.zahui.fan/public/skeleton1.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="nginx反向代理的context path"/></a><div class="content"><a class="title" href="/posts/sootea/" title="nginx反向代理的context path">nginx反向代理的context path</a><time datetime="2024-12-18T11:39:54.000Z" title="更新于 2024-12-18 19:39:54">2024-12-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/25938561/" title="Linux虚拟内存swap"><img src="https://static.zahui.fan/public/linux.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux虚拟内存swap"/></a><div class="content"><a class="title" href="/posts/25938561/" title="Linux虚拟内存swap">Linux虚拟内存swap</a><time datetime="2024-12-17T06:23:57.000Z" title="更新于 2024-12-17 14:23:57">2024-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5e168f7e/" title="快速搭建环境记录"><img src="https://static.zahui.fan/public/linux.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="快速搭建环境记录"/></a><div class="content"><a class="title" href="/posts/5e168f7e/" title="快速搭建环境记录">快速搭建环境记录</a><time datetime="2024-12-14T14:07:43.000Z" title="更新于 2024-12-14 22:07:43">2024-12-14</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href='https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral'>
  本网站由<img src='https://static.zahui.fan/public/upyun.svg' alt='又拍云' width='70' height='28' style="vertical-align:bottom">
  提供CDN加速/云存储服务
</a>
</br>
<a href="https://beian.miit.gov.cn/" rel="external nofollow noreferrer" target="_blank">沪ICP备2021015230号-1</a>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.babudiu.com/client.js',
      'data-repo': 'iuxt/iuxt.github.io',
      'data-repo-id': 'R_kgDOMszkdA',
      'data-category-id': 'DIC_kwDOMszkdM4CiMyw',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },null)

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.babudiu.com')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜搜搜" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>