<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>杂烩饭</title>
  <icon>https://zahui.fan/favicon.ico</icon>
  <subtitle>张理坤的博客 - 运维技术分享</subtitle>
  <link href="https://zahui.fan/atom.xml" rel="self"/>
  
  <link href="https://zahui.fan/"/>
  <updated>2025-02-20T15:12:52.000Z</updated>
  <id>https://zahui.fan/</id>
  
  <author>
    <name>张理坤</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>解决PyCharm终端使用zsh powerlevel10k主题时的乱码问题</title>
    <link href="https://zahui.fan/posts/srz9zs/"/>
    <id>https://zahui.fan/posts/srz9zs/</id>
    <published>2025-02-20T10:47:52.000Z</published>
    <updated>2025-02-20T15:12:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>powerlevel10k</code> 是 zsh 上很好看的主题，我一直是在 wsl 里用，配合 <code>Windows Terminal</code> 很好看，不过在 PyCharm 里打开会乱码，可以通过修改控制台字体为支持 powerline 的字体，不过还是不完美，有时候还有 BUG。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20250220230144904.png" alt="image.png|577"></p><p>想了下，我平时都是在 <code>Windows Terminal</code> 上用的，那么可以让使用 <code>Windows Terminal</code> 的时候显示成<strong>花里胡哨</strong>的主题，用其他软件比如 PyCharm 或者 VScode 的时候，换成<strong>朴素</strong>的主题。看了下，在 <code>Windows Terminal</code> 上有个特殊的环境变量 <code>WT_SESSION</code> 和 <code>WT_PROFILE_ID</code> ，看名字应该是和 Windows terminal 有关，测试了下也确实如此，那么可以修改 <code>~/.zshrc</code> 来实现。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20250220230859339.png" alt="image.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ <span class="variable">$WT_SESSION</span> ]]; <span class="keyword">then</span></span><br><span class="line">  ZSH_THEME=<span class="string">&quot;powerlevel10k/powerlevel10k&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  ZSH_THEME=<span class="string">&quot;robbyrussell&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>此时显示如下：</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20250220231032118.png"></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;code&gt;powerlevel10k&lt;/code&gt; 是 zsh 上很好看的主题，我一直是在 wsl 里用，配合 &lt;code&gt;Windows Terminal&lt;/code&gt; 很好看，不过在 PyCharm 里打开会乱码，可以通过修改控制台字体为支持 powerline 的字体，不过还是不完美，有时候还有 BUG。&lt;/p&gt;
&lt;p&gt;&lt;img src=</summary>
        
      
    
    
    
    <category term="工具" scheme="https://zahui.fan/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>Nacos 2.0.3 集群升级为 2.1.0</title>
    <link href="https://zahui.fan/posts/srnwhe/"/>
    <id>https://zahui.fan/posts/srnwhe/</id>
    <published>2025-02-14T07:22:25.000Z</published>
    <updated>2025-02-14T07:40:13.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="2-0-3-版本的-BUG"><a href="#2-0-3-版本的-BUG" class="headerlink" title="2.0.3 版本的 BUG"></a>2.0.3 版本的 BUG</h2><p>详细 bug 在 GitHub 上有，比如：<br><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20250214153333408.webp" alt="image.png"></p><p>issue 链接见：<br><a href="https://github.com/alibaba/nacos/issues/9332">https://github.com/alibaba/nacos/issues/9332</a><br><a href="https://github.com/alibaba/nacos/issues/8492">https://github.com/alibaba/nacos/issues/8492</a></p><p>我们遇到的 bug 简单一句话总结就是：集群方式部署的 nacos 其中一个节点重启后可能会有节点数据不一致的现象（服务注册与服务发现里面的服务数量不一致）比如说一个服务注册到了 nacos 中，我在 nacos 网页控制台 <code>服务管理</code> <code>服务列表</code> 里查看有 10 个服务注册进来，刷新下网页可能就变成了 9 个，再刷新又变成 10 个，这种情况就是 nacos 的多个节点数据不同步了（nacos 配置中心数据是从 MySQL 取的，不受这个 bug 的影响），这种情况可以直接将 nacos 副本数设置成 1 临时解决，想要彻底解决我们验证了升级到 2.1.0 就能修复。</p><h2 id="升级数据库表结构"><a href="#升级数据库表结构" class="headerlink" title="升级数据库表结构"></a>升级数据库表结构</h2><blockquote><p>nacos 官网文档写的太敷衍了，版本之间的差异需要自己找，哪怕你上个 flyway 也好啊。</p></blockquote><p>其中有三个表（config_info、config_info_beta、his_config_info）都加了 encrypted_data_key 这个字段。 所以升级方法也很简单，在这三张表上都加上 encrypted_data_key 这个字段就行了。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> nacos.config_info <span class="keyword">ADD</span> encrypted_data_key TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>; </span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> nacos.config_info_beta <span class="keyword">ADD</span> encrypted_data_key TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>; </span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> nacos.his_config_info <span class="keyword">ADD</span> encrypted_data_key TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure><h2 id="升级版本到-2-1-0"><a href="#升级版本到-2-1-0" class="headerlink" title="升级版本到 2.1.0"></a>升级版本到 2.1.0</h2><p>我们是部署在 Kubernetes 中的，只需要升级镜像版本就行了。一个镜像代理地址：<code>registry.cn-hangzhou.aliyuncs.com/iuxt/nacos-server:v2.1.0</code></p><p>具体部署配置查看：<a href="/posts/sebxm6/">在Kubernetes中部署nacos 2.1.0</a></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;2-0-3-版本的-BUG&quot;&gt;&lt;a href=&quot;#2-0-3-版本的-BUG&quot; class=&quot;headerlink&quot; title=&quot;2.0.3 版本的 BUG&quot;&gt;&lt;/a&gt;2.0.3 版本的 BUG&lt;/h2&gt;&lt;p&gt;详细 bug 在 GitHub 上有，比如：&lt;br&gt;&lt;img src= &quot;https://static.zahui.fan/public/nes.gif&quot;</summary>
        
      
    
    
    
    <category term="容器" scheme="https://zahui.fan/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
    <category term="Kubernetes" scheme="https://zahui.fan/tags/Kubernetes/"/>
    
    <category term="nacos" scheme="https://zahui.fan/tags/nacos/"/>
    
  </entry>
  
  <entry>
    <title>群晖NAS部署zerotier内网穿透访问</title>
    <link href="https://zahui.fan/posts/spi492/"/>
    <id>https://zahui.fan/posts/spi492/</id>
    <published>2025-01-03T07:17:25.000Z</published>
    <updated>2025-01-03T15:40:32.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>完成这个教程，你主要需要完成以下流程：</p><ul><li>在 NAS 上启用 SSH</li><li>创建一个持久的 TUN</li><li>安装 Docker</li><li>设置 Docker</li></ul><h2 id="创建一个持久的-TUN"><a href="#创建一个持久的-TUN" class="headerlink" title="创建一个持久的 TUN"></a>创建一个持久的 TUN</h2><div class="note info flat"><p>如果有 <code>/dev/net/tun</code> 就不用再执行了</p></div><p>使用 SSH 连接到你的 NAS，切换为 root 身份</p><p>创建一个开机自启动脚本: <code>/usr/local/etc/rc.d/tun.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建开机自启动脚本</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;#!/bin/sh -e \ninsmod /lib/modules/tun.ko&#x27;</span> &gt; /usr/local/etc/rc.d/tun.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加可执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> a+x /usr/local/etc/rc.d/tun.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动执行一下</span></span><br><span class="line">/usr/local/etc/rc.d/tun.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看是否有tun设备</span></span><br><span class="line"><span class="built_in">ls</span> /dev/net/tun</span><br></pre></td></tr></table></figure><h2 id="安装-Docker-到你的-NAS-上"><a href="#安装-Docker-到你的-NAS-上" class="headerlink" title="安装 Docker 到你的 NAS 上"></a>安装 Docker 到你的 NAS 上</h2><p>直接到套件中心去安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /var/lib/zerotier-one</span><br></pre></td></tr></table></figure><p>创建一个容器，这里将它命名为 zerotier，这里会自动下载最新版的 zerotier</p><p>要在 ssh 里创建，不要在群晖控制台创建。创建完成后可以在控制台进行管理。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d           \</span><br><span class="line">  --name zerotier       \</span><br><span class="line">  --restart=always      \</span><br><span class="line">  --device=/dev/net/tun \</span><br><span class="line">  --net=host            \</span><br><span class="line">  --cap-add=NET_ADMIN   \</span><br><span class="line">  --cap-add=SYS_ADMIN   \</span><br><span class="line">  -v /var/lib/zerotier-one:/var/lib/zerotier-one \</span><br><span class="line">  registry.cn-hangzhou.aliyuncs.com/iuxt/zerotier-synology:1.14.0</span><br></pre></td></tr></table></figure><blockquote><p>注：官方镜像：<code>zerotier/zerotier-synology:latest</code></p></blockquote><h2 id="使用与配置"><a href="#使用与配置" class="headerlink" title="使用与配置"></a>使用与配置</h2><p>查看状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it zerotier zerotier-cli status</span><br></pre></td></tr></table></figure><p>添加网络</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it zerotier zerotier-cli <span class="built_in">join</span> &lt;你的网络ID&gt;</span><br></pre></td></tr></table></figure><p>在 zerotier 后台授权当前设备，然后查看状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it zerotier zerotier-cli listnetworks</span><br></pre></td></tr></table></figure><h2 id="使局域网网段可以访问"><a href="#使局域网网段可以访问" class="headerlink" title="使局域网网段可以访问"></a>使局域网网段可以访问</h2><h3 id="1-添加路由"><a href="#1-添加路由" class="headerlink" title="1. 添加路由"></a>1. 添加路由</h3><p>假设家里的机器：zerotier 地址是：172.28.135.11，内网 IP 地址是 192.168.1.11</p><p>在 zerotier 网站的 networks 里面的 Managed Routes 下配置路由表,增加如下内容</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20250103135337663.png" alt="image.png"></p><p>加过路由后，可以访问这台 zerotier 节点的内网 ip（192.168.1.11） 了，但是不能访问内网的其他 ip，还需要做一下转发。</p><h3 id="2-开启内核转发"><a href="#2-开启内核转发" class="headerlink" title="2. 开启内核转发"></a>2. 开启内核转发</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure><p>重启后配置会丢失，要持久化可以写入到 <code>/etc/sysctl.conf</code></p><h3 id="3-防火墙设置"><a href="#3-防火墙设置" class="headerlink" title="3. 防火墙设置"></a>3. 防火墙设置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PHY_IF=ovs_eth0 <span class="comment"># 物理网卡设备名</span></span><br><span class="line"><span class="built_in">export</span> ZT_IF=ztre4xmo4y <span class="comment"># Zerotier虚拟网卡设备名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加转发规则</span></span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o <span class="variable">$PHY_IF</span> -j MASQUERADE</span><br><span class="line">sudo iptables -A FORWARD -i <span class="variable">$PHY_IF</span> -o <span class="variable">$ZT_IF</span> -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">sudo iptables -A FORWARD -i <span class="variable">$ZT_IF</span> -o <span class="variable">$PHY_IF</span> -j ACCEPT</span><br></pre></td></tr></table></figure><p>防火墙规则没保存的话重启后会丢失。</p><div class="note info flat"><p>这三条 iptables 规则用于配置网络地址转换（NAT）和数据包转发；</p><p>含义如下：</p><p>规则 1： <code>sudo iptables -t nat -A POSTROUTING -o $PHY_IF -j MASQUERADE</code></p><p>这条规则在 nat 表的 POSTROUTING 链中添加了一条规则。-o $PHY_IF 表示这条规则适用于所有通过 $PHY_IF 这个网络接口（通常是物理接口）出去的数据包。-j MASQUERADE 指定了 NAT 操作中的伪装（masquerading）。这意味着，当数据包从 $PHY_IF 发送出去时，其源 IP 地址会被替换为 $PHY_IF 的 IP 地址。这通常用于允许内部网络通过一个公共 IP 地址进行外部通信；</p><p>规则 2： <code>sudo iptables -A FORWARD -i $PHY_IF -o $ZT_IF -m state --state RELATED,ESTABLISHED -j ACCEPT</code></p><p>这条规则在 filter 表的 FORWARD 链中添加了一条规则。-i $PHY_IF 表示适用于从 $PHY_IF 这个接口进入的数据包，-o $ZT_IF 表示这些数据包要转发到 $ZT_IF 这个接口。-m state –state RELATED,ESTABLISHED 指定了只有那些与已有连接相关或已经建立的连接的数据包才被接受（ACCEPT）。这个规则通常用于允许来自外部网络的返回流量进入内部网络，从而支持诸如 HTTP 会话等；</p><p>规则 3： <code>sudo iptables -A FORWARD -i $ZT_IF -o $PHY_IF -j ACCEPT</code></p><p>这条规则在 filter 表的 FORWARD 链中添加了一条规则。-i $ZT_IF 表示适用于从 $ZT_IF 这个接口进入的数据包，-o $PHY_IF 表示这些数据包要转发到 $PHY_IF 这个接口。-j ACCEPT 表示这些数据包会被接受并转发。这条规则允许来自 $ZT_IF 的流量经过路由器转发到 $PHY_IF，从而实现网络之间的数据传输；</p><p>总结：</p><p>第一条规则用于设置源地址伪装，允许内部网络设备通过一个公共 IP 地址进行外部通信；<br>第二条规则允许返回流量和已经建立的连接的数据包从外部网络进入内部网络；<br>第三条规则允许来自内部网络的数据包被转发到外部网络；</p></div><p>网卡设备名参考 在机器上使用命令 <code>ip a</code> 查看：</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20250103232323506.png" alt="image.png"></p><h2 id="引用与文献"><a href="#引用与文献" class="headerlink" title="引用与文献"></a>引用与文献</h2><blockquote><p>本文基于官方原文进行翻译和补充 <a href="https://docs.zerotier.com/synology/#set-up-container">https://docs.zerotier.com/synology/#set-up-container</a><br>  iptables 规则转载自：<a href="https://jasonkayzk.github.io/2024/08/21/Zerotier%E9%85%8D%E7%BD%AE%E5%86%85%E7%BD%91%E6%B5%81%E9%87%8F%E8%BD%AC%E5%8F%91/">https://jasonkayzk.github.io/2024/08/21/Zerotier%E9%85%8D%E7%BD%AE%E5%86%85%E7%BD%91%E6%B5%81%E9%87%8F%E8%BD%AC%E5%8F%91/</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;完成这个教程，你主要需要完成以下流程：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在 NAS 上启用 SSH&lt;/li&gt;
&lt;li&gt;创建一个持久的 TUN&lt;/li&gt;
&lt;li&gt;安装 Docker&lt;/li&gt;
&lt;li&gt;设置 Docker&lt;/li&gt;
&lt;/ul&gt;
&lt;h2</summary>
        
      
    
    
    
    <category term="工具" scheme="https://zahui.fan/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="网络" scheme="https://zahui.fan/tags/%E7%BD%91%E7%BB%9C/"/>
    
    <category term="nas" scheme="https://zahui.fan/tags/nas/"/>
    
  </entry>
  
  <entry>
    <title>管理Redis内存占用</title>
    <link href="https://zahui.fan/posts/spcjoj/"/>
    <id>https://zahui.fan/posts/spcjoj/</id>
    <published>2024-12-31T07:04:50.000Z</published>
    <updated>2025-01-05T03:38:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="淘汰策略"><a href="#淘汰策略" class="headerlink" title="淘汰策略"></a>淘汰策略</h2><p>如果设置了合适的淘汰策略，Redis 会根据以下几种策略选择性地移除某些键，腾出内存空间（淘汰策略需要和内存限制配合使用）</p><p>常用淘汰策略说明</p><table><thead><tr><th>策略</th><th>说明</th></tr></thead><tbody><tr><td>volatile-lru</td><td>从设置了过期时间的键中，移除最近最少使用（LRU）的键。</td></tr><tr><td>allkeys-lru</td><td>从所有键中，移除最近最少使用（LRU）的键。</td></tr><tr><td>volatile-random</td><td>从设置了过期时间的键中，随机移除键。</td></tr><tr><td>allkeys-random</td><td>从所有键中，随机移除键。</td></tr><tr><td>volatile-ttl</td><td>从设置了过期时间的键中，移除即将过期的键（优先移除 TTL 短的键）。</td></tr><tr><td>noeviction</td><td>当内存超过限制时，直接返回错误，不再执行新增操作（这是默认策略）。</td></tr></tbody></table><p>设置方法： 在 redis.conf 文件中添加或修改：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxmemory-policy allkeys-lru</span><br></pre></td></tr></table></figure><p>或通过命令行动态设置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli config <span class="built_in">set</span> maxmemory-policy allkeys-lru</span><br></pre></td></tr></table></figure><h2 id="内存限制"><a href="#内存限制" class="headerlink" title="内存限制"></a>内存限制</h2><p>设置 maxmemory</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">maxmemory 4gb</span><br><span class="line"># maxmemory 4G</span><br><span class="line"># maxmemory 4294967296</span><br></pre></td></tr></table></figure><p>通过命令行动态设置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli config <span class="built_in">set</span> maxmemory 4294967296</span><br></pre></td></tr></table></figure><h2 id="持久化设置"><a href="#持久化设置" class="headerlink" title="持久化设置"></a>持久化设置</h2><p>如果缓存数据可丢失，可以禁用持久化（RDB 和 AOF）以减少磁盘 IO 开销：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">save <span class="string">&quot;&quot;</span></span><br><span class="line">appendonly no</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;淘汰策略&quot;&gt;&lt;a href=&quot;#淘汰策略&quot; class=&quot;headerlink&quot; title=&quot;淘汰策略&quot;&gt;&lt;/a&gt;淘汰策略&lt;/h2&gt;&lt;p&gt;如果设置了合适的淘汰策略，Redis</summary>
        
      
    
    
    
    <category term="数据库" scheme="https://zahui.fan/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="redis" scheme="https://zahui.fan/tags/redis/"/>
    
    <category term="性能优化" scheme="https://zahui.fan/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>使用Python识别验证码，效果不错</title>
    <link href="https://zahui.fan/posts/sp3b30/"/>
    <id>https://zahui.fan/posts/sp3b30/</id>
    <published>2024-12-26T07:20:59.000Z</published>
    <updated>2024-12-27T04:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<div class="note flat"><p>以前用过什么 pytesseract 识别效果很差，还需要电脑上安装 <code>Tesseract OCR</code> 的软件，但是使用下来，效果不好，后面也用过 <code>PaddleOCR</code> 可以识别，但是识别速度比较慢，成功率也不高。后面又看到了这个开源工具，吹牛逼比较厉害，号称自己是验证码识别的最高境界，就试试看。官方的 GitHub 地址是：<a href="https://github.com/litongjava/muggle_ocr">https://github.com/litongjava/muggle_ocr</a></p></div><h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20241226175928967.gif" alt="20241226175928967.gif|728"></p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>OS： Windows 11<br>Python： python-3.10.10-amd64</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>这个开源程序在 pypi 仓库上被移除了，需要在 GitHub 上将源码包下载下来安装。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20241226152841716.png" alt="image.png|595"></p><p>下载到本地，解压后，打开 cmd 命令提示符，</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">REM 创建虚拟环境</span></span><br><span class="line">python -m venv venv</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM 安装muggle_ocr</span></span><br><span class="line"><span class="built_in">cd</span> muggle_ocr-main</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure><h3 id="报错处理"><a href="#报错处理" class="headerlink" title="报错处理"></a>报错处理</h3><p><code>error: numpy 2.2.1 is installed but numpy&lt;2.1.0,&gt;=1.26.0 is required by &#123;&#39;tensorflow-intel&#39;&#125;</code></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">REM 用这条命令查一下可用的版本</span></span><br><span class="line">pip index versions numpy</span><br><span class="line"></span><br><span class="line">pip install numpy==<span class="number">2</span>.<span class="number">0</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure><p>然后再重新安装 muggle_ocr</p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>识别验证码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os </span><br><span class="line"><span class="keyword">import</span> muggle_ocr</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">使用预置模型，预置模型包含了[ModelType.OCR, ModelType.Captcha] 两种</span></span><br><span class="line"><span class="string">其中 ModelType.OCR 用于识别普通印刷文本, ModelType.Captcha 用于识别4-6位简单英数验证码</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开验证码图片</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&quot;1.png&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    captcha_bytes = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ModelType.Captcha 可识别4-6位验证码</span></span><br><span class="line">sdk = muggle_ocr.SDK(model_type=muggle_ocr.ModelType.Captcha)</span><br><span class="line"><span class="comment"># 3. 调用预测函数</span></span><br><span class="line">text = sdk.predict(image_bytes=captcha_bytes)</span><br><span class="line"><span class="built_in">print</span>(text)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;div class=&quot;note flat&quot;&gt;&lt;p&gt;以前用过什么 pytesseract 识别效果很差，还需要电脑上安装 &lt;code&gt;Tesseract OCR&lt;/code&gt; 的软件，但是使用下来，效果不好，后面也用过 &lt;code&gt;PaddleOCR&lt;/code&gt;</summary>
        
      
    
    
    
    <category term="开发" scheme="https://zahui.fan/categories/%E5%BC%80%E5%8F%91/"/>
    
    
  </entry>
  
  <entry>
    <title>nginx反向代理的context path</title>
    <link href="https://zahui.fan/posts/sootea/"/>
    <id>https://zahui.fan/posts/sootea/</id>
    <published>2024-12-18T11:32:33.000Z</published>
    <updated>2025-02-19T09:46:45.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="返回请求-uri"><a href="#返回请求-uri" class="headerlink" title="返回请求 uri"></a>返回请求 uri</h2><p>在 Nginx 中，可以使用 <code>$request_uri</code> 来表示请求 uri, 配置如下；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        add_header Content-Type text/html;</span><br><span class="line">        return 200 &quot;$request_uri\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里再使用另一台 nginx 反向代理到这台 nginx 就可以测试请求的 uri 了。</p><h2 id="测试-nginx-的反向代理-content-path"><a href="#测试-nginx-的反向代理-content-path" class="headerlink" title="测试 nginx 的反向代理 content path"></a>测试 nginx 的反向代理 content path</h2><h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">   proxy_pass http://192.168.200.12;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果是</p><p><code>curl localhost/aa/bb/</code> –&gt; <code>http://192.168.200.12/aa/bb/</code></p><h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /aa &#123;</span><br><span class="line">   proxy_pass http://192.168.200.12;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果和上面一样，但是只有 &#x2F;aa 开头的才能转发到这里</p><h3 id="3"><a href="#3" class="headerlink" title="3"></a>3</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /aa/ &#123;</span><br><span class="line">   proxy_pass http://192.168.200.12;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果和上面一样，但是只有 &#x2F;aa&#x2F; 开头的才能转发到这里</p><h3 id="4"><a href="#4" class="headerlink" title="4"></a>4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /aa &#123;</span><br><span class="line">   proxy_pass http://192.168.200.12/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 nginx]<span class="comment"># curl localhost/aa/bb/cc</span></span><br><span class="line">//bb/cc</span><br></pre></td></tr></table></figure><h3 id="5"><a href="#5" class="headerlink" title="5"></a>5</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /aa &#123;</span><br><span class="line">   proxy_pass http://192.168.200.12/x/y/z;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 nginx]<span class="comment"># curl localhost/aa</span></span><br><span class="line">/x/y/z</span><br></pre></td></tr></table></figure><h2 id="nginx-的-alias"><a href="#nginx-的-alias" class="headerlink" title="nginx 的 alias"></a>nginx 的 alias</h2><p>Nginx 的 alias 指令可以理解为“路径别名”，它能把用户访问的 URL 路径直接映射到服务器上的另一个真实目录。举个例子：</p><p>假设你配置了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /images/ &#123;</span><br><span class="line">    alias /var/www/my_photos/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当用户访问 <code>http://你的网站/images/cat.jpg</code> 时，Nginx 会直接去服务器上的 <code>/var/www/my_photos/cat.jpg</code> 找文件，而不会保留 URL 中的 <code>/images/</code> 路径。</p><p>和另一个指令 root 的区别在于：</p><p>用 root 时，路径是追加（比如 location &#x2F;a&#x2F; { root &#x2F;b; }，访问 <code>/a/1.jpg</code> 会找 <code>/b/a/1.jpg</code>）<br>用 alias 时，路径是替换（同样配置下，访问 <code>/a/1.jpg</code> 会直接找 <code>/b/1.jpg</code>）<br>需要注意：配置时路径末尾的 <code>/</code> 要统一，比如 <code>location /images/</code> 和 <code>alias /var/www/my_photos/</code> 都要带斜杠，否则可能导致路径错误</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;返回请求-uri&quot;&gt;&lt;a href=&quot;#返回请求-uri&quot; class=&quot;headerlink&quot; title=&quot;返回请求 uri&quot;&gt;&lt;/a&gt;返回请求 uri&lt;/h2&gt;&lt;p&gt;在 Nginx 中，可以使用 &lt;code&gt;$request_uri&lt;/code&gt; 来表示请求 uri, 配置如下；&lt;/p&gt;
&lt;figure class=&quot;highlight</summary>
        
      
    
    
    
    <category term="基础运维" scheme="https://zahui.fan/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="Nginx" scheme="https://zahui.fan/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>使用kubeadm部署一套高可用k8s 1.32集群 for AlmaLinux9(RHEL9)</title>
    <link href="https://zahui.fan/posts/sof9i3/"/>
    <id>https://zahui.fan/posts/sof9i3/</id>
    <published>2024-12-13T07:44:27.000Z</published>
    <updated>2025-01-08T10:08:52.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>基于 AlmaLinux9 使用 kubeadm 搭建集群， <a href="/posts/526ffc9a/">ubuntu部署文档</a>, 有疑问的地方可以看 <a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/">官方文档</a>, 本教程需要能访问 <strong>国际互联网</strong> 。不能的话，需要解决镜像拉取问题、yum 安装组件的问题。</p></blockquote><h2 id="准备机器"><a href="#准备机器" class="headerlink" title="准备机器"></a>准备机器</h2><blockquote><p>我的机器详情如下, 配置至少为 4C4G</p></blockquote><table><thead><tr><th>hostname</th><th>IP</th><th>作用</th></tr></thead><tbody><tr><td>master1</td><td>10.0.0.11</td><td>k8s master 节点</td></tr><tr><td>master2</td><td>10.0.0.12</td><td>k8s master 节点</td></tr><tr><td>master3</td><td>10.0.0.13</td><td>k8s master 节点</td></tr><tr><td>worker1</td><td>10.0.0.21</td><td>k8s worker 节点</td></tr><tr><td>worker2</td><td>10.0.0.22</td><td>k8s worker 节点</td></tr></tbody></table><p>每台机器都做域名解析，或者绑定 hosts（直接使用 ip 地址会有警告）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"></span><br><span class="line">10.0.0.11 master1</span><br><span class="line">10.0.0.12 master2</span><br><span class="line">10.0.0.13 master3</span><br></pre></td></tr></table></figure><p>每台机器都关闭防火墙和 SELinux</p><blockquote><p>负载均衡机器必须要关闭,因为 6443 不是 nginx 的标准端口,会被 selinux 拦截, 防火墙也需要放行 6443 端口, 可以考虑直接关闭防火墙</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">disable</span> --now firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&quot;s/^SELINUX=.*/SELINUX=disabled/g&quot;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># RHEL9系列完全关闭selinux需要修改内核启动参数，/etc/selinux/config 文件里面有说明</span></span><br></pre></td></tr></table></figure><h2 id="基础环境配置"><a href="#基础环境配置" class="headerlink" title="基础环境配置"></a>基础环境配置</h2><blockquote><p>基础环境是不管 master 还是 worker 都需要的环境</p></blockquote><ol><li>禁用 swap</li><li>确保每个节点上 MAC 地址和 product_uuid 的唯一性 <code>sudo cat /sys/class/dmi/id/product_uuid</code></li><li>修改 hostname</li></ol><h3 id="安装-runtime"><a href="#安装-runtime" class="headerlink" title="安装 runtime"></a>安装 runtime</h3><h4 id="设置内核参数"><a href="#设置内核参数" class="headerlink" title="设置内核参数"></a>设置内核参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置必需的 sysctl 参数，这些参数在重新启动后仍然存在。</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables  = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用 sysctl 参数而无需重新启动</span></span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure><h4 id="启用内核模块"><a href="#启用内核模块" class="headerlink" title="启用内核模块"></a>启用内核模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/containerd.conf</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br></pre></td></tr></table></figure><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载旧版本Docker</span></span><br><span class="line">sudo yum remove docker \</span><br><span class="line">              docker-client \</span><br><span class="line">              docker-client-latest \</span><br><span class="line">              docker-common \</span><br><span class="line">              docker-latest \</span><br><span class="line">              docker-latest-logrotate \</span><br><span class="line">              docker-logrotate \</span><br><span class="line">              docker-engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装docker仓库</span></span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装containerd</span></span><br><span class="line">sudo yum install containerd.io -y</span><br></pre></td></tr></table></figure><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>从 yum 源安装的 containerd 默认禁用了 cri，可以使用命令重新生成默认配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 软件包中自带的配置文件不全，使用命令生成。</span></span><br><span class="line">containerd config default | sudo <span class="built_in">tee</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结合 runc 使用 systemd cgroup 驱动，在 `/etc/containerd/config.toml` 中设置</span></span><br><span class="line">sed -i <span class="string">&#x27;s#SystemdCgroup = .*#SystemdCgroup = true#g&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 pause容器 镜像，不能拉取官方镜像的可以使用阿里云镜像源</span></span><br><span class="line"><span class="comment"># sed -i &#x27;s#sandbox_image = .*#sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.9&quot;#g&#x27; /etc/containerd/config.toml</span></span><br><span class="line">sed -i <span class="string">&#x27;s#sandbox_image = .*#sandbox_image = &quot;registry.k8s.io/pause:3.10&quot;#g&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机自启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> containerd</span><br><span class="line">sudo systemctl restart containerd</span><br></pre></td></tr></table></figure><h4 id="crictl-配置"><a href="#crictl-配置" class="headerlink" title="crictl 配置"></a>crictl 配置</h4><p>之前使用 docker 的时候，docker 给我们做了很多好用的工具，现在用了 containerd，管理容器我们用 cri 管理工具 crictl，创建配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/crictl.yaml &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="安装-kubeadm、kubelet-和-kubectl"><a href="#安装-kubeadm、kubelet-和-kubectl" class="headerlink" title="安装 kubeadm、kubelet 和 kubectl"></a>安装 kubeadm、kubelet 和 kubectl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://pkgs.k8s.io/core:/stable:/v1.32/rpm/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://pkgs.k8s.io/core:/stable:/v1.32/rpm/repodata/repomd.xml.key</span></span><br><span class="line"><span class="string">exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看可用的版本</span></span><br><span class="line">yum list kubelet kubeadm kubectl --showduplicates --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">sudo yum install -y kubelet-1.32.0 kubeadm-1.32.0 kubectl-1.32.0 --disableexcludes=kubernetes</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure><h2 id="kube-apiserver-高可用方案"><a href="#kube-apiserver-高可用方案" class="headerlink" title="kube-apiserver 高可用方案"></a>kube-apiserver 高可用方案</h2><p>高可用方案有很多种，其他方案请参考 <a href="/posts/10cef768/">Kubernetes之master高可用方案</a></p><p>这里使用<strong>每台</strong>节点部署 nginx 反代来实现高可用，这种方式需要<strong>所有</strong>节点都安装负载均衡 (包括 master 和 worker )</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/kube-lb/&#123;conf,logs,sbin&#125;</span><br><span class="line"></span><br><span class="line">curl -L -C - https://file.babudiu.com/f/qjhX/kube-lb -o /etc/kube-lb/sbin/kube-lb</span><br><span class="line"><span class="built_in">chmod</span> +x /etc/kube-lb/sbin/kube-lb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/kube-lb/conf/kube-lb.conf &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">user root;</span><br><span class="line">worker_processes 1;</span><br><span class="line"></span><br><span class="line">error_log  /etc/kube-lb/logs/error.log warn;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  3000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        server 10.0.0.11:6443    max_fails=2 fail_timeout=3s;</span><br><span class="line">        server 10.0.0.12:6443    max_fails=2 fail_timeout=3s;</span><br><span class="line">        server 10.0.0.13:6443    max_fails=2 fail_timeout=3s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 127.0.0.1:8443;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_pass backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/kube-lb.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=l4 nginx proxy <span class="keyword">for</span> kube-apiservers</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStartPre=/etc/kube-lb/sbin/kube-lb -c /etc/kube-lb/conf/kube-lb.conf -p /etc/kube-lb -t</span><br><span class="line">ExecStart=/etc/kube-lb/sbin/kube-lb -c /etc/kube-lb/conf/kube-lb.conf -p /etc/kube-lb</span><br><span class="line">ExecReload=/etc/kube-lb/sbin/kube-lb -c /etc/kube-lb/conf/kube-lb.conf -p /etc/kube-lb -s reload</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=15</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> --now kube-lb</span><br></pre></td></tr></table></figure><div class="note default flat"><p>kube-lb 其实就是自己编译的 Nginx，精简了 http 模块，只开启了 stream 模块用作 4 层转发，详细参数如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx version: nginx/1.24.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)</span><br><span class="line">configure arguments: --with-stream --without-http --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module</span><br></pre></td></tr></table></figure></div><h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h2><h3 id="提前拉镜像（可选）"><a href="#提前拉镜像（可选）" class="headerlink" title="提前拉镜像（可选）"></a>提前拉镜像（可选）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images pull \</span><br><span class="line">--kubernetes-version 1.32.0 \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure><h3 id="kubeadm-init"><a href="#kubeadm-init" class="headerlink" title="kubeadm init"></a>kubeadm init</h3><p>在 master1 上执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init \</span><br><span class="line">--control-plane-endpoint <span class="string">&quot;127.0.0.1:8443&quot;</span> \</span><br><span class="line">--kubernetes-version 1.32.0 \</span><br><span class="line">--upload-certs \</span><br><span class="line">--service-cidr=10.96.0.0/12 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure><ul><li>也可以用 <code>kubeadm config print init-defaults &gt; init.yaml</code> 生成 kubeadm 的配置，并用 <code>kubeadm init --config=init.yaml</code> 来创建集群。</li><li>如果不能拉官方镜像，增加参数使用阿里云镜像源 <code>--image-repository registry.aliyuncs.com/google_containers</code></li></ul><h3 id="安装网络插件"><a href="#安装网络插件" class="headerlink" title="安装网络插件"></a>安装网络插件</h3><div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">安装flannel插件</button><button type="button" class="tab">安装calico插件</button></div><div class="tab-contents"><div class="tab-item-content active"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果修改了 pod-network-cidr 这个yml文件也需要修改</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">待补充</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><p><a href="/posts/sepu3k/">kubeadm 部署的集群 常见问题汇总</a></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;基于 AlmaLinux9 使用 kubeadm 搭建集群， &lt;a href=&quot;/posts/526ffc9a/&quot;&gt;ubuntu部署文档&lt;/a&gt;, 有疑问的地方可以看 &lt;a href=&quot;https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/&quot;&gt;官方文档&lt;/a&gt;,</summary>
        
      
    
    
    
    <category term="容器" scheme="https://zahui.fan/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>Grafana表格绘制</title>
    <link href="https://zahui.fan/posts/so9bdi/"/>
    <id>https://zahui.fan/posts/so9bdi/</id>
    <published>2024-12-10T02:39:17.000Z</published>
    <updated>2024-12-23T08:45:49.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="选择一个关联标签"><a href="#选择一个关联标签" class="headerlink" title="选择一个关联标签"></a>选择一个关联标签</h2><p><code>instance</code> 是机器 ip，不会重复，所以我用这个做关联字段。<br>第一个查询我会保留多一些标签，（可以使用 <code>sum by ... (instance)</code> 保留想要的标签）其他的查询尽量只保留关联字段。</p><p>默认配置了多个查询，并将 Grafana 图表类型设置成 table 后，再将查询的格式设置成 Table，显示如下，有以下几个问题：</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20241210104651576.png" alt="image.png|918"></p><h2 id="整合多个查询在一张表里面"><a href="#整合多个查询在一张表里面" class="headerlink" title="整合多个查询在一张表里面"></a>整合多个查询在一张表里面</h2><p>现在显示的是 3 个查询，通过一个选框来切换的，我们想要让这 3 个查询显示在一个框中，可以在 Grafana 的 <code>Transform data</code> 中增加一个 <code>Join by field</code>， 我这里以 instance 这个字段做关联，也就是说同样的 instance 认为是一条数据。可以看到展示出来只有一条数据了，并且选框没有了。<br><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20241210104917046.png" alt="image.png|970"></p><h2 id="移除不想展示的字段"><a href="#移除不想展示的字段" class="headerlink" title="移除不想展示的字段"></a>移除不想展示的字段</h2><p>上面可以看到数据已经被关联成了一条，但是有很多不想显示的字段，在 <code>Transform data</code> 中增加一个 <code>Organize fields by name</code>，经过调整后</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20241210105622474.png" alt="image.png|937"></p><h2 id="修改字段单位"><a href="#修改字段单位" class="headerlink" title="修改字段单位"></a>修改字段单位</h2><p>上面的运行时间，单位是秒，需要调整一下单位，在 Override 中调整：</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20241210105842096.png" alt="image.png|1008"></p><h2 id="给表格分配颜色"><a href="#给表格分配颜色" class="headerlink" title="给表格分配颜色"></a>给表格分配颜色</h2><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/20241223164145064.png" alt="image.png|1051"></p><p>这里的 unit 单位是 percent 0-1 所以下面的阈值也应该设置为 0-1 之间，比如超过 95% 设置成红色，超过 80% 设置成黄色。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;选择一个关联标签&quot;&gt;&lt;a href=&quot;#选择一个关联标签&quot; class=&quot;headerlink&quot; title=&quot;选择一个关联标签&quot;&gt;&lt;/a&gt;选择一个关联标签&lt;/h2&gt;&lt;p&gt;&lt;code&gt;instance&lt;/code&gt; 是机器 ip，不会重复，所以我用这个做关联字段。&lt;br&gt;第一个查询我会保留多一些标签，（可以使用 &lt;code&gt;sum by ... (instance)&lt;/code&gt;</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="grafana" scheme="https://zahui.fan/tags/grafana/"/>
    
  </entry>
  
  <entry>
    <title>使用RedisShake进行Redis迁移</title>
    <link href="https://zahui.fan/posts/lmojvw5l/"/>
    <id>https://zahui.fan/posts/lmojvw5l/</id>
    <published>2024-12-02T04:51:47.000Z</published>
    <updated>2024-12-31T03:52:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>对于自建的 redis, 我们可以将 rdb&#x2F;aof 文件拷贝到目的 redis, 启动恢复, 但是云 redis 或者某些特殊情况, 比如没有云平台的权限等等情况, 可以使用工具来进行迁移.</p><p>RedisShake 是阿里云 Tair 团队 积极维护的一个项目。它的演变可以追溯到其初始版本，该版本是从 redis-port 分支出来的。官方文档<a href="https://tair-opensource.github.io/RedisShake/zh/guide/introduction.html">https://tair-opensource.github.io/RedisShake/zh/guide/introduction.html</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/tair-opensource/RedisShake/releases/download/v4.0.0/redis-shake-linux-amd64.tar.gz</span><br><span class="line">tar xf redis-shake-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h2 id="同步迁移"><a href="#同步迁移" class="headerlink" title="同步迁移"></a>同步迁移</h2><p>创建一个配置文件 <code>redis_sync.toml</code></p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[sync_reader]</span></span><br><span class="line"><span class="attr">cluster</span> = <span class="literal">false</span>            <span class="comment"># 是否为集群</span></span><br><span class="line"><span class="attr">address</span> = <span class="string">&quot;127.0.0.1:6379&quot;</span></span><br><span class="line"><span class="attr">username</span> = <span class="string">&quot;&quot;</span>              <span class="comment"># keep empty if not using ACL</span></span><br><span class="line"><span class="attr">password</span> = <span class="string">&quot;&quot;</span>              <span class="comment"># keep empty if no authentication is required</span></span><br><span class="line"><span class="attr">tls</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="section">[redis_writer]</span></span><br><span class="line"><span class="attr">cluster</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">address</span> = <span class="string">&quot;127.0.0.1:6380&quot;</span></span><br><span class="line"><span class="attr">username</span> = <span class="string">&quot;&quot;</span>              <span class="comment"># keep empty if not using ACL</span></span><br><span class="line"><span class="attr">password</span> = <span class="string">&quot;&quot;</span>              <span class="comment"># keep empty if no authentication is required</span></span><br><span class="line"><span class="attr">tls</span> = <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>执行迁移操作, 命令会在后台进行监听, 同步 redis 的变化, 迁移完成再关闭此服务.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-shake ./redis_sync.toml</span><br></pre></td></tr></table></figure><h2 id="使用-RDB-文件迁移"><a href="#使用-RDB-文件迁移" class="headerlink" title="使用 RDB 文件迁移"></a>使用 RDB 文件迁移</h2><p>先在源 redis 导出 rdb 文件, 上传到一台 linux 机器 (可以访问目标 redis), 然后执行迁移.</p><p>配置文件:</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[rdb_reader]</span></span><br><span class="line"><span class="attr">filepath</span> = <span class="string">&quot;/tmp/dump.rdb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[redis_writer]</span></span><br><span class="line"><span class="attr">cluster</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">address</span> = <span class="string">&quot;127.0.0.1:6380&quot;</span></span><br><span class="line"><span class="attr">username</span> = <span class="string">&quot;&quot;</span>              <span class="comment"># keep empty if not using ACL</span></span><br><span class="line"><span class="attr">password</span> = <span class="string">&quot;&quot;</span>              <span class="comment"># keep empty if no authentication is required</span></span><br><span class="line"><span class="attr">tls</span> = <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>执行迁移操作:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-shake ./redis_sync.toml</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;对于自建的 redis, 我们可以将 rdb&amp;#x2F;aof 文件拷贝到目的 redis, 启动恢复, 但是云 redis 或者某些特殊情况, 比如没有云平台的权限等等情况, 可以使用工具来进行迁移.&lt;/p&gt;
&lt;p&gt;RedisShake 是阿里云 Tair 团队 积极维护的一个项目。它的演变可以追溯到其初始版本，该版本是从 redis-port 分支出来的。官方文档&lt;a</summary>
        
      
    
    
    
    <category term="数据库" scheme="https://zahui.fan/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="数据迁移" scheme="https://zahui.fan/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    
    <category term="redis" scheme="https://zahui.fan/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch索引生命周期配置</title>
    <link href="https://zahui.fan/posts/snui2r/"/>
    <id>https://zahui.fan/posts/snui2r/</id>
    <published>2024-12-02T02:40:03.000Z</published>
    <updated>2025-02-10T11:12:21.000Z</updated>
    
    <content type="html"><![CDATA[<p>参考<br><a href="https://www.cnblogs.com/feifuzeng/p/13563430.html">https://www.cnblogs.com/feifuzeng/p/13563430.html</a><br><a href="https://blog.csdn.net/feiying0canglang/article/details/129789161">https://blog.csdn.net/feiying0canglang/article/details/129789161</a></p><p>这里以 <code>Elasticsearch 7.17.14</code> 为例，7.8 版本之前与之后有一点区别。7.8 之后的 API 是：<code>_index_template</code>，7.8 之前的命令是：<code>_template</code></p><h2 id="设置索引模板"><a href="#设置索引模板" class="headerlink" title="设置索引模板"></a>设置索引模板</h2><p>模板是为了让创建的索引按照一定的规则，比如索引按天分割，手动给每个索引做配置太麻烦</p><h2 id="创建生命周期策略"><a href="#创建生命周期策略" class="headerlink" title="创建生命周期策略"></a>创建生命周期策略</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置ingress日志保留14天，超过14天删除。</span></span><br><span class="line">PUT _ilm/policy/ingress-log-retention-policy</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;policy&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;phases&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;hot&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;actions&quot;</span>: &#123;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;delete&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;min_age&quot;</span>: <span class="string">&quot;14d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;actions&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;delete&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="创建索引模板"><a href="#创建索引模板" class="headerlink" title="创建索引模板"></a>创建索引模板</h2><p>索引模板引用上面创建的生命周期策略</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建索引模板，保证新创建的索引都应用这个模板</span></span><br><span class="line">PUT /_index_template/ingress-log-template</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;index_patterns&quot;</span>: [<span class="string">&quot;ingress-*&quot;</span>],</span><br><span class="line">  <span class="string">&quot;template&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;index.lifecycle.name&quot;</span>: <span class="string">&quot;ingress-log-retention-policy&quot;</span>,</span><br><span class="line">      <span class="string">&quot;index.lifecycle.rollover_alias&quot;</span>: <span class="string">&quot;ingress-log-alias&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="检查是否生效"><a href="#检查是否生效" class="headerlink" title="检查是否生效"></a>检查是否生效</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询索引的ilm状态</span></span><br><span class="line">GET ingress-2024.12.01/_ilm/explain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询索引设置，比如查看是否绑定了ilm策略</span></span><br><span class="line">GET ingress-2024.12.01/_settings</span><br></pre></td></tr></table></figure><h2 id="修改系统配置"><a href="#修改系统配置" class="headerlink" title="修改系统配置"></a>修改系统配置</h2><p>Elasticsearch 不会实时检测，可以修改检测时间间隔</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群的设置</span></span><br><span class="line">GET /_cluster/settings</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置检查时间为60s</span></span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;indices.lifecycle.poll_interval&quot;</span>:<span class="string">&quot;60s&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="手动修改现存的索引"><a href="#手动修改现存的索引" class="headerlink" title="手动修改现存的索引"></a>手动修改现存的索引</h2><p>因为我们创建了索引模板，只能在下次创建新索引才能生效，老索引需要手动绑定到策略上。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动修改索引绑定的ilm策略</span></span><br><span class="line">PUT ingress-2024.12.01/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;index&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;lifecycle.name&quot;</span>: <span class="string">&quot;ingress-log-retention-policy&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="对于-logstash"><a href="#对于-logstash" class="headerlink" title="对于 logstash"></a>对于 logstash</h2><p>logstash 会创建自己的默认 template，所以想要应用 template 需要禁用 logstash 的 template</p><p><code>logstash.conf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; &quot;10.10.10.10:9092,10.10.10.11:9092,10.10.10.12:9092&quot;</span><br><span class="line">    topics =&gt; [&quot;ingress-k8s&quot;]</span><br><span class="line">    codec =&gt; &quot;json&quot;</span><br><span class="line">    consumer_threads =&gt; 3</span><br><span class="line">    group_id =&gt; &quot;k8s_group&quot;</span><br><span class="line">    decorate_events =&gt; true</span><br><span class="line">    type =&gt; &quot;logstash_mixins&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">    mutate&#123;</span><br><span class="line">        rename =&gt; [&quot;[host][name]&quot;, &quot;hostname&quot;]</span><br><span class="line">        remove_field =&gt; [&quot;ecs&quot;,&quot;@version&quot;,&quot;input&quot;,&quot;host&quot;,&quot;agent&quot;,&quot;log&quot;]</span><br><span class="line">        convert =&gt; &#123;</span><br><span class="line">          &quot;status&quot; =&gt; &quot;integer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  if [type] == &quot;logstash_mixins&quot; &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">          action   =&gt; &quot;index&quot;</span><br><span class="line">          manage_template =&gt; false</span><br><span class="line">          hosts    =&gt; [&quot;http://10.10.10.21:9200&quot;,&quot;http://10.10.10.22:9200&quot;,&quot;http://10.10.10.23:9200&quot;]</span><br><span class="line">          index    =&gt; &quot;%&#123;[fields][type]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">          user     =&gt; &quot;elastic&quot;</span><br><span class="line">          password =&gt; &quot;password&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要在 output 中添加一行：<code>manage_template =&gt; false</code></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;参考&lt;br&gt;&lt;a href=&quot;https://www.cnblogs.com/feifuzeng/p/13563430.html&quot;&gt;https://www.cnblogs.com/feifuzeng/p/13563430.html&lt;/a&gt;&lt;br&gt;&lt;a</summary>
        
      
    
    
    
    <category term="日志" scheme="https://zahui.fan/categories/%E6%97%A5%E5%BF%97/"/>
    
    
    <category term="常用操作" scheme="https://zahui.fan/tags/%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/"/>
    
    <category term="ES" scheme="https://zahui.fan/tags/ES/"/>
    
  </entry>
  
  <entry>
    <title>在Windows中使用msys来运行linux命令</title>
    <link href="https://zahui.fan/posts/snrcqh/"/>
    <id>https://zahui.fan/posts/snrcqh/</id>
    <published>2024-11-30T09:51:53.000Z</published>
    <updated>2024-11-30T14:34:21.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="为什么不用-WSL"><a href="#为什么不用-WSL" class="headerlink" title="为什么不用 WSL"></a>为什么不用 WSL</h2><p>主要原因有以下几点：</p><ol><li>WSL 访问 Windows 的路径和原生 Windows 不一致，需要手动或者 <code>wslpath</code> 命令来转换</li><li>在 Windows 的命令行运行 wsl 命令的时候，需要通过 <code>wsl &lt;linux命令&gt;</code> 这种方式来实现，并不是原生的 Windows 命令写法。</li><li>WSL 启动耗时问题（倒还好，影响不大。）</li></ol><h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><p>官网地址：<a href="https://www.msys2.org/">https://www.msys2.org/</a><br>安装直接下一步下一步即可。</p><blockquote><p>不同的启动器之间的区别请看：<a href="https://www.msys2.org/docs/environments/">https://www.msys2.org/docs/environments/</a></p></blockquote><h2 id="增加环境变量"><a href="#增加环境变量" class="headerlink" title="增加环境变量"></a>增加环境变量</h2><p>或者 win + R 输入 <code>sysdm.cpl</code> 点击 高级 环境变量 进入环境变量配置界面：</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411302227697.png" alt="image.png"></p><p>一般来说建议修改用户变量里面的 PATH 即可，添加一个路径：<code>C:\msys64\usr\bin</code></p><p>然后就可以正常使用了。</p><h2 id="常用技巧"><a href="#常用技巧" class="headerlink" title="常用技巧"></a>常用技巧</h2><p>包管理使用的是 pacman ，使用文档可以看这里：<a href="https://www.msys2.org/docs/package-management/">https://www.msys2.org/docs/package-management/</a></p><p>比如安装 vim，可以执行 <code>pacman -S vim</code></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;为什么不用-WSL&quot;&gt;&lt;a href=&quot;#为什么不用-WSL&quot; class=&quot;headerlink&quot; title=&quot;为什么不用 WSL&quot;&gt;&lt;/a&gt;为什么不用 WSL&lt;/h2&gt;&lt;p&gt;主要原因有以下几点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;WSL 访问 Windows 的路径和原生 Windows 不一致，需要手动或者 &lt;code&gt;wslpath&lt;/code&gt;</summary>
        
      
    
    
    
    <category term="Windows" scheme="https://zahui.fan/categories/Windows/"/>
    
    
  </entry>
  
  <entry>
    <title>HTTPS的原理，使用HTTPS就一定是安全的吗？</title>
    <link href="https://zahui.fan/posts/sna41n/"/>
    <id>https://zahui.fan/posts/sna41n/</id>
    <published>2024-11-21T02:24:59.000Z</published>
    <updated>2024-11-29T04:26:41.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="HTTPS-是什么"><a href="#HTTPS-是什么" class="headerlink" title="HTTPS 是什么"></a>HTTPS 是什么</h2><p>以前一直以为 HTTPS 是一种与 HTTP 类似的应用层协议，后来才发现 HTTPS 并不是一种协议。https 只是在 URI 中作为 protocol identifier 罢了。HTTPS 其实是 HTTP Over TLS（ <a href="https://datatracker.ietf.org/doc/html/rfc2818">RFC2818</a> ）的简称，也就是运行在 TLS 协议上的 HTTP 协议，使用 TLS 协议对 HTTP 数据进行加密，从而保证了安全性。</p><h2 id="TLS-协议简介"><a href="#TLS-协议简介" class="headerlink" title="TLS 协议简介"></a>TLS 协议简介</h2><p>HTTPS 的核心就是 TLS 协议，那么 TLS 协议又是什么呢？TLS 的全称为 Transport Layer Security，也就是在传输层保证安全 <a href="https://tools.ietf.org/html/rfc5246">RFC5246</a>。主要分为以下四个协议：</p><ul><li><a href="https://tools.ietf.org/html/rfc5246#page-37">handshake protocol</a>，用来建立连接、身份认证、密钥协商</li><li><a href="https://tools.ietf.org/html/rfc5246#page-28">alert protocol</a>，用来关闭连接</li><li><a href="https://tools.ietf.org/html/rfc5246#page-27">change cipher spec protocol</a>，用来表示开始使用协商好的加密方式进行数据传输</li><li><a href="https://tools.ietf.org/html/rfc5246#page-65">application data protocol</a>，用来传输密文</li></ul><p>TLS 协议中最重要的就是 handshake 了，在握手阶段通信双方以安全的方式协商好用于之后数据传输的加密方式以及各种密钥。</p><h2 id="HTTPS-连接过程"><a href="#HTTPS-连接过程" class="headerlink" title="HTTPS 连接过程"></a>HTTPS 连接过程</h2><p>大家可能都听说过 HTTPS 协议之所以是安全的是因为 HTTPS 协议会对传输的数据进行加密，而加密过程是使用了非对称加密实现。但其实，HTTPS 在内容传输的加密上使用的是对称加密，非对称加密只作用在证书验证阶段。</p><p>HTTPS 的整体过程分为证书验证和数据传输阶段，具体的交互过程如下：</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211110422.webp" alt="41ac7d0df61046f0ab518fba866838dd.webp"></p><h3 id="客户端请求建立连接"><a href="#客户端请求建立连接" class="headerlink" title="客户端请求建立连接"></a>客户端请求建立连接</h3><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211139023.png" alt="image.png"></p><p>客户端首先要向服务器请求建立一个安全连接。需要发送给服务器的必要信息有：</p><ul><li>TLS 协议版本。</li><li>Cipher Suites。由于双方对一些加密算法的支持程度可能不同，客户端需要将它支持的加密方法发送给服务器，以供服务器进行选择。</li><li>Session ID。如果提供的话，表示使用前一个会话中已协商好的密钥，而无需再次协商。</li><li>Random。客户端生成的随机值，用来生成 <code>Master Secret</code>。</li><li>server_name extension。表示访问的是哪个网站。</li></ul><h3 id="服务器确定加密套件"><a href="#服务器确定加密套件" class="headerlink" title="服务器确定加密套件"></a>服务器确定加密套件</h3><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211418010.png" alt="image.png"></p><p>服务器接收到建立连接的请求之后，要发送以下信息：</p><ul><li>TLS 协议版本。</li><li>Cipher Suite。从客户端提供的可选加密方式中选择一个。</li><li>Session ID。本次会话的 ID。</li><li>Random。随机生成的值，用来生成 <code>Master Secret</code>。</li></ul><h3 id="服务器发送证书"><a href="#服务器发送证书" class="headerlink" title="服务器发送证书"></a>服务器发送证书</h3><p>在发送 <code>Server Hello</code> 之后，服务器还需要把其证书通过 <code>Certificate</code> 发给客户端。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211418690.png" alt="image.png"></p><p>证书的作用在 <a href="https://yieldnull.com/blog/001efdfe76e6f4f672faf785dff1cc54e4fd26ba/">“用数字证书证明你是你”</a> 一文中已经阐明。</p><p>要是之前确定的加密套件中的秘钥交换算法还需要一些额外的信息，那么服务器还会发送一个 <code>Server Key Exchange</code>，用来传递额外的信息。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211419536.png" alt="image.png"></p><h3 id="双方完成身份认证"><a href="#双方完成身份认证" class="headerlink" title="双方完成身份认证"></a>双方完成身份认证</h3><p>（如果服务器要认证客户端的身份，那么会发送一个 <code>Certificate Request</code> 来向客户端请求证书，客户端收到请求之后会发送 <code>Certificate</code> 给服务器）</p><p>最后，（确认客户端身份之后）服务器发送 <code>Server Done</code> 表示我想知道的都已经知道了，该发的也发给你了。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211419375.png" alt="image.png"></p><h3 id="生成密钥"><a href="#生成密钥" class="headerlink" title="生成密钥"></a>生成密钥</h3><p>通过之前的步骤，通信双方认证了对方的身份，明确了加密套件，现在就缺加密密钥了。</p><p>此时，客户端会生成一个 <code>premaster secret</code>，并用服务器证书中的公钥进行加密，然后通过 <code>Client Key Exchange</code> 发送给服务器。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211420975.png" alt="image.png"></p><p>同时，客户端会在本地使用 <code>premaster secret</code>，以及之前在 <code>Hello</code> 阶段双方生成的两个随机数，生成最终的 <code>master secret</code></p><p>服务器收到 <code>Client Key Exchange</code> 之后，使用其私钥解密出 <code>premaster secret</code>。然后使用与客户端相同的方式，生成与客户端相同的 <code>master secret</code>。</p><h3 id="通知开始加密传输"><a href="#通知开始加密传输" class="headerlink" title="通知开始加密传输"></a>通知开始加密传输</h3><p>当双方都得到 <code>master secret</code> 之后，就会发送 <code>Change Cipher Spec</code> 通知对方：我开始用之前商量好的加密方式以及密钥传输数据了。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211420400.png" alt="image.png"></p><h3 id="确保密钥可用"><a href="#确保密钥可用" class="headerlink" title="确保密钥可用"></a>确保密钥可用</h3><p>为了确保之前的协商的确是成功了，双方还需要确认一下双方使用的密钥是不是一致的。怎么确认呢？那就把从 <code>Client Hello</code> 以来握手过程中双方通信的所有信息加密之后，再给对方发送一遍。要是对方发过来的信息解密之后与自己记录的相同，则表示密钥生效了！<br><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211420778.png" alt="image.png"></p><h3 id="加密套件与密钥"><a href="#加密套件与密钥" class="headerlink" title="加密套件与密钥"></a>加密套件与密钥</h3><p>上一节仅介绍了握手的流程，现在来仔细看看其中涉及到的加密套件（<a href="https://en.wikipedia.org/wiki/Cipher_suite">Cipher_suite</a>）与 <code>master secret</code>。</p><h3 id="加密套件"><a href="#加密套件" class="headerlink" title="加密套件"></a>加密套件</h3><p>加密套件定义的是在整个数据传输过程中使用到的加密方式。以 <code>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code> 为例，其包含以下算法</p><ul><li><strong>密钥交换算法</strong>。用来交换密钥。例如 <code>ECDHE_RSA</code></li><li><strong>对称加密算法</strong>。用来加密信息。例如 <code>AES_128_GCM</code></li><li><strong>信息摘要算法</strong>。用来计算摘要，防止篡改。例如 <code>SHA256</code></li><li><strong>伪随机函数</strong>。生成 <code>master secret</code>。要用到信息摘要算法。</li></ul><h3 id="master-secret"><a href="#master-secret" class="headerlink" title="master secret"></a>master secret</h3><p>上一节提到，客户端与服务器会根据 <code>premaster secret</code> 以及二者在 <code>Hello</code> 阶段各自生成的随机数，产生相同的 <code>master secret</code>。二者使用的函数为</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211421527.png" alt="image.png"></p><p>至于生成的 <code>master secret</code>，其格式为</p><blockquote><p>client write MAC key server write MAC key client write encryption key server write encryption key client write IV server write IV</p></blockquote><p>前两个是计算摘要用的 KEY，中间两个是加密时用的，最后两个适用于加密套件使用 <code>AEAD</code> 时。</p><h3 id="总结下连接过程"><a href="#总结下连接过程" class="headerlink" title="总结下连接过程"></a>总结下连接过程</h3><p><strong>① 证书验证阶段</strong></p><ol><li>浏览器发起 HTTPS 请求</li><li>服务端返回 HTTPS 证书</li><li>客户端验证证书是否合法，如果不合法则提示告警</li></ol><p><strong>② 数据传输阶段</strong></p><ol><li>当证书验证合法后，在本地生成随机数</li><li>通过公钥加密随机数，并把加密后的随机数传输到服务端</li><li>服务端通过私钥对随机数进行解密</li><li>服务端通过客户端传入的随机数构造对称加密算法，对返回结果内容进行加密后传输</li></ol><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="为什么数据传输是用对称加密？"><a href="#为什么数据传输是用对称加密？" class="headerlink" title="为什么数据传输是用对称加密？"></a>为什么数据传输是用对称加密？</h3><p>首先，非对称加密的加解密效率是非常低的，而 http 的应用场景中通常端与端之间存在大量的交互，非对称加密的效率是无法接受的；</p><p>另外，在 HTTPS 的场景中只有服务端保存了私钥，一对公私钥只能实现单向的加解密，所以 HTTPS 中内容传输加密采取的是对称加密，而不是非对称加密。</p><h3 id="为什么需要-CA-认证机构颁发证书？"><a href="#为什么需要-CA-认证机构颁发证书？" class="headerlink" title="为什么需要 CA 认证机构颁发证书？"></a>为什么需要 CA 认证机构颁发证书？</h3><p>HTTP 协议被认为不安全是因为传输过程容易被监听者勾线监听、伪造 <a href="https://cloud.tencent.com/product/cvm/?from_column=20065&from=20065">服务器</a>，而 HTTPS 协议主要解决的便是网络传输的安全性问题。</p><p>首先我们假设不存在认证机构，任何人都可以制作证书，这带来的安全风险便是经典的 <strong>“中间人攻击”</strong> 问题。</p><p>“中间人攻击”的具体过程如下：</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211111399.webp" alt="f35348523dd744408647d2b97d2534c6.webp"></p><p>过程原理：</p><ol><li>本地请求被劫持（如 DNS 劫持等），所有请求均发送到中间人的服务器</li><li>中间人服务器返回中间人自己的证书</li><li>客户端创建随机数，通过中间人证书的公钥对随机数加密后传送给中间人，然后凭随机数构造对称加密对传输内容进行加密传输</li><li>中间人因为拥有客户端的随机数，可以通过对称加密算法进行内容解密</li><li>中间人以客户端的请求内容再向正规网站发起请求</li><li>因为中间人与服务器的通信过程是合法的，正规网站通过建立的安全通道返回加密后的数据</li><li>中间人凭借与正规网站建立的对称加密算法对内容进行解密</li><li>中间人通过与客户端建立的对称加密算法对正规内容返回的数据进行加密传输</li><li>客户端通过与中间人建立的对称加密算法对返回结果数据进行解密</li></ol><p>由于缺少对证书的验证，所以客户端虽然发起的是 HTTPS 请求，但客户端完全不知道自己的网络已被拦截，传输内容被中间人全部窃取。</p><h3 id="浏览器是如何确保-CA-证书的合法性？"><a href="#浏览器是如何确保-CA-证书的合法性？" class="headerlink" title="浏览器是如何确保 CA 证书的合法性？"></a>浏览器是如何确保 CA 证书的合法性？</h3><h4 id="1-证书包含什么信息？"><a href="#1-证书包含什么信息？" class="headerlink" title="1. 证书包含什么信息？"></a>1. 证书包含什么信息？</h4><ul><li>颁发机构信息</li><li>公钥</li><li>公司信息</li><li>域名</li><li>有效期</li><li>指纹</li><li>……</li></ul><h4 id="2-证书的合法性依据是什么？"><a href="#2-证书的合法性依据是什么？" class="headerlink" title="2. 证书的合法性依据是什么？"></a>2. 证书的合法性依据是什么？</h4><p>首先，权威机构是要有认证的，不是随便一个机构都有资格颁发证书，不然也不叫做权威机构。另外，证书的可信性基于信任制，权威机构需要对其颁发的证书进行信用背书，只要是权威机构生成的证书，我们就认为是合法的。所以权威机构会对申请者的信息进行审核，不同等级的权威机构对审核的要求也不一样，于是证书也分为免费的、便宜的和贵的。</p><h4 id="3-浏览器如何验证证书的合法性？"><a href="#3-浏览器如何验证证书的合法性？" class="headerlink" title="3. 浏览器如何验证证书的合法性？"></a>3. 浏览器如何验证证书的合法性？</h4><p>浏览器发起 HTTPS 请求时，服务器会返回网站的 SSL 证书，浏览器需要对证书做以下验证：</p><ol><li>验证域名、有效期等信息是否正确。证书上都有包含这些信息，比较容易完成验证；</li><li>判断证书来源是否合法。每份签发证书都可以根据验证链查找到对应的根证书，操作系统、浏览器会在本地存储权威机构的根证书，利用本地根证书可以对对应机构签发证书完成来源验证；</li></ol><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211112715.webp" alt="e7d864735b9d4ff9a42e761bd44ce513.webp"></p><ol><li>判断证书是否被篡改。需要与 CA 服务器进行校验；</li><li>判断证书是否已吊销。通过 CRL（Certificate Revocation List 证书注销列表）和 OCSP（Online Certificate Status Protocol 在线证书状态协议）实现，其中 OCSP 可用于第 3 步中以减少与 CA 服务器的交互，提高验证效率</li></ol><p>以上任意一步都满足的情况下浏览器才认为证书是合法的。</p><blockquote><p>这里插一个我想了很久的但其实答案很简单的问题：  既然证书是公开的，如果要发起中间人攻击，我在官网上下载一份证书作为我的服务器证书，那客户端肯定会认同这个证书是合法的，如何避免这种证书冒用的情况？ 其实这就是非加密对称中公私钥的用处，虽然中间人可以得到证书，但私钥是无法获取的，一份公钥是不可能推算出其对应的私钥，中间人即使拿到证书也无法伪装成合法服务端，因为无法对客户端传入的加密数据进行解密。</p></blockquote><h4 id="4-只有认证机构可以生成证书吗？"><a href="#4-只有认证机构可以生成证书吗？" class="headerlink" title="4. 只有认证机构可以生成证书吗？"></a>4. 只有认证机构可以生成证书吗？</h4><p>如果需要浏览器不提示安全风险，那只能使用认证机构签发的证书。但浏览器通常只是提示安全风险，并不限制网站不能访问，所以从技术上谁都可以生成证书，只要有证书就可以完成网站的 HTTPS 传输。例如早期的 12306 采用的便是手动安装私有证书的形式实现 HTTPS 访问。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411211112378.png" alt="1e9f4c5925fc4929804b8a1bc94cdd87.png"></p><p><strong>如何保证随机数不会被窃取？</strong></p><p>其实 HTTPS 并不包含对随机数的安全保证，HTTPS 保证的只是传输过程安全，而随机数存储于本地，本地的安全属于另一安全范畴，应对的措施有安装杀毒软件、反木马、浏览器升级修复漏洞等。</p><h3 id="用了-HTTPS-会被抓包吗？"><a href="#用了-HTTPS-会被抓包吗？" class="headerlink" title="用了 HTTPS 会被抓包吗？"></a>用了 HTTPS 会被抓包吗？</h3><p>HTTPS 的数据是加密的，常规下抓包工具代理请求后抓到的包内容是加密状态，无法直接查看。</p><p>但是，正如前文所说，浏览器只会提示安全风险，如果用户授权仍然可以继续访问网站，完成请求。因此，只要客户端是我们自己的终端，我们授权的情况下，便可以组建中间人网络，而抓包工具便是作为中间人的代理。通常 HTTPS 抓包工具的使用方法是会生成一个证书，用户需要手动把证书安装到客户端中，然后终端发起的所有请求通过该证书完成与抓包工具的交互，然后抓包工具再转发请求到服务器，最后把服务器返回的结果在控制台输出后再返回给终端，从而完成整个请求的闭环。</p><p><strong>既然 HTTPS 不能防抓包，那 HTTPS 有什么意义？</strong>  HTTPS 可以防止用户在不知情的情况下通信链路被监听，对于主动授信的抓包操作是不提供防护的，因为这个场景用户是已经对风险知情。要防止被抓包，需要采用应用级的安全防护，例如采用私有的对称加密，同时做好移动端的防反编译加固，防止本地算法被破解。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以下用简短的 Q&amp;A 形式进行全文总结：</p><p>Q: HTTPS 为什么安全？ </p><p>A: 因为 HTTPS 保证了传输安全，防止传输过程被监听、防止数据被窃取，可以确认网站的真实性。</p><p>Q: HTTPS 的传输过程是怎样的？ </p><p>A: 客户端发起 HTTPS 请求，服务端返回证书，客户端对证书进行验证，验证通过后本地生成用于改造对称加密算法的随机数，通过证书中的公钥对随机数进行加密传输到服务端，服务端接收后通过私钥解密得到随机数，之后的数据交互通过对称加密算法进行加解密。</p><p>Q: 为什么需要证书？ </p><p>A: 防止”中间人“攻击，同时可以为网站提供身份证明。</p><p>Q: 使用 HTTPS 会被抓包吗？ </p><p>A: 会被抓包，HTTPS 只防止用户在不知情的情况下通信被监听，如果用户主动授信，是可以构建“中间人”网络，代理软件可以对传输内容进行解密。</p><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><ul><li><a href="https://tools.ietf.org/html/rfc2818">HTTP Over TLS. RFC2818</a></li><li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa380513%28v=vs.85%29.aspx">TLS Handshake Protocol</a></li><li><a href="http://www.moserware.com/2009/06/first-few-milliseconds-of-https.html">The First Few Milliseconds of an HTTPS Connection</a></li><li><a href="https://segmentfault.com/a/1190000002554673">SSL&#x2F;TLS原理详解</a></li><li><a href="https://www.wosign.com/faq/faq2016-0309-04.htm">TLS&#x2F;SSL握手过程</a></li><li><a href="http://blog.csdn.net/dog250/article/details/5717162">ssl协议中的dh算法的pre-master-secret</a></li><li><a href="https://en.wikipedia.org/wiki/Cipher_suite">Cipher_suite</a></li><li><a href="https://yieldnull.com/blog/001efdfe76e6f4f672faf785dff1cc54e4fd26ba/">用数字证书证明你是你</a></li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;HTTPS-是什么&quot;&gt;&lt;a href=&quot;#HTTPS-是什么&quot; class=&quot;headerlink&quot; title=&quot;HTTPS 是什么&quot;&gt;&lt;/a&gt;HTTPS 是什么&lt;/h2&gt;&lt;p&gt;以前一直以为 HTTPS 是一种与 HTTP 类似的应用层协议，后来才发现 HTTPS 并不是一种协议。https 只是在 URI 中作为 protocol identifier 罢了。HTTPS</summary>
        
      
    
    
    
    <category term="基础运维" scheme="https://zahui.fan/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="加密" scheme="https://zahui.fan/tags/%E5%8A%A0%E5%AF%86/"/>
    
    <category term="tls" scheme="https://zahui.fan/tags/tls/"/>
    
    <category term="https" scheme="https://zahui.fan/tags/https/"/>
    
    <category term="SSL" scheme="https://zahui.fan/tags/SSL/"/>
    
  </entry>
  
  <entry>
    <title>生产环境Prometheus监控架构记录</title>
    <link href="https://zahui.fan/posts/sn6pu2/"/>
    <id>https://zahui.fan/posts/sn6pu2/</id>
    <published>2024-11-19T06:25:14.000Z</published>
    <updated>2024-11-29T04:26:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>比如有 30 家客户，每一个客户都有自己的 Kubernetes 集群，部署方式千差万别，还有客户不使用 Kubernetes 的，使用虚拟机部署，那么怎么对这么多客户的机器、服务进行有效的监控，本文记录一下监控的架构方案。</p><h2 id="监控架构图"><a href="#监控架构图" class="headerlink" title="监控架构图"></a>监控架构图</h2><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411201501698.png"></p><p>说明：<br>Prometheus Core 是一个核心的 Prometheus，所有其他 Prometheus 的数据都汇总到这里，查询、告警等都使用这个 Prometheus</p><h2 id="Prometheus-Core"><a href="#Prometheus-Core" class="headerlink" title="Prometheus Core"></a>Prometheus Core</h2><p>这个是核心的 Prometheus，其他客户的 Prometheus 通过联邦接入或者 远程写 (remote write) 的方式来写入数据到这个 Prometheus 中。Prometheus Core 可以更换成 <a href="/posts/e59d8e32">VictoriaMetrics</a></p><h3 id="联邦接入配置"><a href="#联邦接入配置" class="headerlink" title="联邦接入配置"></a>联邦接入配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http 接口联邦</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;federate-http&#x27;</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">&#x27;/federate&#x27;</span></span><br><span class="line">  <span class="attr">basic_auth:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&#x27;password&#x27;</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="string">&#x27;match[]&#x27;</span><span class="string">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#123;job=~&quot;.+&quot;&#125;&#x27;</span></span><br><span class="line">  <span class="attr">file_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/data/prometheus/conf.d/federate_http.yml</span></span><br><span class="line">      <span class="attr">refresh_interval:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https 接口联邦</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;federate-https&#x27;</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">&#x27;/federate&#x27;</span></span><br><span class="line">  <span class="attr">basic_auth:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&#x27;password&#x27;</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="string">&#x27;match[]&#x27;</span><span class="string">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#123;job=~&quot;.+&quot;&#125;&#x27;</span></span><br><span class="line">  <span class="attr">file_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/data/prometheus/conf.d/federate_https.yml</span></span><br><span class="line">      <span class="attr">refresh_interval:</span> <span class="string">1m</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>对应的 <code>federate_http.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.252</span><span class="number">.0</span><span class="number">.250</span><span class="string">:9090</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">    <span class="attr">k8s:</span> <span class="string">k8s-test</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;prometheus&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.249</span><span class="number">.48</span><span class="number">.250</span><span class="string">:9090</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">&quot;prod&quot;</span></span><br><span class="line">    <span class="attr">k8s:</span> <span class="string">k8s-prod</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;prometheus&quot;</span></span><br></pre></td></tr></table></figure><h3 id="远程写入配置"><a href="#远程写入配置" class="headerlink" title="远程写入配置"></a>远程写入配置</h3><p>修改 Prometheus 启动参数，增加：<code>--enable-feature=remote-write-receiver</code> 启动参数。</p><h2 id="Kubernetes-中部署有集群权限的-Prometheus"><a href="#Kubernetes-中部署有集群权限的-Prometheus" class="headerlink" title="Kubernetes 中部署有集群权限的 Prometheus"></a>Kubernetes 中部署有集群权限的 Prometheus</h2><p>适合有集群权限的 Prometheus,可以创建 serviceaccount 和 clusterrole clusterrolebinding 资源才可以自动发现</p><p>参考 Prometheus 官方 GitHub 上的配置文件 <a href="https://github.com/prometheus/prometheus/blob/main/documentation/examples/rbac-setup.yml">https://github.com/prometheus/prometheus/blob/main/documentation/examples/rbac-setup.yml</a></p><p>完整的配置如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">&quot;/metrics&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">prom/prometheus:v2.34.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/bin/prometheus&quot;</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.retention=24h&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--web.enable-lifecycle&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">&quot;/prometheus&quot;</span></span><br><span class="line">        <span class="comment"># 这种方式挂载，会将原始目录整个挂载，也就是看不到原始的文件了。</span></span><br><span class="line">        <span class="comment"># - name: prometheus-config</span></span><br><span class="line">        <span class="comment">#   mountPath: /etc/prometheus</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span>                <span class="comment"># volumes的名字</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/prometheus.yml</span>     <span class="comment"># 容器内的目录</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">prometheus.yml</span>                       <span class="comment"># 指定configmap里面的key</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span>                <span class="comment"># volumes的名字</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/web.yml</span>     <span class="comment"># 容器内的目录</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">web.yml</span>                       <span class="comment"># 指定configmap里面的key</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># type: NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">    <span class="comment"># nodePort: 30090</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">prometheus.i.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">i-com</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">prometheus.i.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure><p><code>configmap.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">web.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    basic_auth_users:</span></span><br><span class="line"><span class="string">      admin: $2y$05$UKSS18ztdsUNoEuXYScr2OE1TCMe1hWnmD6JuwUi/uPTJayHIakae</span></span><br><span class="line"><span class="string"></span>  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval:     15s</span></span><br><span class="line"><span class="string">      evaluation_interval: 15s</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      # 全局标签</span></span><br><span class="line"><span class="string">      external_labels:</span></span><br><span class="line"><span class="string">        env: prod</span></span><br><span class="line"><span class="string">        dept: ops</span></span><br><span class="line"><span class="string">        project: example</span></span><br><span class="line"><span class="string">        k8s: example</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;apiservers&#x27;</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;cadvisor&#x27;</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;kubelet&quot;</span></span><br><span class="line">        <span class="attr">honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">scrape_interval:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">scrape_timeout:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">          <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;service_endpoints_metrics&#x27;</span></span><br><span class="line">        <span class="comment"># service 需要添加元数据 通常需要有 /metrics 接口返回 prometheus 数据格式</span></span><br><span class="line">        <span class="comment"># prometheus.io/path: /metrics</span></span><br><span class="line">        <span class="comment"># prometheus.io/port: &quot;8080&quot;</span></span><br><span class="line">        <span class="comment"># prometheus.io/scrape: &quot;true&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 带注解  prometheus.io/scrape: true  的才会被采集，不然不采集，不入库</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>]</span><br><span class="line">          <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">          <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">          <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br></pre></td></tr></table></figure><blockquote><p>注：如果需要监控 pod 状态，比如 pod 重启次数等数据，需要安装 <code>kube-state-metrics</code> 并通过服务发现的方式将数据接入到 Prometheus</p></blockquote><h2 id="Kubernetes-中部署无集群权限的-Prometheus"><a href="#Kubernetes-中部署无集群权限的-Prometheus" class="headerlink" title="Kubernetes 中部署无集群权限的 Prometheus"></a>Kubernetes 中部署无集群权限的 Prometheus</h2><p>有的客户不给集群权限，比如一个大的 Kubernetes 集群中，给分配了一个 namespace，其他 namespace 是别人的服务，当然不能给你很高的权限，或者是个定制的控制界面，无法进行创建 serviceaccount 的操作等。这样只能监控一些基础的信息，比如 service 通不通（通过 service 地址来监控），监控一些中间件的监控数据（手动配置 exporter 的 service 地址）</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">30s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">prod</span></span><br><span class="line">    <span class="attr">dept:</span> <span class="string">ops</span></span><br><span class="line">    <span class="attr">project:</span> <span class="string">example</span></span><br><span class="line">    <span class="attr">k8s:</span> <span class="string">example</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;mysql_instance&quot;</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;mysql-exporter:9104&#x27;</span>]</span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prod_example_mysql</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;redis_instance&quot;</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;redis-exporter:9121&#x27;</span>]</span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prod_example_redis</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;port&quot;</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">20s</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">tcp_connect</span>]</span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;10.133.103.171:6379&#x27;</span>]</span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;10.133.103.170:3306&#x27;</span>]</span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">addr</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">(.+):(.*)</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">$2</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">port</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">&quot;blackbox-exporter:9115&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里手动配置的service请求地址</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;http_get&quot;</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">20s</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;prod-idk-mob-sdk-server:5003/actuator/info&#x27;</span>]</span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">idk-mob-sdk-server</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;prod-public-hsm-services:8007/hsm/actuator/health&#x27;</span>]</span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">public-hsm-services</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">&quot;blackbox-exporter:9115&quot;</span></span><br></pre></td></tr></table></figure><h2 id="虚拟机部署"><a href="#虚拟机部署" class="headerlink" title="虚拟机部署"></a>虚拟机部署</h2><p>类似于上面的 Kubernetes 中部署的无权限 Prometheus</p><h2 id="没有公网域名的-Prometheus"><a href="#没有公网域名的-Prometheus" class="headerlink" title="没有公网域名的 Prometheus"></a>没有公网域名的 Prometheus</h2><p>没有公网域名意味着无法通过 Prometheus Core 来拉取（联邦），可以使用 remote write 远程写的方式写入到目标的 Prometheus Core 中</p><p><code>vim prometheus.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">remote_write:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&quot;https://prometheus.example.com/api/v1/write&quot;</span></span><br><span class="line">  <span class="attr">basic_auth:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">  <span class="attr">remote_timeout:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">queue_config:</span></span><br><span class="line">    <span class="attr">capacity:</span> <span class="number">2000</span></span><br><span class="line">    <span class="attr">max_shards:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">min_shards:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">max_samples_per_send:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">batch_send_deadline:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">min_backoff:</span> <span class="string">30ms</span></span><br><span class="line">    <span class="attr">max_backoff:</span> <span class="string">100ms</span></span><br></pre></td></tr></table></figure><h3 id="远程写-Prometheus-自身挂掉如何监控"><a href="#远程写-Prometheus-自身挂掉如何监控" class="headerlink" title="远程写 Prometheus 自身挂掉如何监控"></a>远程写 Prometheus 自身挂掉如何监控</h3><p>使用 absent 函数来做判断 具体可以看 <a href="/posts/666e547f/">Prometheus通过remote_write写入数据到另一台Prometheus</a></p><h2 id="basicauth-认证"><a href="#basicauth-认证" class="headerlink" title="basicauth 认证"></a>basicauth 认证</h2><p>关于认证，可以看 <a href="/posts/165a0cd3/">Prometheus开启basic_auth认证</a></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;比如有 30 家客户，每一个客户都有自己的 Kubernetes 集群，部署方式千差万别，还有客户不使用 Kubernetes 的，使用虚拟机部署，那么怎么对这么多客户的机器、服务进行有效的监控，本文记录一下监控的架构方案。&lt;/p&gt;
&lt;h2 id=&quot;监控架构图&quot;&gt;&lt;a href=&quot;#监控架构图&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="prometheus" scheme="https://zahui.fan/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>使用snmp exporter对交换机、服务器等进行监控</title>
    <link href="https://zahui.fan/posts/smz2c9/"/>
    <id>https://zahui.fan/posts/smz2c9/</id>
    <published>2024-11-15T03:14:33.000Z</published>
    <updated>2024-11-29T04:26:41.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>到 GitHub 下载一个可执行文件，直接运行即可，或者使用 systemd 来运行，也可以直接部署到 Kubernetes 中。<br><a href="https://github.com/prometheus/snmp_exporter">https://github.com/prometheus/snmp_exporter</a></p><p>systemd 配置：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=snmp_exporter</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStart</span>=/opt/snmp_exporter/snmp_exporter --config.file=/opt/snmp_exporter/snmp.yml</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="交换机或服务器打开-snmp-协议"><a href="#交换机或服务器打开-snmp-协议" class="headerlink" title="交换机或服务器打开 snmp 协议"></a>交换机或服务器打开 snmp 协议</h2><p>这一步需要在交换机或服务器的 ipmi 上配置，交换机这种网络设备一般都只支持 snmp 协议来获取数据，比如说每个接口的状态（有没有插网线等）<br>对于服务器，像 cpu 占用率、内存使用率这些数据使用 node_exporter 就可以做，为啥还要使用 snmp_exporter 呢，snmp_exporter 可以做到一些底层的监控，比如说：风扇转速、电源是否有损坏的（一般服务器都有多个电源模块）、温度情况、磁盘阵列状态（是否有硬盘坏掉了，比如做了 raid1，坏了一块硬盘在软件层面是无感知的，但是需要及时更换硬盘了。）</p><p>打开 snmp 协议后，需要设置并记录一下团体名。</p><p>测试 snmp 命令示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">snmpwalk -v 2c -c 123456 100.200.1.254</span><br><span class="line">snmpwalk -v 2c -c 123456 172.18.48.5 1.3.6.1.2.1.47.1.1.1.1.7</span><br><span class="line">snmpwalk -v3 -u sysadmin -a MD5 -A rootuser -x DES -X rootuser -l authpriv 100.200.1.24</span><br></pre></td></tr></table></figure><h2 id="生成配置文件"><a href="#生成配置文件" class="headerlink" title="生成配置文件"></a>生成配置文件</h2><p>snmp exporter 开源软件中有个 snmp generator ，可以用于生成 snmp exporter 的配置文件。<br>配置文件中根据硬件的 MIB 文件生成了 OID 的映射关系。以 Cisco 交换机为例，在官方 GitHub 上下载最新的 <strong>snmp.yml</strong> 文件，由于 Cisco 交换机使用的是 if_mib 模块，在 if_mib 下新增 auth 配置，团体名要和交换机上配置的一致。<br>根据 mib 文件生成 yaml 配置文件工具：<a href="https://github.com/prometheus/snmp_exporter/tree/main/generator">https://github.com/prometheus/snmp_exporter/tree/main/generator</a><br>关于采集的监控项是在 walk 字段下，如果要新增监控项，写在 walk 项下。我新增了交换机的 CPU 和内存信息。官方示例中的 if_mib 这个是 module 名字， if_mib 是个网络设备的规范，RFC1573</p><h3 id="H3C-交换机配置示例"><a href="#H3C-交换机配置示例" class="headerlink" title="H3C 交换机配置示例"></a>H3C 交换机配置示例</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># WARNING: This file was auto-generated using snmp_exporter generator, manual changes will be lost.</span></span><br><span class="line"><span class="attr">H3C:</span></span><br><span class="line">  <span class="attr">walk:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span>                     <span class="comment">#端口描述</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span><span class="number">.8</span>                     <span class="comment">#端口状态 1up，2down</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span>                  <span class="comment">#端口名称</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.18</span>                 <span class="comment">#端口别名</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.2</span><span class="number">.40</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.5</span>      <span class="comment">#H3C端口进流量</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.2</span><span class="number">.40</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.6</span>      <span class="comment">#H3C端口出流量</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.18</span><span class="number">.4</span><span class="number">.3</span><span class="number">.1</span><span class="number">.13</span>      <span class="comment">#内存利用率</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.18</span><span class="number">.4</span><span class="number">.3</span><span class="number">.1</span><span class="number">.4</span>       <span class="comment">#CPU利用率</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.9</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span>        <span class="comment">#电源状态</span></span><br><span class="line">  <span class="attr">get:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span><span class="number">.0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.5</span><span class="number">.0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.18</span><span class="number">.1</span><span class="number">.1</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="comment"># 这里的name就是收集到的指标的名字</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sysDescr</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">A</span> <span class="string">textual</span> <span class="string">description</span> <span class="string">of</span> <span class="string">the</span> <span class="string">entity</span> <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sysUpTime</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">time</span> <span class="string">(in</span> <span class="string">hundredths</span> <span class="string">of</span> <span class="string">a</span> <span class="string">second)</span> <span class="string">since</span> <span class="string">the</span> <span class="string">network</span> <span class="string">management</span> <span class="string">portion</span></span><br><span class="line">      <span class="string">of</span> <span class="string">the</span> <span class="string">system</span> <span class="string">was</span> <span class="string">last</span> <span class="string">re-initialized.</span> <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sysName</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.5</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">An</span> <span class="string">administratively-assigned</span> <span class="string">name</span> <span class="string">for</span> <span class="string">this</span> <span class="string">managed</span> <span class="string">node</span> <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.5</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ifOperStatus</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span><span class="number">.8</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">current</span> <span class="string">operational</span> <span class="string">state</span> <span class="string">of</span> <span class="string">the</span> <span class="string">interface</span> <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span><span class="number">.8</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">lookups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">labelname:</span> <span class="string">ifAlias</span></span><br><span class="line">      <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.18</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">labelname:</span> <span class="string">ifDescr</span></span><br><span class="line">      <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">labelname:</span> <span class="string">ifName</span></span><br><span class="line">      <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">enum_values:</span></span><br><span class="line">      <span class="attr">1:</span> <span class="string">up</span></span><br><span class="line">      <span class="attr">2:</span> <span class="string">down</span></span><br><span class="line">      <span class="attr">3:</span> <span class="string">testing</span></span><br><span class="line">      <span class="attr">4:</span> <span class="string">unknown</span></span><br><span class="line">      <span class="attr">5:</span> <span class="string">dormant</span></span><br><span class="line">      <span class="attr">6:</span> <span class="string">notPresent</span></span><br><span class="line">      <span class="attr">7:</span> <span class="string">lowerLayerDown</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hh3cIfStatFlowHCInBytes</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.2</span><span class="number">.40</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.5</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">counter</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">In</span> <span class="string">bytes</span> <span class="string">in</span> <span class="string">the</span> <span class="string">specified</span> <span class="string">interval</span> <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.2</span><span class="number">.40</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.5</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">lookups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">labelname:</span> <span class="string">ifAlias</span></span><br><span class="line">      <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.18</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">labelname:</span> <span class="string">ifDescr</span></span><br><span class="line">      <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">labelname:</span> <span class="string">ifName</span></span><br><span class="line">      <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hh3cIfStatFlowHCOutBytes</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.2</span><span class="number">.40</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.6</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">counter</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">Out</span> <span class="string">bytes</span> <span class="string">in</span> <span class="string">the</span> <span class="string">specified</span> <span class="string">interval</span> <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.2</span><span class="number">.40</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.6</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">lookups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">labelname:</span> <span class="string">ifAlias</span></span><br><span class="line">      <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.18</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">labelname:</span> <span class="string">ifDescr</span></span><br><span class="line">      <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ifIndex</span></span><br><span class="line">      <span class="attr">labelname:</span> <span class="string">ifName</span></span><br><span class="line">      <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DisplayString</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hh3cLswSysIpAddr</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.18</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">InetAddressIPv4</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">System</span> <span class="string">IP</span> <span class="string">address,</span> <span class="string">which</span> <span class="string">is</span> <span class="string">the</span> <span class="string">primary</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">of</span> <span class="string">the</span> <span class="string">VLAN</span> <span class="string">interface</span></span><br><span class="line">      <span class="string">that</span> <span class="string">has</span> <span class="string">smallest</span> <span class="string">VLAN</span> <span class="string">ID</span> <span class="string">and</span> <span class="string">is</span> <span class="string">configured</span> <span class="string">IP</span> <span class="string">address.</span> <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.18</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hh3cLswSlotMemoryRatio</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.18</span><span class="number">.4</span><span class="number">.3</span><span class="number">.1</span><span class="number">.13</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">percentage</span> <span class="string">of</span> <span class="string">system</span> <span class="string">memory</span> <span class="string">in</span> <span class="string">use</span> <span class="string">on</span> <span class="string">the</span> <span class="string">board</span> <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.18</span><span class="number">.4</span><span class="number">.3</span><span class="number">.1</span><span class="number">.13</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">hh3cLswFrameIndex</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">hh3cLswSlotIndex</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hh3cLswSlotCpuRatio</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.18</span><span class="number">.4</span><span class="number">.3</span><span class="number">.1</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">CPU</span> <span class="string">usage</span> <span class="string">of</span> <span class="string">the</span> <span class="string">slot</span> <span class="string">in</span> <span class="string">accuracy</span> <span class="string">of</span> <span class="number">1</span><span class="string">%,</span> <span class="string">and</span> <span class="string">the</span> <span class="string">range</span> <span class="string">of</span> <span class="string">value</span> <span class="string">is</span> <span class="number">1</span> <span class="string">to</span></span><br><span class="line">      <span class="number">100</span><span class="string">.</span> <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.18</span><span class="number">.4</span><span class="number">.3</span><span class="number">.1</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">hh3cLswFrameIndex</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">hh3cLswSlotIndex</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hh3cDevMPowerStatus</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.25506</span><span class="number">.8</span><span class="number">.35</span><span class="number">.9</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">&#x27;Power status: active (1), deactive (2) not installed (3) and unsupported</span></span><br><span class="line"><span class="string">      - 1.3.6.1.4.1.25506.8.35.9.1.2.1.2&#x27;</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">hh3cDevMPowerNum</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">enum_values:</span></span><br><span class="line">      <span class="attr">1:</span> <span class="string">active</span></span><br><span class="line">      <span class="attr">2:</span> <span class="string">deactive</span></span><br><span class="line">      <span class="attr">3:</span> <span class="string">not-install</span></span><br><span class="line">      <span class="attr">4:</span> <span class="string">unsupport</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">max_repetitions:</span> <span class="number">25</span></span><br><span class="line">  <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">community:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure><h3 id="浪潮服务器配置示例"><a href="#浪潮服务器配置示例" class="headerlink" title="浪潮服务器配置示例"></a>浪潮服务器配置示例</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># WARNING: This file was auto-generated using snmp_exporter generator, manual changes will be lost.</span></span><br><span class="line"><span class="attr">Inspur:</span></span><br><span class="line">  <span class="attr">walk:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.5</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span><span class="number">.19</span><span class="number">.9</span><span class="number">.65</span><span class="number">.115</span><span class="number">.115</span><span class="number">.101</span><span class="number">.116</span><span class="number">.32</span><span class="number">.84</span><span class="number">.97</span><span class="number">.103</span> <span class="comment">#机器fru信息</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span> <span class="comment">#电源模块PSU当前在位状态</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span> <span class="comment">#CPU状态</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span> <span class="comment">#电压sensor健康状态,0-N/A;1-Normal;2-Warning;3-Critical</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span> <span class="comment">#温度sensor的健康状态,0-N/A;1-Normal;2-Warning;3-Critical</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span> <span class="comment">#风扇转速,0-N/A;1-Normal;2-Warning;3-Critical</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.4</span> <span class="comment">#前置硬盘状态 0-N/A;1-Normal;2-Warning;3-Critical</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.6</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.9</span> <span class="comment">#硬盘状态监控信息(驱动器插槽)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.6</span><span class="number">.1</span><span class="number">.1</span><span class="number">.9</span> <span class="comment">#电源power 0-N/A;1-Normal;2-Warning;3-Critical</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.5</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span> <span class="comment">#内存监控 0-N/A;1-Normal;2-Warning;3-Critical</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.6</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.4</span> <span class="comment">#raid类型,比如raid1 raid5 raid10</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.6</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.2</span> <span class="comment">#Raid卡健康状态信息, &quot;Absent&quot;,&quot;Normal&quot;,&quot;Critical&quot;,&quot;N/A&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.14</span><span class="number">.1</span><span class="number">.1</span><span class="number">.5</span> <span class="comment">#网卡健康状态，显示为&quot;Normal&quot;,&quot;Warning&quot;,&quot;Critical&quot;,&quot;N/A&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverFRUInfoSetupAttributeValue</span>  <span class="comment">#机器fru信息:序列号</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.5</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span><span class="number">.19</span><span class="number">.9</span><span class="number">.65</span><span class="number">.115</span><span class="number">.115</span><span class="number">.101</span><span class="number">.116</span><span class="number">.32</span><span class="number">.84</span><span class="number">.97</span><span class="number">.103</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverFRUInfoSetupAttributeValue</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">机器fru</span> <span class="string">序列号信息</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverPowerSupplyMonitorPresent</span>  <span class="comment">#电源模块PSU当前在位状态</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverPowerSupplyMonitorPresent</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">电源模块PSU当前在位状态</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverCPUInfoPresent</span>  <span class="comment">#CPU当前在位状态</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverCPUInfoPresent</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">CPU当前在位状态</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverRaidDiskInfoVolumeraidLevel</span>  <span class="comment"># raid卡类型</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.6</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">serverRaidDiskInfoVolumeraidLevel</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">raid卡类型</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverVoltageStatus</span> <span class="comment">#电压sensor健康状态</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverVoltagestatus</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">电压sensor健康状态</span> <span class="number">1</span><span class="string">表示正常</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">enum_values:</span></span><br><span class="line">      <span class="attr">0:</span> <span class="string">N/A</span></span><br><span class="line">      <span class="attr">1:</span> <span class="string">Normal</span></span><br><span class="line">      <span class="attr">2:</span> <span class="string">Warning</span></span><br><span class="line">      <span class="attr">3:</span> <span class="string">Critical</span></span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverTemperatureSensorStatus</span> <span class="comment">#温度sensor的健康状态</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverTemperatureSensorStatus</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">温度sensor的健康状态</span> <span class="number">1</span><span class="string">表示正常</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">enum_values:</span></span><br><span class="line">      <span class="attr">0:</span> <span class="string">N/A</span></span><br><span class="line">      <span class="attr">1:</span> <span class="string">Normal</span></span><br><span class="line">      <span class="attr">2:</span> <span class="string">Warning</span></span><br><span class="line">      <span class="attr">3:</span> <span class="string">Critical</span></span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverFanSensorStatus</span> <span class="comment">#风扇转速状态</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverFanSensorStatus</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">风扇转速状态</span> <span class="number">1</span><span class="string">表示正常</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">enum_values:</span></span><br><span class="line">      <span class="attr">0:</span> <span class="string">N/A</span></span><br><span class="line">      <span class="attr">1:</span> <span class="string">Normal</span></span><br><span class="line">      <span class="attr">2:</span> <span class="string">Warning</span></span><br><span class="line">      <span class="attr">3:</span> <span class="string">Critical</span></span><br><span class="line">         </span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverMemoryStatus</span> <span class="comment">#内存监控</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.5</span><span class="number">.1</span><span class="number">.1</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverMemoryStatus</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">内存监控</span> <span class="number">1</span><span class="string">代表正常</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">enum_values:</span></span><br><span class="line">      <span class="attr">0:</span> <span class="string">N/A</span></span><br><span class="line">      <span class="attr">1:</span> <span class="string">Normal</span></span><br><span class="line">      <span class="attr">2:</span> <span class="string">Warning</span></span><br><span class="line">      <span class="attr">3:</span> <span class="string">Critical</span>        </span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverPowerSupplyStatus</span> <span class="comment">#电源power</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.6</span><span class="number">.1</span><span class="number">.1</span><span class="number">.9</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverPowerSupplyStatus</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">电源power</span> <span class="number">1</span><span class="string">代表正常</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">enum_values:</span></span><br><span class="line">      <span class="attr">0:</span> <span class="string">N/A</span></span><br><span class="line">      <span class="attr">1:</span> <span class="string">Normal</span></span><br><span class="line">      <span class="attr">2:</span> <span class="string">Warning</span></span><br><span class="line">      <span class="attr">3:</span> <span class="string">Critical</span>       </span><br><span class="line">          </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverFrontHDStatus</span> <span class="comment">#前置物理磁盘健康状态</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverFrontHDStatus</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">前置物理磁盘健康状态</span> <span class="string">Normal代表正常</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverDriveSlotStatus</span> <span class="comment">#硬盘健康状态信息(驱动器插槽)</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.6</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.9</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverDriveSlotStatus</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">硬盘健康状态信息</span> <span class="string">Normal代表正常</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line">    <span class="attr">enum_values:</span></span><br><span class="line">      <span class="attr">0:</span> <span class="number">0</span><span class="string">-N/A</span></span><br><span class="line">      <span class="attr">1:</span> <span class="string">Normal</span></span><br><span class="line">      <span class="attr">2:</span> <span class="string">Warning</span></span><br><span class="line">      <span class="attr">3:</span> <span class="string">Critical</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverRaidLogicDiskInfoStatus</span> <span class="comment">#Raid卡健康状态信息</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.6</span><span class="number">.3</span><span class="number">.1</span><span class="number">.1</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverRaidControllorStandardStatus</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">Raid卡健康状态信息</span> <span class="string">Optimal代表正常</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverSystemNICStandardStatus</span> <span class="comment">#网卡监控</span></span><br><span class="line">    <span class="attr">oid:</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.4</span><span class="number">.1</span><span class="number">.37945</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span><span class="number">.14</span><span class="number">.1</span><span class="number">.1</span><span class="number">.5</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DisplayString</span></span><br><span class="line">    <span class="attr">help:</span> <span class="string">The</span> <span class="string">serverSystemNICStandardStatus</span> <span class="string">of</span> <span class="string">this</span> <span class="string">conceptual</span> <span class="string">row.</span> <span class="bullet">-</span> <span class="string">网卡健康状态信息</span> <span class="string">Normal代表正常</span></span><br><span class="line">    <span class="attr">indexes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">labelname:</span> <span class="string">inspur</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">gauge</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">version:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">max_repetitions:</span> <span class="number">25</span></span><br><span class="line">  <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">community:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">security_level:</span> <span class="string">authPriv</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">sysadmin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">rootuser</span></span><br><span class="line">    <span class="attr">auth_protocol:</span> <span class="string">MD5</span></span><br><span class="line">    <span class="attr">priv_protocol:</span> <span class="string">DES</span></span><br><span class="line">    <span class="attr">priv_password:</span> <span class="string">rootuser</span></span><br></pre></td></tr></table></figure><h3 id="验证-snmp-exporter"><a href="#验证-snmp-exporter" class="headerlink" title="验证 snmp exporter"></a>验证 snmp exporter</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9116/snmp?module=if_mib,arista_sw&amp;target=192.0.0.8</span><br></pre></td></tr></table></figure><h2 id="prometheus-采集"><a href="#prometheus-采集" class="headerlink" title="prometheus 采集"></a>prometheus 采集</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;Inspurserver&#x27;</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">file_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/prometheus/conf.d/inspur_server.yml</span></span><br><span class="line">      <span class="attr">refresh_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/snmp</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">Inspur</span>]</span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">10.200</span><span class="number">.4</span><span class="number">.64</span><span class="string">:9130</span> </span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;h3cswitch&#x27;</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">file_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/prometheus/conf.d/h3c_switch.yml</span></span><br><span class="line">      <span class="attr">refresh_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/snmp</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">H3C</span>]</span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="number">10.200</span><span class="number">.4</span><span class="number">.64</span><span class="string">:9131</span></span><br></pre></td></tr></table></figure><p>具体的机器配置文件在： <code>/data/prometheus/conf.d/inspur_server.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;100.200.1.23&#x27;</span>]</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&quot;lvs01&quot;</span></span><br><span class="line">    <span class="attr">addr:</span> <span class="string">&quot;100.200.1.23&quot;</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">prod</span></span><br><span class="line">    <span class="attr">dept:</span> <span class="string">hardware</span></span><br><span class="line">    <span class="attr">project:</span> <span class="string">&quot;hardware&quot;</span></span><br><span class="line">    <span class="attr">ip:</span> <span class="string">&quot;172.16.1.11&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;hardware&quot;</span></span><br><span class="line">    <span class="attr">hardware:</span> <span class="string">&quot;server&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;100.200.1.24&#x27;</span>]</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">&quot;lvs02&quot;</span></span><br><span class="line">    <span class="attr">addr:</span> <span class="string">&quot;100.200.1.24&quot;</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">prod</span></span><br><span class="line">    <span class="attr">dept:</span> <span class="string">bi</span></span><br><span class="line">    <span class="attr">project:</span> <span class="string">&quot;bi&quot;</span></span><br><span class="line">    <span class="attr">ip:</span> <span class="string">&quot;172.16.1.12&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;hardware&quot;</span></span><br><span class="line">    <span class="attr">hardware:</span> <span class="string">&quot;server&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h2&gt;&lt;p&gt;到 GitHub 下载一个可执行文件，直接运行即可，或者使用 systemd 来运行，也可以直接部署到 Kubernetes 中。&lt;br&gt;&lt;a</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="prometheus" scheme="https://zahui.fan/tags/prometheus/"/>
    
    <category term="snmp" scheme="https://zahui.fan/tags/snmp/"/>
    
  </entry>
  
  <entry>
    <title>Windows 开机自启动配置位置</title>
    <link href="https://zahui.fan/posts/smvb2h/"/>
    <id>https://zahui.fan/posts/smvb2h/</id>
    <published>2024-11-13T02:32:40.000Z</published>
    <updated>2024-11-29T04:26:41.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="注册表方式"><a href="#注册表方式" class="headerlink" title="注册表方式"></a>注册表方式</h2><h4 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br></pre></td></tr></table></figure><h4 id="个人"><a href="#个人" class="headerlink" title="个人"></a>个人</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br></pre></td></tr></table></figure><h4 id="只运行一次"><a href="#只运行一次" class="headerlink" title="只运行一次"></a>只运行一次</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</span><br></pre></td></tr></table></figure><blockquote><p>新建字符串值 – 数值名称任意,数值数据为要启动的程序路径,如 C:\Program Files (x86)\WinHotKey\WinHotKey.exe<br>或者命令行创建 <code>reg add &quot;HKLM\Software\Microsoft\Windows\CurrentVersion\Run&quot; /f /v &quot;数值名称&quot; /t REG_SZ /d &quot;程序启动路径&quot;</code></p></blockquote><h2 id="文件方式"><a href="#文件方式" class="headerlink" title="文件方式"></a>文件方式</h2><p>开机自启动也会显示在开始菜单的 startup 文件夹里。这里启动的话，是以用户身份启动，如果需要管理员权限的软件会弹窗。</p><h4 id="系统启动文件夹"><a href="#系统启动文件夹" class="headerlink" title="系统启动文件夹"></a>系统启动文件夹</h4><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">ProgramData</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Start</span> <span class="title">Menu</span>\<span class="title">Programs</span>\<span class="title">Startup</span></span></span><br></pre></td></tr></table></figure><h4 id="个人启动文件夹"><a href="#个人启动文件夹" class="headerlink" title="个人启动文件夹"></a>个人启动文件夹</h4><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\你的<span class="title">Windows</span>用户名\<span class="title">AppData</span>\<span class="title">Roaming</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Start</span> <span class="title">Menu</span>\<span class="title">Programs</span>\<span class="title">Startup</span></span></span><br></pre></td></tr></table></figure><blockquote><p>快速进入 startup 文件夹<br><code>win+r</code> 输入 <code>shell:startup</code></p></blockquote><h2 id="服务方式"><a href="#服务方式" class="headerlink" title="服务方式"></a>服务方式</h2><p>待完善</p><h2 id="定时任务方式"><a href="#定时任务方式" class="headerlink" title="定时任务方式"></a>定时任务方式</h2><p>定时任务方式启动有个好处，就是可以以管理员权限运行，不用用户授权，也就是不会 UAC 弹窗。按照如图配置即可。</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411191722190.png" alt="image.png|570"><br><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411191723758.png" alt="image.png|586"><br><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411191723472.png" alt="image.png"></p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411191724674.png" alt="image.png"></p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202411191724869.png" alt="image.png"></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;注册表方式&quot;&gt;&lt;a href=&quot;#注册表方式&quot; class=&quot;headerlink&quot; title=&quot;注册表方式&quot;&gt;&lt;/a&gt;注册表方式&lt;/h2&gt;&lt;h4 id=&quot;系统&quot;&gt;&lt;a href=&quot;#系统&quot; class=&quot;headerlink&quot; title=&quot;系统&quot;&gt;&lt;/a&gt;系统&lt;/h4&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td</summary>
        
      
    
    
    
    <category term="Windows" scheme="https://zahui.fan/categories/Windows/"/>
    
    
  </entry>
  
  <entry>
    <title>Windows常见注册表位置</title>
    <link href="https://zahui.fan/posts/smvadg/"/>
    <id>https://zahui.fan/posts/smvadg/</id>
    <published>2024-11-13T02:17:40.000Z</published>
    <updated>2024-11-29T04:26:41.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="oem-信息"><a href="#oem-信息" class="headerlink" title="oem 信息"></a>oem 信息</h2><h3 id="添加-oem-信息"><a href="#添加-oem-信息" class="headerlink" title="添加 oem 信息"></a>添加 oem 信息</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">%<span class="number">1</span> mshta vbscript:CreateObject(&quot;Shell.Application&quot;).ShellExecute(&quot;<span class="built_in">cmd</span>.exe&quot;,&quot;/c %~s0 ::&quot;,&quot;&quot;,&quot;runas&quot;,<span class="number">1</span>)(window.close)&amp;&amp;<span class="keyword">exit</span></span><br><span class="line"><span class="built_in">cd</span> /d &quot;%~dp0&quot;</span><br><span class="line"></span><br><span class="line"><span class="built_in">copy</span> logo.bmp <span class="variable">%windir%</span>\media\logo.bmp</span><br><span class="line"></span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OEMInformation&quot; /f /v &quot;SupportURL&quot; /t REG_SZ /d &quot;http://blog.sina.com.cn/iuxt&quot;</span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OEMInformation&quot; /f /v &quot;Model&quot; /t REG_SZ /d &quot;iuxt&quot;</span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OEMInformation&quot; /f /v &quot;SupportHours&quot; /t REG_SZ /d &quot;<span class="number">8</span>:<span class="number">00</span>-<span class="number">22</span>:<span class="number">00</span>&quot;</span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OEMInformation&quot; /f /v &quot;SupportPhone&quot; /t REG_SZ /d &quot;<span class="number">17621268822</span>&quot;</span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OEMInformation&quot; /f /v &quot;Logo&quot; /t REG_SZ /d &quot;C:\Windows\Media\logo.bmp&quot;</span><br><span class="line">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OEMInformation&quot; /f /v &quot;Manufacturer&quot; /t REG_SZ /d &quot;张理坤&quot;</span><br></pre></td></tr></table></figure><h3 id="删除-OEM-信息"><a href="#删除-OEM-信息" class="headerlink" title="删除 OEM 信息"></a>删除 OEM 信息</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg delete &quot;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OEMInformation&quot; /f</span><br></pre></td></tr></table></figure><h2 id="侧边栏的网盘链接（OneDrive-等）"><a href="#侧边栏的网盘链接（OneDrive-等）" class="headerlink" title="侧边栏的网盘链接（OneDrive 等）"></a>侧边栏的网盘链接（OneDrive 等）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Desktop\NameSpace</span><br></pre></td></tr></table></figure><h2 id="开机自启动注册表配置"><a href="#开机自启动注册表配置" class="headerlink" title="开机自启动注册表配置"></a>开机自启动注册表配置</h2><h4 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br></pre></td></tr></table></figure><h4 id="个人"><a href="#个人" class="headerlink" title="个人"></a>个人</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br></pre></td></tr></table></figure><h4 id="只运行一次"><a href="#只运行一次" class="headerlink" title="只运行一次"></a>只运行一次</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</span><br></pre></td></tr></table></figure><blockquote><p>新建字符串值 – 数值名称任意,数值数据为要启动的程序路径,如 C:\Program Files (x86)\WinHotKey\WinHotKey.exe<br>或者命令行创建 <code>reg add &quot;HKLM\Software\Microsoft\Windows\CurrentVersion\Run&quot; /f /v &quot;数值名称&quot; /t REG_SZ /d &quot;程序启动路径&quot;</code></p></blockquote><h2 id="登录界面不显示用户"><a href="#登录界面不显示用户" class="headerlink" title="登录界面不显示用户"></a>登录界面不显示用户</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList]</span><br><span class="line">&quot;administrator&quot;=dword:00000000</span><br></pre></td></tr></table></figure><h2 id="IE-主页"><a href="#IE-主页" class="headerlink" title="IE 主页"></a>IE 主页</h2><h3 id="个人主页"><a href="#个人主页" class="headerlink" title="个人主页"></a>个人主页</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\Main&quot; /v &quot;<span class="built_in">Start</span> Page&quot; /t reg_sz /d http://www.<span class="number">2345</span>.com/?k393991732 /f</span><br></pre></td></tr></table></figure><h3 id="系统主页"><a href="#系统主页" class="headerlink" title="系统主页"></a>系统主页</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;HKU\.DEFAULT\Software\Microsoft\Internet Explorer\Main&quot; /f /v &quot;<span class="built_in">Start</span> Page&quot; /t REG_SZ /d &quot;http://www.<span class="number">2345</span>.com/?k393991732&quot;</span><br></pre></td></tr></table></figure><h3 id="默认主页"><a href="#默认主页" class="headerlink" title="默认主页"></a>默认主页</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\Main&quot; /v &quot;Default_Page_URL&quot; /t reg_sz /d http://www.<span class="number">2345</span>.com/?k393991732 /f</span><br></pre></td></tr></table></figure><h2 id="Windows-Defender"><a href="#Windows-Defender" class="headerlink" title="Windows Defender"></a>Windows Defender</h2><p>关闭 Windows Defender</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows Defender&quot; /v &quot;DisableAntiSpyware&quot; /d <span class="number">1</span> /t REG_DWORD /f</span><br></pre></td></tr></table></figure><blockquote><p>这种方法和直接修改组策略是一样的，家庭版不支持组策略可以使用这种方式</p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;oem-信息&quot;&gt;&lt;a href=&quot;#oem-信息&quot; class=&quot;headerlink&quot; title=&quot;oem 信息&quot;&gt;&lt;/a&gt;oem 信息&lt;/h2&gt;&lt;h3 id=&quot;添加-oem-信息&quot;&gt;&lt;a href=&quot;#添加-oem-信息&quot; class=&quot;headerlink&quot; title=&quot;添加 oem 信息&quot;&gt;&lt;/a&gt;添加 oem 信息&lt;/h3&gt;&lt;figure</summary>
        
      
    
    
    
    <category term="Windows" scheme="https://zahui.fan/categories/Windows/"/>
    
    
  </entry>
  
  <entry>
    <title>Prometheus的瞬时向量(Instant vector)和区间向量(Range vector)</title>
    <link href="https://zahui.fan/posts/smrno6/"/>
    <id>https://zahui.fan/posts/smrno6/</id>
    <published>2024-11-11T03:14:30.000Z</published>
    <updated>2024-11-29T04:26:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>在 Prometheus 的表达式语言中，表达式或子表达式包括以下四种类型之一：</p><ul><li>瞬时向量（Instant vector） ： 一组时间序列，每个时间序列包含单个样本，它们共享相同的时间戳。也就是说，表达式的返回值中只会包含该时间序列中的最新的一个样本值。而相应的这样的表达式称之为瞬时向量表达式。</li><li>区间向量（Range vector） ： 一组时间序列，每个时间序列包含一段时间范围内的样本数据。</li><li>标量（Scalar） ： 一个浮点型的数据值。</li><li>字符串（String） ： 一个简单的字符串值。</li></ul><h2 id="瞬时向量"><a href="#瞬时向量" class="headerlink" title="瞬时向量"></a>瞬时向量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;job=<span class="string">&quot;prometheus&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>比如这样的，取值是一个值</p><h2 id="区间向量"><a href="#区间向量" class="headerlink" title="区间向量"></a>区间向量</h2><p>指的是指定时间段的所有瞬时向量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;job=<span class="string">&quot;prometheus&quot;</span>&#125;[5m]</span><br></pre></td></tr></table></figure><h2 id="PromQL-聚合操作"><a href="#PromQL-聚合操作" class="headerlink" title="PromQL 聚合操作"></a>PromQL 聚合操作</h2><p>例如：sum，min，max，count 等聚合函数，只能作用于瞬时向量上。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这是错误的，因为count只能作用于瞬时向量，而这个查询本身返回的是区间向量</span></span><br><span class="line">count(http_requests_total&#123;job=<span class="string">&quot;prometheus&quot;</span>&#125;[5m])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正确的如下</span></span><br><span class="line">count(http_requests_total&#123;job=<span class="string">&quot;prometheus&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;在 Prometheus 的表达式语言中，表达式或子表达式包括以下四种类型之一：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;瞬时向量（Instant vector） ： 一组时间序列，每个时间序列包含单个样本，它们共享相同的时间戳。也就是说，表达式的返回值中只会包含该时间序列中的最新的一个样本值。而相应的这样的表达式称之为瞬时向量表达式。&lt;/li&gt;
&lt;li&gt;区间向量（Range vector） ：</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="prometheus" scheme="https://zahui.fan/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>快速部署单节点kafka</title>
    <link href="https://zahui.fan/posts/slhl3q/"/>
    <id>https://zahui.fan/posts/slhl3q/</id>
    <published>2024-10-17T06:09:25.000Z</published>
    <updated>2024-10-31T03:20:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>如果需要集群部署的文档你可以在站内搜搜，之前写过。</p><p>单节点部署，不考虑高可用性，只求快速搭建出环境，一般都是自己开发或者运维做测试使用。或者业务的测试环境为了节省服务器资源采取的方案。不过我不一样，我们测试环境资源充足，我只是单纯的懒。</p><h2 id="第一步-安装-Docker"><a href="#第一步-安装-Docker" class="headerlink" title="第一步 安装 Docker"></a>第一步 安装 Docker</h2><p>部署是基于 docker 来部署的，所以要先安装 docker，安装 docker 的过程可以看这个文档：<a href="/posts/5e168f7e">快速搭建环境记录</a></p><h2 id="第二步-选择镜像"><a href="#第二步-选择镜像" class="headerlink" title="第二步 选择镜像"></a>第二步 选择镜像</h2><p>打开 docker 镜像仓库 <code>https://hub.docker.com</code> 找了找， 按照下载量排序，有以下几种，我选择 bitnami 打包的 kafka</p><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202410171116643.png" alt="image.png|1048"></p><h2 id="第三步-编写启动脚本"><a href="#第三步-编写启动脚本" class="headerlink" title="第三步 编写启动脚本"></a>第三步 编写启动脚本</h2><p>我个人不喜欢 docker-compose ，总觉得这个东西不伦不类的，论灵活不如 bash 脚本，论专业不如 Kubernetes 甚至 Docker Swarm，还不如自己写脚本来做。</p><p>需要创建一个 docker network ，默认的 bridge 网络不能通过 dns 名字找到对应的容器。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> kafka-data</span><br><span class="line">sudo <span class="built_in">chown</span> -R 1001:1001 kafka-data</span><br><span class="line"></span><br><span class="line">sudo docker network create ops</span><br><span class="line"></span><br><span class="line">sudo docker run -d --name kafka-server --hostname kafka-server \</span><br><span class="line">    --network ops \</span><br><span class="line">    -e KAFKA_CFG_NODE_ID=0 \</span><br><span class="line">    -e KAFKA_CFG_PROCESS_ROLES=controller,broker \</span><br><span class="line">    -e KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093 \</span><br><span class="line">    -e KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT \</span><br><span class="line">    -e KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka-server:9093 \</span><br><span class="line">    -e KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER \</span><br><span class="line">    -e KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=<span class="literal">true</span> \</span><br><span class="line">    -v ./kafka-data:/bitnami/kafka \</span><br><span class="line">    -p 9092:9092 \</span><br><span class="line">    -p 9093:9093 \</span><br><span class="line">    bitnami/kafka:3.8.0</span><br></pre></td></tr></table></figure><p>其中：</p><p>kafka 的启动用户 id 是 1001，所以需要给 kafka-data 目录授权，不然可能会不能写入挂载的目录。</p><h2 id="第四步-使用"><a href="#第四步-使用" class="headerlink" title="第四步 使用"></a>第四步 使用</h2><h3 id="控制台生产"><a href="#控制台生产" class="headerlink" title="控制台生产"></a>控制台生产</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --network ops --<span class="built_in">rm</span> bitnami/kafka:3.8.0 kafka-console-producer.sh --producer.config /opt/bitnami/kafka/config/producer.properties --bootstrap-server kafka-server:9092 --topic iuxt_test</span><br></pre></td></tr></table></figure><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202410171408280.png" alt="image.png"></p><h3 id="控制台消费"><a href="#控制台消费" class="headerlink" title="控制台消费"></a>控制台消费</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --network ops --<span class="built_in">rm</span> bitnami/kafka:3.8.0 kafka-console-consumer.sh --consumer.config /opt/bitnami/kafka/config/consumer.properties --bootstrap-server kafka-server:9092 --topic iuxt_test --from-beginning</span><br></pre></td></tr></table></figure><p><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202410171409368.png" alt="image.png"></p><p>其他命令查看 <a href="/posts/12ab226e">Kafka常用操作记录</a></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;如果需要集群部署的文档你可以在站内搜搜，之前写过。&lt;/p&gt;
&lt;p&gt;单节点部署，不考虑高可用性，只求快速搭建出环境，一般都是自己开发或者运维做测试使用。或者业务的测试环境为了节省服务器资源采取的方案。不过我不一样，我们测试环境资源充足，我只是单纯的懒。&lt;/p&gt;
&lt;h2 id=&quot;第一步-安装-Docker&quot;&gt;&lt;a href=&quot;#第一步-安装-Docker&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="基础运维" scheme="https://zahui.fan/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="Docker" scheme="https://zahui.fan/tags/Docker/"/>
    
    <category term="Kafka" scheme="https://zahui.fan/tags/Kafka/"/>
    
  </entry>
  
  <entry>
    <title>yaml多行文本的写法和区别</title>
    <link href="https://zahui.fan/posts/sldz99/"/>
    <id>https://zahui.fan/posts/sldz99/</id>
    <published>2024-10-15T07:24:45.000Z</published>
    <updated>2024-10-31T03:20:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>直接看效果（<code>pip install pyyaml</code>）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"></span><br><span class="line">yaml_data = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">example1: |</span></span><br><span class="line"><span class="string">  This is line one.</span></span><br><span class="line"><span class="string">  This is line two.</span></span><br><span class="line"><span class="string">example2: |-</span></span><br><span class="line"><span class="string">  This is line one.</span></span><br><span class="line"><span class="string">  This is line two.</span></span><br><span class="line"><span class="string">example3: &gt;-</span></span><br><span class="line"><span class="string">  This is line one.</span></span><br><span class="line"><span class="string">  This is line two.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 YAML 数据解析为 Python 对象</span></span><br><span class="line">data = yaml.safe_load(yaml_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问特定字段</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;example1: <span class="subst">&#123;data[<span class="string">&#x27;example1&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;example2: <span class="subst">&#123;data[<span class="string">&#x27;example2&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;example3: <span class="subst">&#123;data[<span class="string">&#x27;example3&#x27;</span>]&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>输出结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">example1: This is line one.</span><br><span class="line">This is line two.</span><br><span class="line"></span><br><span class="line">example2: This is line one.</span><br><span class="line">This is line two.</span><br><span class="line">example3: This is line one. This is line two.</span><br></pre></td></tr></table></figure><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>在 YAML 中，<code>|</code>、<code>|-</code> 和 <code>&gt;-</code> 都用于定义多行字符串，但它们的处理方式不同：</p><ol><li><p><code>|</code></p><ul><li>保留换行符。</li><li>生成的字符串在每行的末尾保留换行符。</li></ul></li><li><p><code>|-</code></p><ul><li>类似于 <code>|</code>，但去掉最后的换行符。</li><li>结果中的最后一行不会有换行符。</li></ul></li><li><p><code>&gt;-</code></p><ul><li>将换行符转换为空格。</li><li>结果中的所有行会被连接成一行，中间用空格分隔，最后一行也没有换行符。</li></ul></li></ol>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;直接看效果（&lt;code&gt;pip install pyyaml&lt;/code&gt;）：&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span</summary>
        
      
    
    
    
    <category term="开发" scheme="https://zahui.fan/categories/%E5%BC%80%E5%8F%91/"/>
    
    
  </entry>
  
  <entry>
    <title>Grafana 接入 LDAP 认证</title>
    <link href="https://zahui.fan/posts/sl8dop/"/>
    <id>https://zahui.fan/posts/sl8dop/</id>
    <published>2024-10-12T06:50:48.000Z</published>
    <updated>2024-10-31T03:20:09.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>Grafana</code> 是一个非常好用的展示数据软件，我一直以为可以直接在设置里增加 ldap 配置，没想到啊没想到 必须要修改配置文件才能接入到 <code>LDAP</code>，还是记录一下吧，免得下次部署浪费时间。</p><p>我是在 <code>Kubernetes</code> 中部署的，数据存储用的是 <code>MySQL</code>，所以 <code>Grafana</code> 本身可以当作一个无状态服务来看待。也可以不做数据持久化。</p><h2 id="先创建-ldap-配置文件"><a href="#先创建-ldap-配置文件" class="headerlink" title="先创建 ldap 配置文件"></a>先创建 ldap 配置文件</h2><p>这里包括 ldap 数据的映射关系，可以自己尝试修改调整。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-ldap-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">ldap.toml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [[servers]]</span></span><br><span class="line"><span class="string">    host = &quot;10.0.0.11&quot;</span></span><br><span class="line"><span class="string">    port = 389</span></span><br><span class="line"><span class="string">    use_ssl = false</span></span><br><span class="line"><span class="string">    start_tls = false</span></span><br><span class="line"><span class="string">    ssl_skip_verify = false</span></span><br><span class="line"><span class="string">    bind_dn = &quot;cn=admin,dc=i,dc=com&quot;</span></span><br><span class="line"><span class="string">    bind_password = &quot;password&quot;</span></span><br><span class="line"><span class="string">    search_filter = &quot;(uid=%s)&quot;</span></span><br><span class="line"><span class="string">    search_base_dns = [&quot;dc=i,dc=com&quot;]</span></span><br><span class="line"><span class="string">    [servers.attributes]</span></span><br><span class="line"><span class="string">    member_of = &quot;memberOf&quot;</span></span><br><span class="line"><span class="string">    email =  &quot;uid&quot;</span></span><br><span class="line"><span class="string">    name = &quot;cn&quot;</span></span><br><span class="line"><span class="string">    username = &quot;uid&quot;</span></span><br></pre></td></tr></table></figure><h2 id="创建-deployment-和-service"><a href="#创建-deployment-和-service" class="headerlink" title="创建 deployment 和 service"></a>创建 deployment 和 service</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">472</span></span><br><span class="line">        <span class="attr">supplementalGroups:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ldap-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">grafana-ldap-config</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/yaml/images:grafana-11.2.2-ubuntu</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_BASIC_ENABLED</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ENABLED</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ORG_ROLE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">Admin</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DASHBOARDS_JSON_ENABLED</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">admin</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">admin</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_TYPE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">mysql</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_HOST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.65</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;3306&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">root</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">password</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">grafana</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_LDAP_ENABLED</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_LDAP_ALLOW_SIGN_UP</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_LDAP_CONFIG_FILE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/etc/grafana/ldap.toml</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http-grafana</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/robots.txt</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">750Mi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ldap-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/grafana/ldap.toml</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">ldap.toml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># type: NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-grafana</span></span><br><span class="line">      <span class="comment"># nodePort: 30030</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure><h2 id="创建-ingress"><a href="#创建-ingress" class="headerlink" title="创建 ingress"></a>创建 ingress</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># kubernetes.io/ingress.class: &quot;nginx&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">internet</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">grafana.i.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">i-com</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">grafana.i.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure><h2 id="验证-LADP-字段配置"><a href="#验证-LADP-字段配置" class="headerlink" title="验证 LADP 字段配置"></a>验证 LADP 字段配置</h2><p>配置好以后，使用默认管理员账户登录： 默认账号密码：<code>admin/admin</code> 登录以后，在 <code>管理</code> – <code>身份验证</code> – <code>LDAP</code> 里验证字段的映射情况。<br><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202410121607340.png" alt="image.png"></p><h2 id="LADP-用户权限调整"><a href="#LADP-用户权限调整" class="headerlink" title="LADP 用户权限调整"></a>LADP 用户权限调整</h2><p>默认情况下，权限是 viewer，只可以查看，不能编辑，系统后台也不能修改权限。如图：<br><img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202410121551118.png" alt="image.png"></p><p>需要到 ldap 来配置权限并同步到 Grafana，我们只希望 ldap 做个轻量的用户数据库，不希望赋予 ldap 太多的功能，这里我们直接修改数据库来修改权限。</p><ol><li>先到 user 表查询用户 id<br> <img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202410121559413.png" alt="image.png"></li><li>再到 org_user 表中修改 role 字段为 Admin 即可赋予该用户 Admin 权限<br> <img src= "https://static.zahui.fan/public/nes.gif" data-lazy-src="https://static.zahui.fan/images/202410121600773.png" alt="image.png"></li></ol>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;code&gt;Grafana&lt;/code&gt; 是一个非常好用的展示数据软件，我一直以为可以直接在设置里增加 ldap 配置，没想到啊没想到 必须要修改配置文件才能接入到 &lt;code&gt;LDAP&lt;/code&gt;，还是记录一下吧，免得下次部署浪费时间。&lt;/p&gt;
&lt;p&gt;我是在 &lt;code&gt;Kubernetes&lt;/code&gt; 中部署的，数据存储用的是 &lt;code&gt;MySQL&lt;/code&gt;，所以</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="OpenLDAP" scheme="https://zahui.fan/tags/OpenLDAP/"/>
    
    <category term="grafana" scheme="https://zahui.fan/tags/grafana/"/>
    
  </entry>
  
</feed>
