<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>杂烩饭</title>
  <icon>https://zahui.fan/favicon.ico</icon>
  <subtitle>张理坤的博客 - 运维技术分享</subtitle>
  <link href="https://zahui.fan/atom.xml" rel="self"/>
  
  <link href="https://zahui.fan/"/>
  <updated>2025-07-25T02:54:49.000Z</updated>
  <id>https://zahui.fan/</id>
  
  <author>
    <name>张理坤</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用openssl制作自签名双向认证证书</title>
    <link href="https://zahui.fan/posts/szkilc/"/>
    <id>https://zahui.fan/posts/szkilc/</id>
    <published>2025-07-17T23:58:24.000Z</published>
    <updated>2025-07-25T02:54:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>可以直接使用我制作好的工具，支持自签名 HTTPS 证书和双向认证证书，纯 shell 脚本，支持 Docker 使用，一键生成证书：<a href="https://github.com/iuxt/my_cert">https://github.com/iuxt/my_cert</a></p><p>双向认证用途是什么： 双向认证就是客户端需要携带证书来请求服务器，证书校验通过了才会正常返回。比如说我有个网站只有自己访问，就可以配置双向认证，自己电脑安装一下证书就可以访问，还可以通过吊销证书的方式来禁止对应的人访问网站。</p><h2 id="CA-证书"><a href="#CA-证书" class="headerlink" title="CA 证书"></a>CA 证书</h2><h3 id="生成-CA-私钥"><a href="#生成-CA-私钥" class="headerlink" title="生成 CA 私钥"></a>生成 CA 私钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ca.key 4096</span><br></pre></td></tr></table></figure><p>生成一个 <code>ca.key</code> 文件</p><h3 id="生成-CA-证书"><a href="#生成-CA-证书" class="headerlink" title="生成 CA 证书"></a>生成 CA 证书</h3><div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">非交互式创建</button><button type="button" class="tab">交互式创建</button></div><div class="tab-contents"><div class="tab-item-content active"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -utf8 -new -x509 -days 3650 -key ca.key -out ca.crt -subj <span class="string">&#x27;/C=CN/ST=Shanghai/L=Pudong/O=iuxt/OU=张理坤/CN=www.i.com/emailAddress=iuxt@qq.com&#x27;</span></span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -utf8 -new -x509 -days 3650 -key ca.key -out ca.crt</span><br></pre></td></tr></table></figure><p>需要交互式输入:</p><table><thead><tr><th>提示</th><th>含义</th><th>输入内容</th></tr></thead><tbody><tr><td>Country Name</td><td>国家</td><td>CN</td></tr><tr><td>State or Province Name</td><td>省</td><td>Shanghai</td></tr><tr><td>Locality Name</td><td>市</td><td>留空</td></tr><tr><td>Organization Name</td><td>组织名,公司名</td><td>iuxt</td></tr><tr><td>Organizational Unit Name</td><td>团体名</td><td>留空</td></tr><tr><td>Common Name</td><td>你的名字或域名</td><td>zhanglikun</td></tr><tr><td>Email Address</td><td>电子邮箱</td><td><a href="mailto:&#x69;&#117;&#120;&#x74;&#64;&#113;&#113;&#x2e;&#x63;&#111;&#x6d;">iuxt@qq.com</a></td></tr></tbody></table></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div><p>就可以生成 <code>ca.crt</code> 文件, 这个文件需要加入到客户端的 <code>受信任的根证书颁发机构</code></p><h2 id="制作双向认证客户端证书"><a href="#制作双向认证客户端证书" class="headerlink" title="制作双向认证客户端证书"></a>制作双向认证客户端证书</h2><p>我是在 <code>Ubuntu 24.04</code> 系统下操作。不同系统可能会有差别。</p><h3 id="生成证书吊销列表"><a href="#生成证书吊销列表" class="headerlink" title="生成证书吊销列表"></a>生成证书吊销列表</h3><p>准备一份 <code>openssl.cnf</code> 配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[ ca ]</span><br><span class="line">default_ca = CA_default</span><br><span class="line"></span><br><span class="line">[ CA_default ]</span><br><span class="line"># 根目录设置为自定义路径</span><br><span class="line">dir = ./ca</span><br><span class="line"></span><br><span class="line"># 默认算法</span><br><span class="line">default_md = sha256</span><br><span class="line"></span><br><span class="line"># CA 的数据库文件</span><br><span class="line">database = $dir/index.txt</span><br><span class="line"># 证书的序列号文件</span><br><span class="line">serial = $dir/serial</span><br><span class="line"># 新证书的默认有效期</span><br><span class="line">default_days = 365</span><br><span class="line"># 吊销证书的理由</span><br><span class="line">crl_reason = unspecified</span><br><span class="line"># 默认的证书颁发策略</span><br><span class="line">policy = policy_anything</span><br><span class="line"></span><br><span class="line"># CRL 选项</span><br><span class="line">crlnumber = $dir/crlnumber</span><br><span class="line">default_crl_days = 30</span><br><span class="line">crl_extensions = crl_ext</span><br><span class="line"></span><br><span class="line">[ policy_anything ]</span><br><span class="line"># 配置任何策略</span><br><span class="line">countryName = optional</span><br><span class="line">stateOrProvinceName = optional</span><br><span class="line">organizationName = optional</span><br><span class="line">organizationalUnitName = optional</span><br><span class="line">commonName = supplied</span><br><span class="line">emailAddress = optional</span><br><span class="line"></span><br><span class="line">[ crl_ext ]</span><br><span class="line"># CRL 的扩展配置</span><br><span class="line">authorityKeyIdentifier = keyid:always</span><br></pre></td></tr></table></figure><h3 id="吊销指定证书"><a href="#吊销指定证书" class="headerlink" title="吊销指定证书"></a>吊销指定证书</h3><p>其他的证书都是 ca 签发的, 不管是 nginx 用的 server 证书,还是双向认证用到的 client 证书, 吊销证书后需要重新生成 crl 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> ca/index.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># crlnumber初始化，第一次给个初始值即可，后面不需要修改，每次重新生成crl的时候会自增。</span></span><br><span class="line">[ ! -f ca/crlnumber ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;01&quot;</span> &gt; ca/crlnumber</span><br><span class="line"></span><br><span class="line"><span class="comment"># 吊销指定证书</span></span><br><span class="line">openssl ca  -config openssl.cnf -cert ca/ca.crt  -keyfile  ca/ca.key  -revoke ssl/i.com.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 吊销完成后，重新生成吊销列表，建议定期重新生成 CRL 文件，并在 Nginx 上 reload 配置</span></span><br><span class="line">openssl ca -config openssl.cnf  -cert ca/ca.crt  -keyfile  ca/ca.key  -gencrl -out ca/crl.pem</span><br></pre></td></tr></table></figure><h3 id="服务端-nginx-配置"><a href="#服务端-nginx-配置" class="headerlink" title="服务端 nginx 配置"></a>服务端 nginx 配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  listen [::]:80;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  listen [::]:443 ssl;</span><br><span class="line">  ssl_certificate   ssl/i.com.crt;</span><br><span class="line">  ssl_certificate_key ssl/i.com.key;</span><br><span class="line">  ssl_session_timeout 5m;</span><br><span class="line">  ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">  ssl_prefer_server_ciphers on;</span><br><span class="line">  server_name i.com;</span><br><span class="line"></span><br><span class="line">  ssl_client_certificate ssl/ca.crt;       # 配置 CA 证书，用于验证客户端证书的签发者</span><br><span class="line">  ssl_verify_client on;                    # 启用客户端证书验证</span><br><span class="line">  ssl_crl ssl/crl.pem;                     # 配置 CRL 文件路径，用于检查吊销的证书</span><br><span class="line"></span><br><span class="line">  client_max_body_size 1024m;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">          default_type text/plain;</span><br><span class="line">          return 200 &quot;hello&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="配置客户端-client-证书"><a href="#配置客户端-client-证书" class="headerlink" title="配置客户端 client 证书"></a>配置客户端 client 证书</h2><p>证书生成方式和上面一样，p12 格式包含私钥和证书（iPhone 想导入的话，必须设置密码。）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> zhangsan.crt -inkey zhangsan.key -out zhangsan.p12</span><br></pre></td></tr></table></figure><h3 id="Windows-系统"><a href="#Windows-系统" class="headerlink" title="Windows 系统"></a>Windows 系统</h3><p>双击导入，存储位置选择个人<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/202411071859189.png" alt="image.png"></p><p>访问对应网站的时候浏览器会提示让选择证书<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/202411071900128.png" alt="image.png|593"></p><p>这是证书被吊销的样子：<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/202411071900403.png" alt="image.png|593"></p><h3 id="iPhone-手机"><a href="#iPhone-手机" class="headerlink" title="iPhone 手机"></a>iPhone 手机</h3><p>先在文件里点击一下 p12 文件<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/2025/07/fa3a67c3a23c675bc5d1c9a0b1c64fbc.png" alt="IMG_5978-1.png|283"></p><p>然后到 VPN 与设备管理里<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/2025/07/7e78a2fe2e97dc9cd3bfc41d883cd953.png" alt="IMG_5979-1.png|302"></p><p>选择已下载的描述文件，进行安装。</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="Windows-删除个人证书"><a href="#Windows-删除个人证书" class="headerlink" title="Windows 删除个人证书"></a>Windows 删除个人证书</h3><p>win + r 运行，输入 <code>certmgr.msc</code> 进入证书管理器。或者在开始菜单搜索 <code>管理用户证书</code> 进入。找到证书，右键删除即可。</p><h3 id="iPhone-删除证书"><a href="#iPhone-删除证书" class="headerlink" title="iPhone 删除证书"></a>iPhone 删除证书</h3><p>删除描述文件即可。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;可以直接使用我制作好的工具，支持自签名 HTTPS 证书和双向认证证书，纯 shell 脚本，支持 Docker 使用，一键生成证书：&lt;a href=&quot;https://github.com/iuxt/my_cert&quot;&gt;https://github.com/iuxt/my_cert&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;双向认证用途是什么：</summary>
        
      
    
    
    
    <category term="基础运维" scheme="https://zahui.fan/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="SSL" scheme="https://zahui.fan/tags/SSL/"/>
    
    <category term="Auth" scheme="https://zahui.fan/tags/Auth/"/>
    
  </entry>
  
  <entry>
    <title>minio自建对象存储</title>
    <link href="https://zahui.fan/posts/syv4vu/"/>
    <id>https://zahui.fan/posts/syv4vu/</id>
    <published>2025-07-04T07:02:18.000Z</published>
    <updated>2025-07-04T08:22:35.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="docker-部署"><a href="#docker-部署" class="headerlink" title="docker 部署"></a>docker 部署</h2><blockquote><p>这里我指定了 network，我的 nginx 也是用的这个 network，可以直接用 名字 来访问</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --name minio -d \</span><br><span class="line">    --env-file=.<span class="built_in">env</span> \</span><br><span class="line">    --network iuxt \</span><br><span class="line">    -v ./data:/data \</span><br><span class="line">    -v ./config:/root/.mc \</span><br><span class="line">    minio/minio:RELEASE.2025-04-22T22-12-26Z server --console-address <span class="string">&quot;:9001&quot;</span> /data</span><br></pre></td></tr></table></figure><p>.env 配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MINIO_ROOT_USER=username</span><br><span class="line">MINIO_ROOT_PASSWORD=password</span><br><span class="line">MINIO_SERVER_URL=https://minio.xxx.com</span><br><span class="line">MINIO_BROWSER_REDIRECT_URL=https://minio.xxx.com/ui/</span><br><span class="line">MC_CONFIG_DIR=/root/.mc</span><br></pre></td></tr></table></figure><h2 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name minio.xxx.com;</span><br><span class="line">    client_max_body_size 0;</span><br><span class="line"></span><br><span class="line">    ssl_certificate         ssl/xxx.com.crt;</span><br><span class="line">    ssl_certificate_key     ssl/xxx.com.key;</span><br><span class="line">    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line">    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    ssl_session_cache shared:SSL:10m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">    add_header Strict-Transport-Security &quot;max-age=31536000&quot;;</span><br><span class="line">    error_page 497  https://$host$request_uri;</span><br><span class="line"></span><br><span class="line">    # API endpoint</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        proxy_pass http://minio:9000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # Console endpoint</span><br><span class="line">    location /ui/ &#123;</span><br><span class="line">        rewrite ^/ui/(.*) /$1 break;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        proxy_pass http://minio:9001;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="mc-命令创建-apikey"><a href="#mc-命令创建-apikey" class="headerlink" title="mc 命令创建 apikey"></a>mc 命令创建 apikey</h2><p>在 <code>RELEASE.2025-04-22T22-12-26Z</code> 这个版本之后 minio 把控制台的管理功能给砍了，顺便还送了你一个每次打开都会弹出的通知。可以继续使用 <code>RELEASE.2025-04-22T22-12-26Z</code> 这个版本。如果你不幸更新了版本，你需要使用 mc 命令来创建 API key。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加节点管理，命名为minio</span></span><br><span class="line">mc <span class="built_in">alias</span> <span class="built_in">set</span> minio http://127.0.0.1:9000 &lt;USERNAME&gt; &lt;PASSWORD&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户 </span></span><br><span class="line">mc admin user add minio &lt;KEY ID&gt; &lt;KEY SECRET&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分配权限</span></span><br><span class="line">mc admin policy attach minio readwrite --user=&lt;KEY ID&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;docker-部署&quot;&gt;&lt;a href=&quot;#docker-部署&quot; class=&quot;headerlink&quot; title=&quot;docker 部署&quot;&gt;&lt;/a&gt;docker 部署&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;这里我指定了 network，我的 nginx 也是用的这个 network，可以直接用 名字 来访问&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure</summary>
        
      
    
    
    
    <category term="工具" scheme="https://zahui.fan/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="搭建" scheme="https://zahui.fan/tags/%E6%90%AD%E5%BB%BA/"/>
    
    <category term="存储" scheme="https://zahui.fan/tags/%E5%AD%98%E5%82%A8/"/>
    
    <category term="对象存储" scheme="https://zahui.fan/tags/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/"/>
    
  </entry>
  
  <entry>
    <title>ingress-nginx 使用自定义的nginx配置</title>
    <link href="https://zahui.fan/posts/sygayi/"/>
    <id>https://zahui.fan/posts/sygayi/</id>
    <published>2025-06-26T06:49:30.000Z</published>
    <updated>2025-06-30T03:40:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>新版 ingress 增强了 “ 安全性 “, 它认为用户自己写的 nginx 配置文件不安全，所以又加了限制。我的 ingress 版本是： 1.12.2</p><p>比如有个需求，Spring Boot 写的程序有个 &#x2F;actuator 路径，安全审查不通过，如果是个 nginx 可以通过：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /actuator &#123;</span><br><span class="line">    return 404;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>来直接让它返回 404</p><h2 id="configmap"><a href="#configmap" class="headerlink" title="configmap"></a>configmap</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">allow-snippet-annotations:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">annotations-risk-level:</span> <span class="string">Critical</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">public-ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">public-ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">public-ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">1.12</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">public-ingress-nginx-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public-ingress-nginx</span></span><br></pre></td></tr></table></figure><p>加上这两个配置：<br><code>allow-snippet-annotations</code><br><code>annotations-risk-level</code></p><p>风险等级，在这里可以查到：<br><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations-risk/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations-risk/</a></p><h2 id="ingress-配置"><a href="#ingress-配置" class="headerlink" title="ingress 配置"></a>ingress 配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-headers:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-methods:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-origin:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      location /actuator &#123;</span></span><br><span class="line"><span class="string">        return 404;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">name:</span> <span class="string">mtls</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">vos</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">public-nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">a.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">a.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">a-com</span></span><br></pre></td></tr></table></figure><p>server-snippet 作用于 server 块<br>configuration-snippet 作用于 location 块</p><p>注意：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="string">&#x27;true&#x27;</span></span><br></pre></td></tr></table></figure><p>当启用 <code>use-regex</code> 时，所有路径都会被当作正则表达式处理，会影响到匹配。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;新版 ingress 增强了 “ 安全性 “, 它认为用户自己写的 nginx 配置文件不安全，所以又加了限制。我的 ingress 版本是： 1.12.2&lt;/p&gt;
&lt;p&gt;比如有个需求，Spring Boot 写的程序有个 &amp;#x2F;actuator 路径，安全审查不通过，如果是个 nginx 可以通过：&lt;/p&gt;
&lt;figure class=&quot;highlight</summary>
        
      
    
    
    
    <category term="容器" scheme="https://zahui.fan/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>P12格式证书与PEM格式转换</title>
    <link href="https://zahui.fan/posts/sycvjt/"/>
    <id>https://zahui.fan/posts/sycvjt/</id>
    <published>2025-06-24T10:23:52.000Z</published>
    <updated>2025-07-17T16:21:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>P12 证书是整合了公钥和私钥的，还可以给 P12 证书设置密码。</p><h2 id="P12-转换为-PEM"><a href="#P12-转换为-PEM" class="headerlink" title="P12 转换为 PEM"></a>P12 转换为 PEM</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提取证书</span></span><br><span class="line">openssl pkcs12 -<span class="keyword">in</span> 1.p12  -clcerts -nokeys -out certificate.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取加密的私钥</span></span><br><span class="line">openssl pkcs12 -<span class="keyword">in</span> 1.p12 -nocerts -out private_key.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取未加密的私钥</span></span><br><span class="line">openssl pkcs12 -<span class="keyword">in</span> 1.p12 -nocerts -nodes -out private_key.key</span><br></pre></td></tr></table></figure><p>这种是加密的 PEM 私钥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN ENCRYPTED PRIVATE KEY-----</span><br><span class="line">...</span><br><span class="line">-----END ENCRYPTED PRIVATE KEY-----</span><br></pre></td></tr></table></figure><p>也可以将加密的 PEM 私钥转换成未加密的 PEM 私钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> encrypt.key -out nopassword.key</span><br></pre></td></tr></table></figure><p>未加密的 PEM 私钥长这样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN PRIVATE KEY-----</span><br><span class="line">...</span><br><span class="line">-----END PRIVATE KEY-----</span><br></pre></td></tr></table></figure><h2 id="PEM-公钥和私钥转换成-P12"><a href="#PEM-公钥和私钥转换成-P12" class="headerlink" title="PEM 公钥和私钥转换成 P12"></a>PEM 公钥和私钥转换成 P12</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -<span class="built_in">export</span> -out certificate.p12 -inkey privateKey.key -<span class="keyword">in</span> certificate.crt</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;P12 证书是整合了公钥和私钥的，还可以给 P12 证书设置密码。&lt;/p&gt;
&lt;h2 id=&quot;P12-转换为-PEM&quot;&gt;&lt;a href=&quot;#P12-转换为-PEM&quot; class=&quot;headerlink&quot; title=&quot;P12 转换为 PEM&quot;&gt;&lt;/a&gt;P12 转换为 PEM&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td</summary>
        
      
    
    
    
    <category term="基础运维" scheme="https://zahui.fan/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="SSL" scheme="https://zahui.fan/tags/SSL/"/>
    
  </entry>
  
  <entry>
    <title>使用blackbox-exporter做域名监控</title>
    <link href="https://zahui.fan/posts/sxztsa/"/>
    <id>https://zahui.fan/posts/sxztsa/</id>
    <published>2025-06-17T09:16:58.000Z</published>
    <updated>2025-06-18T07:28:39.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="blackbox-创建模块"><a href="#blackbox-创建模块" class="headerlink" title="blackbox 创建模块"></a>blackbox 创建模块</h2><p>对应的 blackbox exporter 的配置文件：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">http_2xx:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">valid_http_versions:</span> [<span class="string">&quot;HTTP/1.1&quot;</span>, <span class="string">&quot;HTTP/2&quot;</span>]</span><br><span class="line">      <span class="attr">valid_status_codes:</span> [<span class="number">200</span>]</span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">preferred_ip_protocol:</span> <span class="string">&quot;ip4&quot;</span></span><br><span class="line">  <span class="attr">http_post_2xx:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">valid_http_versions:</span> [<span class="string">&quot;HTTP/1.1&quot;</span>, <span class="string">&quot;HTTP/2&quot;</span>]</span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">preferred_ip_protocol:</span> <span class="string">&quot;ip4&quot;</span></span><br><span class="line">  <span class="attr">tcp_connect:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">2s</span></span><br><span class="line">  <span class="attr">icmp:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">icmp</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">2s</span></span><br><span class="line">    <span class="attr">icmp:</span></span><br><span class="line">      <span class="attr">preferred_ip_protocol:</span> <span class="string">&quot;ip4&quot;</span></span><br><span class="line">  <span class="attr">http_accept_404:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">valid_status_codes:</span> [<span class="number">200</span>, <span class="number">201</span>, <span class="number">204</span>, <span class="number">404</span>]  <span class="comment"># 404 也被视为正常</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">preferred_ip_protocol:</span> <span class="string">&quot;ip4&quot;</span></span><br><span class="line">      <span class="attr">no_follow_redirects:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>其中：</p><ul><li>http_2xx： get 请求 200 认为是正常的</li><li>http_post_2xx： post 请求 200 认为是正常的</li><li>tcp_connect： 测试端口是不是通的</li><li>icmp：能否 ping 通</li><li>http_accept_404： get 请求，404 也认为是正常的</li></ul><h2 id="配置-Prometheus"><a href="#配置-Prometheus" class="headerlink" title="配置 Prometheus"></a>配置 Prometheus</h2><h3 id="HTTP-监控-只有-200-是正常请求"><a href="#HTTP-监控-只有-200-是正常请求" class="headerlink" title="HTTP 监控 只有 200 是正常请求"></a>HTTP 监控 只有 200 是正常请求</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;http_get&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;https://test.com&#x27;</span>]</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">生产环境域名</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;http://1.1.1.1:8888&#x27;</span>]</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">测试IP地址</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">blackbox-exporter.monitor.svc:9115</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br></pre></td></tr></table></figure><h3 id="HTTP-监控-2xx-和-404-都认为是正常请求"><a href="#HTTP-监控-2xx-和-404-都认为是正常请求" class="headerlink" title="HTTP 监控 2xx 和 404 都认为是正常请求"></a>HTTP 监控 2xx 和 404 都认为是正常请求</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;http_get_with_404&#x27;</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">http_accept_404</span>]</span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;https://test.com&#x27;</span>]</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">生产环境域名</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;http://1.1.1.1:8888&#x27;</span>]</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">测试IP地址</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">blackbox-exporter.monitor.svc:9115</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br></pre></td></tr></table></figure><h3 id="TCP-端口监控"><a href="#TCP-端口监控" class="headerlink" title="TCP 端口监控"></a>TCP 端口监控</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">port</span></span><br><span class="line">  <span class="attr">honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tcp_connect</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">follow_redirects:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;1.1.1.1:8662&#x27;</span>]</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">密码机-1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;2.2.2.2:8662&#x27;</span>]</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">密码机-2</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">addr</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+):(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">port</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$2</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">blackbox-exporter:9115</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&quot;http://blackbox-exporter.monitor:9115/probe?target=http://a.test.com&amp;module=http_accept_404&quot;</span></span><br></pre></td></tr></table></figure><h2 id="PromQL-常用查询"><a href="#PromQL-常用查询" class="headerlink" title="PromQL 常用查询"></a>PromQL 常用查询</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询证书到期时间</span></span><br><span class="line">(probe_ssl_earliest_cert_expiry&#123;project=<span class="string">&quot;project1&quot;</span>,<span class="built_in">env</span>=<span class="string">&quot;prod&quot;</span>&#125; - time()) / 60 / 60 / 24</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询接口通不通</span></span><br><span class="line">probe_success&#123;project=<span class="string">&quot;project1&quot;</span>,<span class="built_in">env</span>=<span class="string">&quot;prod&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询接口延迟，包括 tcp监控 http监控</span></span><br><span class="line">probe_duration_seconds&#123;project=<span class="string">&quot;project1&quot;</span>,<span class="built_in">env</span>=<span class="string">&quot;prod&quot;</span>&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;blackbox-创建模块&quot;&gt;&lt;a href=&quot;#blackbox-创建模块&quot; class=&quot;headerlink&quot; title=&quot;blackbox 创建模块&quot;&gt;&lt;/a&gt;blackbox 创建模块&lt;/h2&gt;&lt;p&gt;对应的 blackbox exporter 的配置文件：&lt;/p&gt;
&lt;figure class=&quot;highlight yml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="prometheus" scheme="https://zahui.fan/tags/prometheus/"/>
    
    <category term="监控" scheme="https://zahui.fan/tags/%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>MySQL字符集转换导致的故障</title>
    <link href="https://zahui.fan/posts/sxl41q/"/>
    <id>https://zahui.fan/posts/sxl41q/</id>
    <published>2025-06-09T10:34:38.000Z</published>
    <updated>2025-06-10T11:34:42.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250609183441693.png" alt="image.png"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> vehicle_user_role <span class="keyword">CONVERT</span> <span class="keyword">TO</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci;</span><br></pre></td></tr></table></figure><p>导致 CPU 飙升</p><p>回滚的时候：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> vehicle_user_role <span class="keyword">CONVERT</span> <span class="keyword">TO</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br></pre></td></tr></table></figure><p>报错：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR <span class="number">1366</span> (HY000): Incorrect string <span class="keyword">value</span>: <span class="string">&#x27;\xF0\x9F\x90\x92&quot;&#125;&#x27;</span> <span class="keyword">for</span> <span class="keyword">column</span> <span class="string">&#x27;EXT&#x27;</span> <span class="keyword">at</span> <span class="type">row</span> <span class="number">333582</span></span><br></pre></td></tr></table></figure><p>找到这条数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vehicle_user_role <span class="keyword">WHERE</span> HEX(`EXT`) <span class="keyword">LIKE</span> <span class="string">&#x27;%F09F9092%&#x27;</span> LIMIT <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>清理不正确的数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> vehicle_user_role <span class="keyword">SET</span> EXT <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">WHERE</span> ROLE_ID <span class="operator">=</span> <span class="string">&#x27;df169ce2c1dd4574b014cb184b970f8e&#x27;</span>;</span><br></pre></td></tr></table></figure><p>再次转换：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> vehicle_user_role <span class="keyword">CONVERT</span> <span class="keyword">TO</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br></pre></td></tr></table></figure><p>只转换字段。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> vehicle_user_role MODIFY <span class="keyword">COLUMN</span> EXT <span class="type">varchar</span>(<span class="number">500</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;img src= &quot;https://s3.babudiu.com/iuxt/public/nes.gif&quot; data-lazy-src=&quot;https://s3.babudiu.com/iuxt/images/20250609183441693.png&quot; alt=&quot;image.png&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td</summary>
        
      
    
    
    
    <category term="数据库" scheme="https://zahui.fan/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="踩坑记录" scheme="https://zahui.fan/tags/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>使用双向认证增加git仓库安全性</title>
    <link href="https://zahui.fan/posts/sxb6po/"/>
    <id>https://zahui.fan/posts/sxb6po/</id>
    <published>2025-06-04T01:56:12.000Z</published>
    <updated>2025-06-04T03:06:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>双向认证是用户需要提供证书来访问服务器，没有证书的用户不允许访问服务器，并且在服务端可以实现吊销指定用户的证书来实现禁止用户访问。配置 https 双向认证会影响到使用 https 协议拉取和推送代码，以及 git lfs 的正常使用 (lfs 使用 https 协议)，ssh 协议使用代码仓库不受影响。</p><h2 id="配置双向认证"><a href="#配置双向认证" class="headerlink" title="配置双向认证"></a>配置双向认证</h2><p>我是用的自签名证书，自签名证书的文档可以查看 <a href="/posts/097e5b7c/">制作和使用自签名证书</a> 或者我的开源项目：<a href="https://github.com/iuxt/my_cert.git">https://github.com/iuxt/my_cert.git</a></p><h3 id="服务器上的-nginx-上配置"><a href="#服务器上的-nginx-上配置" class="headerlink" title="服务器上的 nginx 上配置"></a>服务器上的 nginx 上配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name example.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /path/to/your/server.crt;</span><br><span class="line">    ssl_certificate_key /path/to/your/server.key;</span><br><span class="line"></span><br><span class="line">    ssl_client_certificate /path/to/your/ca.crt;        # 配置 CA 证书，用于验证客户端证书的签发者</span><br><span class="line">    ssl_verify_client on;                               # 启用客户端证书验证</span><br><span class="line">    ssl_crl /path/to/your/crl.pem;                      # 配置 CRL 文件路径，用于检查吊销的证书</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /var/www/html;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置好之后，打开网页会提示：<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250604105943557.png" alt="image.png"></p><h2 id="操作系统信任-CA-证书"><a href="#操作系统信任-CA-证书" class="headerlink" title="操作系统信任 CA 证书"></a>操作系统信任 CA 证书</h2><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows 将证书导入到系统的个人分类下。</p><h3 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h3><p>macOS– 待补充。</p><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>Debian 系 Linux：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> cacert.crt /usr/local/share/ca-certificates/</span><br><span class="line">sudo update-ca-certificates</span><br></pre></td></tr></table></figure><p>RedHat 系 Linux：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> cacert.crt /etc/pki/ca-trust/source/anchors/</span><br><span class="line">sudo update-ca-trust</span><br></pre></td></tr></table></figure><p>信任完成后，浏览器重启后再次打开 git 网页：<br>选择证书，点击确定，就可以正常打开页面了。<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250604110355773.png" alt="image.png"></p><h2 id="Git-客户端配置"><a href="#Git-客户端配置" class="headerlink" title="Git 客户端配置"></a>Git 客户端配置</h2><p>上面的配置，浏览器已经可以正常携带证书来访问指定的服务了，但是 git 客户端还不行，需要对 git 仓库进行配置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要全局配置，增加 --global 参数。会写入到 ~/.gitconfig 中。</span></span><br><span class="line">git config http.sslCert C:\Users\iuxt\OneDrive\keys\manage.crt</span><br><span class="line">git config http.sslkey C:\Users\iuxt\OneDrive\keys\manage.key</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;双向认证是用户需要提供证书来访问服务器，没有证书的用户不允许访问服务器，并且在服务端可以实现吊销指定用户的证书来实现禁止用户访问。配置 https 双向认证会影响到使用 https 协议拉取和推送代码，以及 git lfs 的正常使用 (lfs 使用 https 协议)，ssh 协议使用代码仓库不受影响。&lt;/p&gt;
&lt;h2 id=&quot;配置双向认证&quot;&gt;&lt;a href=&quot;#配置双向认证&quot;</summary>
        
      
    
    
    
    <category term="基础运维" scheme="https://zahui.fan/categories/%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/"/>
    
    
  </entry>
  
  <entry>
    <title>Prometheus自动监控K8S集群中的service</title>
    <link href="https://zahui.fan/posts/sw6yvo/"/>
    <id>https://zahui.fan/posts/sw6yvo/</id>
    <published>2025-05-13T08:42:59.000Z</published>
    <updated>2025-05-27T02:36:08.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>部署在 Kubernetes 上的 Prometheus 是有自动发现机制的，可以自动监控 service 通不通、监控 ingress 上的域名通不通等等。</p><h2 id="HTTP-Get-监控"><a href="#HTTP-Get-监控" class="headerlink" title="HTTP Get 监控"></a>HTTP Get 监控</h2><h3 id="service-的-HTTP-Get-监控"><a href="#service-的-HTTP-Get-监控" class="headerlink" title="service 的 HTTP Get 监控"></a>service 的 HTTP Get 监控</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;service_http_get&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># service 需要添加注解</span></span><br><span class="line">  <span class="comment"># prometheus.io/http_get_path: /actuator/info</span></span><br><span class="line">  <span class="comment"># prometheus.io/http_get: &quot;true&quot;</span></span><br><span class="line">  <span class="comment"># prometheus.io/http_get_port: &quot;8080&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_http_get</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_http_get_port</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_http_get_path</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="comment"># 正则解释：</span></span><br><span class="line">    <span class="comment"># 第一组([^:]+) - 匹配地址部分（直到冒号或结尾）</span></span><br><span class="line">    <span class="comment"># (:[0-9]+)? - 可选匹配端口部分</span></span><br><span class="line">    <span class="comment"># ;([0-9]+) - 匹配注解中的端口</span></span><br><span class="line">    <span class="comment"># ;(/.*)? - 匹配注解中的路径（可选）</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">([^:]+)(:[0-9]+)?;([0-9]+);(/.*)?</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">http://$1:$3$4</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">blackbox-exporter.monitor.svc:9115</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 额外添加标签</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">namespace</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">service_name</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">app</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ingress-的-HTTP-Get-监控"><a href="#ingress-的-HTTP-Get-监控" class="headerlink" title="ingress 的 HTTP Get 监控"></a>ingress 的 HTTP Get 监控</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;ingress_http_get&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ingress 需要添加注解才可被自动发现</span></span><br><span class="line">  <span class="comment"># prometheus.io/http_get_path: /actuator/info</span></span><br><span class="line">  <span class="comment"># prometheus.io/http_get: &quot;true&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">ingress</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_annotation_kubernetes_io_http_get</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_scheme</span>,<span class="string">__address__</span>,<span class="string">__meta_kubernetes_ingress_annotation_kubernetes_io_http_get_path</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+);(.+);(.*)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$&#123;1&#125;://$&#123;2&#125;$&#123;3&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">blackbox-exporter.monitor.svc:9115</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 额外添加标签</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_ingress_label_(.+)</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_name</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_name</span>]</span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">app</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="收集业务-Metrics"><a href="#收集业务-Metrics" class="headerlink" title="收集业务 Metrics"></a>收集业务 Metrics</h2><p>比如有的业务会暴露出 metrics，比如 Prometheus 的各种 exporter，一个一个接入比较麻烦，也可以利用 service 自动发现的形式接入 Prometheus</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;service_endpoints_metrics&#x27;</span></span><br><span class="line">  <span class="comment"># service 需要添加元数据 通常需要有 /metrics 接口返回 prometheus 数据格式</span></span><br><span class="line">  <span class="comment"># prometheus.io/path: /metrics</span></span><br><span class="line">  <span class="comment"># prometheus.io/port: &quot;8080&quot;</span></span><br><span class="line">  <span class="comment"># prometheus.io/scrape: &quot;true&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_env</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">env</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_dept</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">dept</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_app</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">app</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_project</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">project</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  <span class="comment"># 新增标签</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_service_name</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_host_ip</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">node_ip</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">pod_name</span></span><br></pre></td></tr></table></figure><p>在需要接入监控的 service 上配置注解即可实现自动接入，注解如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ops-kafka-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kafka-exporter</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">prometheus.io/path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">&#x27;9308&#x27;</span></span><br><span class="line">    <span class="attr">prometheus.io/project:</span> <span class="string">ops</span></span><br><span class="line">    <span class="attr">prometheus.io/app:</span> <span class="string">ops-kafka</span></span><br><span class="line">    <span class="attr">prometheus.io/dept:</span> <span class="string">ep</span></span><br><span class="line">    <span class="attr">prometheus.io/env:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9308</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9308</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">ops-kafka-exporter</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;定义&quot;&gt;&lt;a href=&quot;#定义&quot; class=&quot;headerlink&quot; title=&quot;定义&quot;&gt;&lt;/a&gt;定义&lt;/h2&gt;&lt;p&gt;部署在 Kubernetes 上的 Prometheus 是有自动发现机制的，可以自动监控 service 通不通、监控 ingress 上的域名通不通等等。&lt;/p&gt;
&lt;h2 id=&quot;HTTP-Get-监控&quot;&gt;&lt;a href=&quot;#HTTP-Get-监控&quot;</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
  </entry>
  
  <entry>
    <title>Grafana 查询SQL 自定义变量</title>
    <link href="https://zahui.fan/posts/svtyfb/"/>
    <id>https://zahui.fan/posts/svtyfb/</id>
    <published>2025-05-06T08:04:22.000Z</published>
    <updated>2025-05-06T09:01:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>比如一个 dashboard 里面有很多通用的数据，不想每个 panel 面板都手动修改一遍，可以定义个全局的变量，所有面板都调用这个变量，后续需要修改的时候，直接改变量即可。</p><h2 id="面板设置里添加变量"><a href="#面板设置里添加变量" class="headerlink" title="面板设置里添加变量"></a>面板设置里添加变量</h2><p>这里添加好了之后，先打开 show on dashboard 显示</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250506163411627.png" alt="image.png"></p><p>然后选择自己需要的数据，保存的时候，勾选 update default variable values 保存当前选择的值<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250506163204899.png" alt="image.png"><br>最后再把变量隐藏起来。</p><h2 id="在查询的时候调用变量"><a href="#在查询的时候调用变量" class="headerlink" title="在查询的时候调用变量"></a>在查询的时候调用变量</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    `<span class="keyword">desc</span>` <span class="keyword">AS</span> <span class="string">&#x27;说明&#x27;</span>,</span><br><span class="line">    CONVERT_TZ(<span class="type">time</span>, <span class="string">&#x27;+08:00&#x27;</span>, <span class="string">&#x27;+00:00&#x27;</span>) <span class="keyword">AS</span> <span class="string">&#x27;最近日期&#x27;</span>,</span><br><span class="line">    vin,</span><br><span class="line">    <span class="keyword">value</span> <span class="keyword">AS</span> <span class="string">&#x27;发生数量&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    granfana.metric</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    metric_name <span class="operator">=</span> <span class="string">&#x27;active_fail&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> vin <span class="keyword">IN</span> ($&#123;users&#125;)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    最近日期 <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure><h2 id="如何调试"><a href="#如何调试" class="headerlink" title="如何调试"></a>如何调试</h2><p>点击面板设置上的 Query inspector 查询 里 可以看到原始的数据。<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250506165823095.png" alt="image.png"></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;比如一个 dashboard 里面有很多通用的数据，不想每个 panel 面板都手动修改一遍，可以定义个全局的变量，所有面板都调用这个变量，后续需要修改的时候，直接改变量即可。&lt;/p&gt;
&lt;h2 id=&quot;面板设置里添加变量&quot;&gt;&lt;a href=&quot;#面板设置里添加变量&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
  </entry>
  
  <entry>
    <title>使用selenium来实现Grafana的自动截图</title>
    <link href="https://zahui.fan/posts/suwpme/"/>
    <id>https://zahui.fan/posts/suwpme/</id>
    <published>2025-04-18T09:13:26.000Z</published>
    <updated>2025-04-22T07:37:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>selenium 是一个 python 库, 用于操作 chromium 浏览器实现一些自动化的动作, 本文是为了把 grafana 的监控图截图保存, 后续可以将图片做成运维报表之类的.</p><h2 id="调试阶段"><a href="#调试阶段" class="headerlink" title="调试阶段"></a>调试阶段</h2><p>调试阶段可以使用电脑上的 chrome,并关闭 headless 模式,方便看到界面执行的效果.<br>chrome 官网下载即可, <code>chromedriver</code> 下载地址: <a href="https://googlechromelabs.github.io/chrome-for-testing/">https://googlechromelabs.github.io/chrome-for-testing/</a> , <code>chromedriver</code> 放在代码同目录即可.</p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>为什么不用 <code>grafana-image-renderer</code>, 这个官方插件 BUG 挺多的, 比如一个图需要很长时间才能加载, 就会出现图还没加载出来, 就完成了截图的情况. 并且截图速度很慢.</p><h2 id="简单的开始"><a href="#简单的开始" class="headerlink" title="简单的开始"></a>简单的开始</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install selenium</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.service <span class="keyword">import</span> Service</span><br><span class="line"></span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="string">&quot;--no-sandbox&quot;</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">&quot;--disable-dev-shm-usage&quot;</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">&quot;--disable-extensions&quot;</span>)</span><br><span class="line"><span class="comment"># chrome_options.binary_location = &quot;&quot;           # chrome 可执行程序的路径</span></span><br><span class="line"><span class="comment"># chrome_options.add_argument(&quot;--headless&quot;)     # 无头模式</span></span><br><span class="line"><span class="comment"># chrome_options.add_argument(&quot;--disable-gpu&quot;)  # 禁用GPU加速</span></span><br><span class="line">ser = Service()</span><br><span class="line"><span class="comment"># ser.executable_path = r&#x27;./chromedriver&#x27;    # 指定 ChromeDriver 的路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化浏览器</span></span><br><span class="line">driver = webdriver.Chrome(options=chrome_options, service=ser)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置浏览器的界面大小</span></span><br><span class="line">driver.set_window_size(<span class="number">1920</span>, <span class="number">1080</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开grafana登录界面</span></span><br><span class="line">driver.get(<span class="string">&quot;https://grafana.example.com/login&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭浏览器</span></span><br><span class="line">driver.close()</span><br></pre></td></tr></table></figure><p>正常的话, 可以打开页面了, 然后浏览器会自动关闭.</p><h2 id="查找元素"><a href="#查找元素" class="headerlink" title="查找元素"></a>查找元素</h2><h3 id="从浏览器开发工具查找元素"><a href="#从浏览器开发工具查找元素" class="headerlink" title="从浏览器开发工具查找元素"></a>从浏览器开发工具查找元素</h3><p>比如说在 grafana 登陆界面,我想自动输入账号密码进行登录,那么可以使用</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250418173005375.png" alt="image.png"></p><p>在这里可以找到名字, 可以根据 NAME 来定位,也可以根据 class 定位.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 填写用户名和密码并登录</span></span><br><span class="line">username_input = driver.find_element(By.NAME, <span class="string">&quot;user&quot;</span>)</span><br><span class="line">password_input = driver.find_element(By.NAME, <span class="string">&quot;password&quot;</span>)</span><br><span class="line">login_button = driver.find_element(By.XPATH, <span class="string">&#x27;//button[@type=&quot;submit&quot;]&#x27;</span>)</span><br><span class="line">username_input.send_keys(self.username)</span><br><span class="line">password_input.send_keys(self.password)</span><br><span class="line">login_button.click()</span><br></pre></td></tr></table></figure><h3 id="等待元素出现"><a href="#等待元素出现" class="headerlink" title="等待元素出现"></a>等待元素出现</h3><p>比如我打开某个 panel 仪表板的全屏界面后, 我想等这个界面加载出来再继续,可以通过:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 等待仪表板加载完成，直到某个元素（例如第一个面板）可见</span></span><br><span class="line">WebDriverWait(driver, <span class="number">30</span>).until(</span><br><span class="line">    EC.presence_of_element_located(</span><br><span class="line">        (By.XPATH, <span class="string">&#x27;//*[@class=&quot;css-itdw1b-panel-container&quot;]&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>这里的 XPATH 获取方式:<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250418173503988.png" alt="image.png"></p><h3 id="等待元素消失"><a href="#等待元素消失" class="headerlink" title="等待元素消失"></a>等待元素消失</h3><p>比如说查看一个长时间的监控图像, 会加载很久, 这个时候需要等待图加载出来后再进行截图,我们可以监视页面上的加载 icon,等这个 icon 消失表示加载完成.<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250418173645372.png" alt="image.png"></p><p>代码如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测 Spinner 是否消失（等待最多60秒）</span></span><br><span class="line">WebDriverWait(driver, <span class="number">60</span>).until(</span><br><span class="line">    EC.invisibility_of_element_located(</span><br><span class="line">        (By.XPATH, <span class="string">&#x27;//*[@class=&quot;css-1p4srcl-Icon&quot;]&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="针对指定的-panel-进行截图"><a href="#针对指定的-panel-进行截图" class="headerlink" title="针对指定的 panel 进行截图"></a>针对指定的 panel 进行截图</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定位目标 panel 元素</span></span><br><span class="line">panel = driver.find_element(By.XPATH, <span class="string">&#x27;//*[@class=&quot;css-itdw1b-panel-container&quot;]&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对 panel 元素进行截图</span></span><br><span class="line">safe_filename = re.sub(<span class="string">r&#x27;[\\/*?:&quot;&lt;&gt;|]&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, self.panel_title) + <span class="string">&#x27;.png&#x27;</span></span><br><span class="line">panel.screenshot(safe_filename)</span><br></pre></td></tr></table></figure><p>当然也可以直接全屏截图.</p><h2 id="中文乱码问题"><a href="#中文乱码问题" class="headerlink" title="中文乱码问题"></a>中文乱码问题</h2><p>截图如下:<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250418172416136.png" alt="image.png"></p><p>修复方式为: 安装中文字体:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装微软雅黑字体</span></span><br><span class="line">apt-get install -y ttf-wqy-microhei</span><br></pre></td></tr></table></figure><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250418172544525.png" alt="image.png"></p><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p><a href="https://github.com/iuxt/grafana_auto_capture_image">https://github.com/iuxt/grafana_auto_capture_image</a></p><h2 id="容器化"><a href="#容器化" class="headerlink" title="容器化"></a>容器化</h2><p>我们最终是要以容器的形式在 Kubernetes 上的 cronjob 来定时执行. 考虑到安装 chromium 依赖非常多, 直接使用发行版源里的 chromium 更方便, 首先排除新版 ubuntu, ubutnu 的 chromium 被 snap 包替代了, 所以选择了 <code>debian:12</code> 镜像.</p><p><code>dockerfile</code> 如下:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:<span class="number">12</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/deb.debian.org/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list.d/debian.sources &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \</span></span><br><span class="line"><span class="language-bash">    chromium chromium-driver python3-pip python3-venv \</span></span><br><span class="line"><span class="language-bash">    ttf-wqy-microhei</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> code /code</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;main.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;selenium 是一个 python 库, 用于操作 chromium 浏览器实现一些自动化的动作, 本文是为了把 grafana 的监控图截图保存, 后续可以将图片做成运维报表之类的.&lt;/p&gt;
&lt;h2 id=&quot;调试阶段&quot;&gt;&lt;a href=&quot;#调试阶段&quot; class=&quot;headerlink&quot; title=&quot;调试阶段&quot;&gt;&lt;/a&gt;调试阶段&lt;/h2&gt;&lt;p&gt;调试阶段可以使用电脑上的</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="自动化" scheme="https://zahui.fan/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"/>
    
    <category term="Python" scheme="https://zahui.fan/tags/Python/"/>
    
    <category term="grafana" scheme="https://zahui.fan/tags/grafana/"/>
    
  </entry>
  
  <entry>
    <title>Filebeat直接输出到Elasticsearch</title>
    <link href="https://zahui.fan/posts/suuwju/"/>
    <id>https://zahui.fan/posts/suuwju/</id>
    <published>2025-04-17T09:47:54.000Z</published>
    <updated>2025-04-17T10:41:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>正常情况下收集日志流程为：</p><ol><li>filebeat 读取节点上指定目录日志文件 –&gt; kafka</li><li>logstash 消费 kafka 数据 –&gt; 写入到 ES 的指定索引<br>加入 kafka 会提高健壮性，可以起到削峰填谷的效果。现在是非生产环境没有 kafka，所以才采用 filebeat 写入到 ES 这种方案。另一种架构：<a href="/posts/skk1ln/">在Kubernetes下收集ingress日志到Elasticsearch</a></li></ol><h2 id="输入配置"><a href="#输入配置" class="headerlink" title="输入配置"></a>输入配置</h2><p>输入就是源日志的配置， 我这里配置了 2 个日志源，一个是 nginx ingress 的配置，记录的是所有请求的访问日志，另一个是业务 pod 的日志。通过 <code>fields.log_topic</code> 来配合下面的 output 来区分怎么输出。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">  <span class="attr">symlinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">true</span> <span class="comment"># 如果此选项设置为true, Filebeat开始在每个文件的末尾读取新文件, 默认设置是false。</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/containers/*vos-xxx-pre*.log</span></span><br><span class="line">  <span class="attr">exclude_files:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;ingress-nginx-controller*&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">log_topic:</span> <span class="string">k8s-pod-logs</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;pre-logs&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&#x27;</span></span><br><span class="line">  <span class="attr">multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">  <span class="attr">symlinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">json.overwrite_keys:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">json.add_error_key:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/containers/*ingress-nginx-controller*.log</span></span><br><span class="line">  <span class="attr">processors:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">        <span class="attr">fields:</span> [<span class="string">&#x27;log&#x27;</span>]</span><br><span class="line">        <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">overwrite_keys:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">process_array:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">max_depth:</span> <span class="number">1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">drop_event:</span></span><br><span class="line">        <span class="attr">when:</span></span><br><span class="line">          <span class="attr">or:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regexp:</span></span><br><span class="line">              <span class="attr">http_user_agent:</span> <span class="string">&#x27;Go-http-client&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regexp:</span></span><br><span class="line">              <span class="attr">domain:</span> <span class="string">&#x27;graylog.example.com&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regexp:</span></span><br><span class="line">              <span class="attr">domain:</span> <span class="string">&#x27;prometheus.example.com&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">log_topic:</span> <span class="string">&quot;ingress-logs&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;pre-logs&quot;</span></span><br></pre></td></tr></table></figure><h2 id="索引生命周期"><a href="#索引生命周期" class="headerlink" title="索引生命周期"></a>索引生命周期</h2><p>如果你的索引名字没有生效，变成了 filebeat 开头的， 你需要关闭 filebeat 的自动 ILM 功能：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">setup.ilm:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>关闭自动 ILM 仅仅是索引生命周期不由 filebeat 来管理，还可以手动在 es 里创建生命周期策略的方式来管理。参考 <a href="/posts/snui2r/">Elasticsearch索引生命周期配置</a></p><h2 id="索引模版配置"><a href="#索引模版配置" class="headerlink" title="索引模版配置"></a>索引模版配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">setup.template:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;ingress_logs_template&quot;</span></span><br><span class="line">  <span class="attr">pattern:</span> <span class="string">&quot;ingress*&quot;</span></span><br><span class="line">  <span class="attr">overwrite:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">settings:</span></span><br><span class="line">    <span class="attr">index:</span></span><br><span class="line">      <span class="attr">number_of_shards:</span> <span class="number">6</span></span><br><span class="line">      <span class="attr">number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;pod_logs_template&quot;</span></span><br><span class="line">  <span class="attr">pattern:</span> <span class="string">&quot;k8s-pod-logs*&quot;</span></span><br><span class="line">  <span class="attr">overwrite:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">settings:</span></span><br><span class="line">    <span class="attr">index:</span></span><br><span class="line">      <span class="attr">number_of_shards:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">number_of_replicas:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>这里可以根据 pattern 来匹配索引，比如设置副本数与分片数。</p><h2 id="输出到-ES-配置"><a href="#输出到-ES-配置" class="headerlink" title="输出到 ES 配置"></a>输出到 ES 配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.22.22.22:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;<span class="template-variable">%&#123;[fields.log_topic]&#125;</span>-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;password&quot;</span></span><br></pre></td></tr></table></figure><p>这里的 <code>%&#123;[fields.log_topic]&#125;</code> 和上面的 input 里面对应，就是不同的日志输出到不同的 ES 索引。</p><h2 id="完整的-yml-文件"><a href="#完整的-yml-文件" class="headerlink" title="完整的 yml 文件"></a>完整的 yml 文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">filebeat</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    filebeat.inputs:</span></span><br><span class="line"><span class="string">    - type: container</span></span><br><span class="line"><span class="string">      symlinks: true</span></span><br><span class="line"><span class="string">      enabled: true</span></span><br><span class="line"><span class="string">      tail_files: true #  如果此选项设置为true,Filebeat开始在每个文件的末尾读取新文件,默认设置是false。</span></span><br><span class="line"><span class="string">      paths:</span></span><br><span class="line"><span class="string">        - /var/log/containers/*vos-a66-t-pre*.log</span></span><br><span class="line"><span class="string">      exclude_files: </span></span><br><span class="line"><span class="string">        - &#x27;ingress-nginx-controller\.*&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">log_topic:</span> <span class="string">k8s-pod-logs</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;pre-logs&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&#x27;</span></span><br><span class="line">      <span class="attr">multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">      <span class="attr">symlinks:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">json.overwrite_keys:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">json.add_error_key:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">tail_files:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/var/log/containers/*ingress-nginx-controller*.log</span></span><br><span class="line">      <span class="attr">processors:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">decode_json_fields:</span></span><br><span class="line">            <span class="attr">fields:</span> [<span class="string">&#x27;log&#x27;</span>]</span><br><span class="line">            <span class="attr">target:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="attr">overwrite_keys:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">process_array:</span> <span class="literal">false</span></span><br><span class="line">            <span class="attr">max_depth:</span> <span class="number">1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">drop_event:</span></span><br><span class="line">            <span class="attr">when:</span></span><br><span class="line">              <span class="attr">or:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">regexp:</span></span><br><span class="line">                  <span class="attr">http_user_agent:</span> <span class="string">&#x27;Go-http-client&#x27;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">regexp:</span></span><br><span class="line">                  <span class="attr">domain:</span> <span class="string">&#x27;graylog.example.com&#x27;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">regexp:</span></span><br><span class="line">                  <span class="attr">domain:</span> <span class="string">&#x27;prometheus.example.com&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">log_topic:</span> <span class="string">&quot;ingress-logs&quot;</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;pre-logs&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">filebeat.config.modules:</span></span><br><span class="line">      <span class="comment"># Glob pattern for configuration loading</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">      <span class="comment"># Set to true to enable config reloading</span></span><br><span class="line">      <span class="attr">reload.enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># Period on which files under path should be checked for changes</span></span><br><span class="line">      <span class="comment">#reload.period: 10s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">setup.template:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;ingress_logs_template&quot;</span></span><br><span class="line">      <span class="attr">pattern:</span> <span class="string">&quot;ingress*&quot;</span></span><br><span class="line">      <span class="attr">overwrite:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">settings:</span></span><br><span class="line">        <span class="attr">index:</span></span><br><span class="line">          <span class="attr">number_of_shards:</span> <span class="number">6</span></span><br><span class="line">          <span class="attr">number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;pod_logs_template&quot;</span></span><br><span class="line">      <span class="attr">pattern:</span> <span class="string">&quot;k8s-pod-logs*&quot;</span></span><br><span class="line">      <span class="attr">overwrite:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">settings:</span></span><br><span class="line">        <span class="attr">index:</span></span><br><span class="line">          <span class="attr">number_of_shards:</span> <span class="number">2</span></span><br><span class="line">          <span class="attr">number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">          </span><br><span class="line">    <span class="attr">setup.ilm:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">    <span class="attr">setup.kibana:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">output.elasticsearch:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hosts:</span> [<span class="string">&quot;http://10.123.56.10:9200&quot;</span>]</span><br><span class="line">      <span class="attr">index:</span> <span class="string">&quot;<span class="template-variable">%&#123;[fields.log_topic]&#125;</span>-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;passwordprocessors:</span></span><br><span class="line"><span class="string">      - add_host_metadata: ~</span></span><br><span class="line"><span class="string">      - add_cloud_metadata: ~</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">kind: DaemonSet</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: filebeat</span></span><br><span class="line"><span class="string">  namespace: public</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: filebeat</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: filebeat</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: filebeat</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">        - name: config</span></span><br><span class="line"><span class="string">          configMap:</span></span><br><span class="line"><span class="string">            name: filebeat-config</span></span><br><span class="line"><span class="string">            defaultMode: 384</span></span><br><span class="line"><span class="string">        - name: varlibdockercontainers</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /var/log/containers</span></span><br><span class="line"><span class="string">            type: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        - name: varlog</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /var/log/pods</span></span><br><span class="line"><span class="string">            type: &#x27;&#x27;</span></span><br><span class="line"><span class="string">        - name: data</span></span><br><span class="line"><span class="string">          hostPath:</span></span><br><span class="line"><span class="string">            path: /var/lib/filebeat-data</span></span><br><span class="line"><span class="string">            type: DirectoryOrCreate</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: filebeat</span></span><br><span class="line"><span class="string">          image: registry.cn-hangzhou.aliyuncs.com/yaml/images:filebeat-7.3.2</span></span><br><span class="line"><span class="string">          args:</span></span><br><span class="line"><span class="string">            - &#x27;-c&#x27;</span></span><br><span class="line"><span class="string">            - /etc/filebeat.yml</span></span><br><span class="line"><span class="string">            - &#x27;-e&#x27;</span></span><br><span class="line"><span class="string">          resources:</span></span><br><span class="line"><span class="string">            limits:</span></span><br><span class="line"><span class="string">              cpu: 800m</span></span><br><span class="line"><span class="string">              memory: 300Mi</span></span><br><span class="line"><span class="string">            requests:</span></span><br><span class="line"><span class="string">              cpu: 300m</span></span><br><span class="line"><span class="string">              memory: 200Mi</span></span><br><span class="line"><span class="string">          volumeMounts:</span></span><br><span class="line"><span class="string">            - name: config</span></span><br><span class="line"><span class="string">              readOnly: true</span></span><br><span class="line"><span class="string">              mountPath: /etc/filebeat.yml</span></span><br><span class="line"><span class="string">              subPath: filebeat.yml</span></span><br><span class="line"><span class="string">            - name: data</span></span><br><span class="line"><span class="string">              mountPath: /usr/share/filebeat/data</span></span><br><span class="line"><span class="string">            - name: varlibdockercontainers</span></span><br><span class="line"><span class="string">              readOnly: true</span></span><br><span class="line"><span class="string">              mountPath: /var/log/containers</span></span><br><span class="line"><span class="string">            - name: varlog</span></span><br><span class="line"><span class="string">              readOnly: true</span></span><br><span class="line"><span class="string">              mountPath: /var/log/pods</span></span><br><span class="line"><span class="string">          terminationMessagePath: /dev/termination-log</span></span><br><span class="line"><span class="string">          terminationMessagePolicy: File</span></span><br><span class="line"><span class="string">          imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">          securityContext:</span></span><br><span class="line"><span class="string">            runAsUser: 0</span></span><br><span class="line"><span class="string">      restartPolicy: Always</span></span><br><span class="line"><span class="string">      terminationGracePeriodSeconds: 30</span></span><br><span class="line"><span class="string">      dnsPolicy: ClusterFirstWithHostNet</span></span><br><span class="line"><span class="string">      serviceAccountName: filebeat</span></span><br><span class="line"><span class="string">      serviceAccount: filebeat</span></span><br><span class="line"><span class="string">      hostNetwork: true</span></span><br><span class="line"><span class="string">      securityContext: &#123;&#125;</span></span><br><span class="line"><span class="string">      schedulerName: default-scheduler</span></span><br><span class="line"><span class="string">      tolerations:</span></span><br><span class="line"><span class="string">        - key: apptype</span></span><br><span class="line"><span class="string">          operator: Exists</span></span><br><span class="line"><span class="string">          effect: NoSchedule</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;正常情况下收集日志流程为：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;filebeat 读取节点上指定目录日志文件 –&amp;gt; kafka&lt;/li&gt;
&lt;li&gt;logstash 消费 kafka 数据 –&amp;gt; 写入到 ES 的指定索引&lt;br&gt;加入 kafka 会提高健壮性，可以起到削峰填谷的效果。现在是非生产环境没有 kafka，所以才采用 filebeat 写入到 ES 这种方案。另一种架构：&lt;a</summary>
        
      
    
    
    
    <category term="日志" scheme="https://zahui.fan/categories/%E6%97%A5%E5%BF%97/"/>
    
    
  </entry>
  
  <entry>
    <title>安装插件方式来运行grafana-image-renderer</title>
    <link href="https://zahui.fan/posts/su3lwr/"/>
    <id>https://zahui.fan/posts/su3lwr/</id>
    <published>2025-04-02T16:02:51.000Z</published>
    <updated>2025-04-05T01:36:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>安装可以使用命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install grafana-image-renderer</span><br></pre></td></tr></table></figure><p>如果不能正常访问网络，或者下载速度太慢，可以使用离线包：到这里<a href="https://grafana.com/grafana/plugins/grafana-image-renderer/?tab=installation">https://grafana.com/grafana/plugins/grafana-image-renderer/?tab=installation</a>下载离线包，然后放到 plugins 文件夹下。需要注意下 plugins 文件夹的位置，可能使用命令安装的路径和真实的 plugins 目录不一致。</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250402181200283.png" alt="image.png|654"></p><p>如果插件启动失败，报错：可以检查下 <code>plugins/grafana-image-renderer/chrome-headless-shell/linux-136.0.7101.0/chrome-headless-shell-linux64</code> 这个程序能否正常运行，如果报错<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250402181642753.png" alt="image.png"></p><p>需要安装 <code>apt install -y libasound2t64</code></p><h2 id="完整配置容器"><a href="#完整配置容器" class="headerlink" title="完整配置容器"></a>完整配置容器</h2><p>Dockerfile：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> grafana/grafana-oss:<span class="number">11.5</span>.<span class="number">3</span>-ubuntu</span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    ca-certificates \</span></span><br><span class="line"><span class="language-bash">    fonts-liberation \</span></span><br><span class="line"><span class="language-bash">    libasound2 \</span></span><br><span class="line"><span class="language-bash">    libatk-bridge2.0-0 \</span></span><br><span class="line"><span class="language-bash">    libatk1.0-0 \</span></span><br><span class="line"><span class="language-bash">    libc6 \</span></span><br><span class="line"><span class="language-bash">    libcairo2 \</span></span><br><span class="line"><span class="language-bash">    libcups2 \</span></span><br><span class="line"><span class="language-bash">    libdbus-1-3 \</span></span><br><span class="line"><span class="language-bash">    libexpat1 \</span></span><br><span class="line"><span class="language-bash">    libfontconfig1 \</span></span><br><span class="line"><span class="language-bash">    libgbm1 \</span></span><br><span class="line"><span class="language-bash">    libgcc1 \</span></span><br><span class="line"><span class="language-bash">    libglib2.0-0 \</span></span><br><span class="line"><span class="language-bash">    libgtk-3-0 \</span></span><br><span class="line"><span class="language-bash">    libnspr4 \</span></span><br><span class="line"><span class="language-bash">    libnss3 \</span></span><br><span class="line"><span class="language-bash">    libpango-1.0-0 \</span></span><br><span class="line"><span class="language-bash">    libpangocairo-1.0-0 \</span></span><br><span class="line"><span class="language-bash">    libstdc++6 \</span></span><br><span class="line"><span class="language-bash">    libx11-6 \</span></span><br><span class="line"><span class="language-bash">    libx11-xcb1 \</span></span><br><span class="line"><span class="language-bash">    libxcb1 \</span></span><br><span class="line"><span class="language-bash">    libxcomposite1 \</span></span><br><span class="line"><span class="language-bash">    libxcursor1 \</span></span><br><span class="line"><span class="language-bash">    libxdamage1 \</span></span><br><span class="line"><span class="language-bash">    libxext6 \</span></span><br><span class="line"><span class="language-bash">    libxfixes3 \</span></span><br><span class="line"><span class="language-bash">    libxi6 \</span></span><br><span class="line"><span class="language-bash">    libxrandr2 \</span></span><br><span class="line"><span class="language-bash">    libxrender1 \</span></span><br><span class="line"><span class="language-bash">    libxss1 \</span></span><br><span class="line"><span class="language-bash">    libxtst6 \</span></span><br><span class="line"><span class="language-bash">    lsb-release \</span></span><br><span class="line"><span class="language-bash">    wget \</span></span><br><span class="line"><span class="language-bash">    xdg-utils \</span></span><br><span class="line"><span class="language-bash">    fonts-noto-cjk \</span></span><br><span class="line"><span class="language-bash">    ttf-wqy-microhei &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    fc-cache -f -v &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt clean all</span></span><br><span class="line"><span class="keyword">USER</span> grafana</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> grafana cli plugins install grafana-image-renderer</span></span><br></pre></td></tr></table></figure><h2 id="kubernetes-部署配置"><a href="#kubernetes-部署配置" class="headerlink" title="kubernetes 部署配置"></a>kubernetes 部署配置</h2><p>k8s 运行的时候，需要配置 <code>root_url</code> 被这个坑了很久，完整的配置文件如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-ldap-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">ldap.toml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [[servers]]</span></span><br><span class="line"><span class="string">    host = &quot;1.1.1.1&quot;</span></span><br><span class="line"><span class="string">    port = 389</span></span><br><span class="line"><span class="string">    use_ssl = false</span></span><br><span class="line"><span class="string">    start_tls = false</span></span><br><span class="line"><span class="string">    ssl_skip_verify = false</span></span><br><span class="line"><span class="string">    bind_dn = &quot;cn=admin,dc=example,dc=com&quot;</span></span><br><span class="line"><span class="string">    bind_password = &quot;example&quot;</span></span><br><span class="line"><span class="string">    search_filter = &quot;(uid=%s)&quot;</span></span><br><span class="line"><span class="string">    search_base_dns = [&quot;dc=example,dc=com&quot;]</span></span><br><span class="line"><span class="string">    [servers.attributes]</span></span><br><span class="line"><span class="string">    member_of = &quot;memberOf&quot;</span></span><br><span class="line"><span class="string">    email =  &quot;uid&quot;</span></span><br><span class="line"><span class="string">    name = &quot;cn&quot;</span></span><br><span class="line"><span class="string">    username = &quot;uid&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sre-grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sre-grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">sre-grafana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">sre-grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ldap-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">grafana-ldap-config</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/iuxt/grafana-with-render:11.5.3-ubuntu</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-grafana</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_BASIC_ENABLED</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ENABLED</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ORG_ROLE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">Admin</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DASHBOARDS_JSON_ENABLED</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">admin</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SECURITY_ADMIN_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">admin</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_TYPE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">mysql</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_HOST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;3306&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">root</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">example</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_DATABASE_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">sre-grafana</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_LDAP_ENABLED</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_LDAP_ALLOW_SIGN_UP</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_LDAP_CONFIG_FILE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/etc/grafana/ldap.toml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SERVER_ROOT_URL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">https://sre-grafana.example.com/</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">750Mi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ldap-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/grafana/ldap.toml</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">ldap.toml</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/robots.txt</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">          <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">supplementalGroups:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">472</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sre-grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sre-grafana</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sre-grafana</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sre-grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">private-nginx</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sre-grafana.example.com</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">example-com</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">sre-grafana.example.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">sre-grafana</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;安装可以使用命令：&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;grafana-cli plugins install</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="Docker" scheme="https://zahui.fan/tags/Docker/"/>
    
    <category term="grafana" scheme="https://zahui.fan/tags/grafana/"/>
    
    <category term="Puppeteer" scheme="https://zahui.fan/tags/Puppeteer/"/>
    
  </entry>
  
  <entry>
    <title>使用 Python 自动截图 Grafana 仪表盘，实现可视化监控快照</title>
    <link href="https://zahui.fan/posts/stucr2/"/>
    <id>https://zahui.fan/posts/stucr2/</id>
    <published>2025-03-28T16:06:38.000Z</published>
    <updated>2025-04-05T01:37:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>官方配置文档在这里：<a href="https://grafana.com/docs/grafana/latest/setup-grafana/image-rendering/">https://grafana.com/docs/grafana/latest/setup-grafana/image-rendering/</a> 使用方式有两种，一种是直接在 grafana 机器上安装插件，另一个是使用外挂渲染器的方式。</p><h2 id="部署渲染器-grafana-image-renderer"><a href="#部署渲染器-grafana-image-renderer" class="headerlink" title="部署渲染器 grafana-image-renderer"></a>部署渲染器 grafana-image-renderer</h2><blockquote><p>官方有现成的镜像，也可以不用自己构建镜像: <code>grafana/grafana-image-renderer:3.12.3</code> 也可以用 bitnami 打包的镜像：<code>bitnami/grafana-image-renderer:latest</code>， 我哼哧哼哧搞了半天才想起来官方也有镜像😓</p></blockquote><p>我的 grafana 是运行在 kubernetes 里的，所以选择用外挂渲染器的方法。渲染器核心用的是 Puppeteer，根据官网文档安装依赖包：<a href="https://pptr.dev/troubleshooting#chrome-doesnt-launch-on-linux">https://pptr.dev/troubleshooting#chrome-doesnt-launch-on-linux</a> ，另外增加了中文字体包，解决了中文显示框框的问题。最终的渲染器镜像 dockerfile 如下：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">22.14</span>.<span class="number">0</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> --depth 1 https://github.com/grafana/grafana-image-renderer.git /app &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cd</span> /app &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    yarn install --pure-lockfile &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    yarn run build</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/deb.debian.org/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list.d/debian.sources &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    ca-certificates \</span></span><br><span class="line"><span class="language-bash">    fonts-liberation \</span></span><br><span class="line"><span class="language-bash">    libasound2 \</span></span><br><span class="line"><span class="language-bash">    libatk-bridge2.0-0 \</span></span><br><span class="line"><span class="language-bash">    libatk1.0-0 \</span></span><br><span class="line"><span class="language-bash">    libc6 \</span></span><br><span class="line"><span class="language-bash">    libcairo2 \</span></span><br><span class="line"><span class="language-bash">    libcups2 \</span></span><br><span class="line"><span class="language-bash">    libdbus-1-3 \</span></span><br><span class="line"><span class="language-bash">    libexpat1 \</span></span><br><span class="line"><span class="language-bash">    libfontconfig1 \</span></span><br><span class="line"><span class="language-bash">    libgbm1 \</span></span><br><span class="line"><span class="language-bash">    libgcc1 \</span></span><br><span class="line"><span class="language-bash">    libglib2.0-0 \</span></span><br><span class="line"><span class="language-bash">    libgtk-3-0 \</span></span><br><span class="line"><span class="language-bash">    libnspr4 \</span></span><br><span class="line"><span class="language-bash">    libnss3 \</span></span><br><span class="line"><span class="language-bash">    libpango-1.0-0 \</span></span><br><span class="line"><span class="language-bash">    libpangocairo-1.0-0 \</span></span><br><span class="line"><span class="language-bash">    libstdc++6 \</span></span><br><span class="line"><span class="language-bash">    libx11-6 \</span></span><br><span class="line"><span class="language-bash">    libx11-xcb1 \</span></span><br><span class="line"><span class="language-bash">    libxcb1 \</span></span><br><span class="line"><span class="language-bash">    libxcomposite1 \</span></span><br><span class="line"><span class="language-bash">    libxcursor1 \</span></span><br><span class="line"><span class="language-bash">    libxdamage1 \</span></span><br><span class="line"><span class="language-bash">    libxext6 \</span></span><br><span class="line"><span class="language-bash">    libxfixes3 \</span></span><br><span class="line"><span class="language-bash">    libxi6 \</span></span><br><span class="line"><span class="language-bash">    libxrandr2 \</span></span><br><span class="line"><span class="language-bash">    libxrender1 \</span></span><br><span class="line"><span class="language-bash">    libxss1 \</span></span><br><span class="line"><span class="language-bash">    libxtst6 \</span></span><br><span class="line"><span class="language-bash">    lsb-release \</span></span><br><span class="line"><span class="language-bash">    wget \</span></span><br><span class="line"><span class="language-bash">    xdg-utils \</span></span><br><span class="line"><span class="language-bash">    fonts-noto-cjk \</span></span><br><span class="line"><span class="language-bash">    fonts-wqy-microhei &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    fc-cache -f -v &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt clean all</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;build/app.js&quot;</span>, <span class="string">&quot;server&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>部署在 kubernetes 中，yml 文件如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-image-renderer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana-image-renderer</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana-image-renderer</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-image-renderer</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/iuxt/grafana-image-renderer:3</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HTTP_HOST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HTTP_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">2</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">2</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-image-renderer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana-image-renderer</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure><h2 id="Grafana-接入渲染器"><a href="#Grafana-接入渲染器" class="headerlink" title="Grafana 接入渲染器"></a>Grafana 接入渲染器</h2><p>容器运行的 grafana 接入 渲染器，增加这两个环境变量</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_RENDERING_SERVER_URL</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">http://grafana-image-renderer/render</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_RENDERING_CALLBACK_URL</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">http://grafana:3000/</span></span><br></pre></td></tr></table></figure><p>在对应的面板，点击分享 就可以拿到渲染后的图像链接，浏览器打开可以拿到对应的图片。</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250329003245507.png" alt="image.png|637"></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>核心代码就是这个，请求接口，然后保存成文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">render_panel</span>(<span class="params">self, panel_id, panel_title</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;渲染面板并保存为 PNG&quot;&quot;&quot;</span></span><br><span class="line">    response = requests.get(</span><br><span class="line">        <span class="string">f&quot;https://sre-grafana.example.com/render/d-solo/<span class="subst">&#123;self.uid&#125;</span>?orgId=1&amp;from=<span class="subst">&#123;self.date_from&#125;</span>&amp;to=<span class="subst">&#123;self.date_to&#125;</span>&amp;panelId=<span class="subst">&#123;panel_id&#125;</span>&amp;width=1500&amp;height=750&amp;scale=1&amp;tz=Asia%2FShanghai&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&quot;Authorization&quot;</span>: <span class="string">f&quot;Bearer <span class="subst">&#123;self.api_key&#125;</span>&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(response.url)</span><br><span class="line">    safe_filename = re.sub(<span class="string">r&#x27;[\\/*?:&quot;&lt;&gt;|]&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, panel_title) + <span class="string">&#x27;.png&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(safe_filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(response.content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;download png success, save to <span class="subst">&#123;safe_filename&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>但是比如想自动截取一个 dashboard 里面的每一张图，就需要进行循环 panel 了。这种方式可以拿到 dashboard 的 json：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_dashboard_json</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取仪表板 JSON 数据&quot;&quot;&quot;</span></span><br><span class="line">    response = requests.get(</span><br><span class="line">        <span class="string">f&quot;https://sre-grafana.example.com/api/dashboards/uid/<span class="subst">&#123;self.uid&#125;</span>&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&quot;Authorization&quot;</span>: <span class="string">f&quot;Bearer <span class="subst">&#123;self.api_key&#125;</span>&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> response.json()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;官方配置文档在这里：&lt;a href=&quot;https://grafana.com/docs/grafana/latest/setup-grafana/image-rendering/&quot;&gt;https://grafana.com/docs/grafana/latest/setup-grafana/image-rendering/&lt;/a&gt; 使用方式有两种，一种是直接在 grafana</summary>
        
      
    
    
    
    <category term="监控" scheme="https://zahui.fan/categories/%E7%9B%91%E6%8E%A7/"/>
    
    
    <category term="grafana" scheme="https://zahui.fan/tags/grafana/"/>
    
    <category term="Puppeteer" scheme="https://zahui.fan/tags/Puppeteer/"/>
    
  </entry>
  
  <entry>
    <title>java容器entrypoint.sh参数传递的隐藏陷阱</title>
    <link href="https://zahui.fan/posts/stgvyr/"/>
    <id>https://zahui.fan/posts/stgvyr/</id>
    <published>2025-03-21T09:35:15.000Z</published>
    <updated>2025-03-24T15:08:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>构建容器镜像对运维来说已经轻车熟路了，但是最近遇到个问题百思不得其解，准确的说就是手动执行 java -jar 带上所有参数，可以正常启动，但是打包成镜像就会报错：</p><p>先附上 <code>entrypoint.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$JVM_PARAM</span>&quot;</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;JVM_PARAM: <span class="variable">$JVM_PARAM</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  JVM_PARAM=<span class="string">&quot;-Xms2g -Xmx2g -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$JVM_OPTS</span>&quot;</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;JVM_OPTS: <span class="variable">$JVM_OPTS</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  JVM_OPTS=<span class="string">&quot;-XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+CMSClassUnloadingEnabled -XX:+ParallelRefProcEnabled -XX:+CMSScavengeBeforeRemark -XX:ErrorFile=/logs/hs_err_pid%p.log -Xloggc:/logs/gc.log -XX:HeapDumpPath=/logs -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError -XX:+PrintCommandLineFlags&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">JAVA_CMD=<span class="string">&quot;<span class="variable">$JVM_PARAM</span> <span class="variable">$JVM_OPTS</span>&quot;</span></span><br><span class="line"></span><br><span class="line">AGENT_OPTS=<span class="string">&quot;-javaagent:/hawkeye-agent/hawkeye-agent.jar=APPNAME?AGENT_UID=x-zahuifan-userid&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;true&quot;</span> == <span class="string">&quot;<span class="variable">$AGENT_ENABLED</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;JAVA_CMD: <span class="variable">$JAVA_CMD</span> <span class="variable">$AGENT_OPTS</span>&quot;</span></span><br><span class="line">    java <span class="string">&quot;<span class="variable">$JAVA_CMD</span>&quot;</span> <span class="string">&quot;<span class="variable">$AGENT_OPTS</span>&quot;</span> -jar /app/app.jar</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;JAVA_CMD: <span class="variable">$JAVA_CMD</span>&quot;</span></span><br><span class="line">    java <span class="string">&quot;<span class="variable">$JAVA_CMD</span>&quot;</span> -jar /app/app.jar</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>Dockerfile:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:xxx</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> app.jar /app.jar</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> entrypoint.sh /entrypoint.sh</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/entrypoint.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>看起来很正常对吧，但是启动报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Invalid initial heap size: -Xms2g -Xmx2g -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m -XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+CMSClassUnloadingEnabled -XX:+ParallelRefProcEnabled -XX:+CMSScavengeBeforeRemark -XX:ErrorFile=/logs/hs_err_pid%p.log -Xloggc:/logs/gc.log -XX:HeapDumpPath=/logs -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError -XX:+PrintCommandLineFlags</span><br><span class="line">Error: Could not create the Java Virtual Machine.</span><br><span class="line">Error: A fatal exception has occurred. Program will <span class="built_in">exit</span>.</span><br></pre></td></tr></table></figure><p>查看控制台，echo 出来的 <code>JAVA_CMD</code> 变量也是正常的<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250321172510730.png" alt="image.png"></p><p>中间排查过程忽略，最后增加了 <code>set -x</code> 参数后，重新打包镜像，再次查看控制台输出：</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250321171117808.png" alt="image.png"></p><p>注意以 + 开头的输出 这里 java 启动命令是被解析成了单引号引用，所以造成无法启动。把 java 启动参数中的环境变量双引号去掉，可以正常启动了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$JVM_PARAM</span>&quot;</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;JVM_PARAM: <span class="variable">$JVM_PARAM</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  JVM_PARAM=<span class="string">&quot;-Xms2g -Xmx2g -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$JVM_OPTS</span>&quot;</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;JVM_OPTS: <span class="variable">$JVM_OPTS</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  JVM_OPTS=<span class="string">&quot;-XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+CMSClassUnloadingEnabled -XX:+ParallelRefProcEnabled -XX:+CMSScavengeBeforeRemark -XX:ErrorFile=/logs/hs_err_pid%p.log -Xloggc:/logs/gc.log -XX:HeapDumpPath=/logs -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError -XX:+PrintCommandLineFlags&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">JAVA_CMD=<span class="string">&quot;<span class="variable">$JVM_PARAM</span> <span class="variable">$JVM_OPTS</span>&quot;</span></span><br><span class="line"></span><br><span class="line">AGENT_OPTS=<span class="string">&quot;-javaagent:/hawkeye-agent/hawkeye-agent.jar=APPNAME?AGENT_UID=x-zahuifan-userid&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;true&quot;</span> == <span class="string">&quot;<span class="variable">$AGENT_ENABLED</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;JAVA_CMD: <span class="variable">$JAVA_CMD</span> <span class="variable">$AGENT_OPTS</span>&quot;</span></span><br><span class="line">    java <span class="variable">$JAVA_CMD</span> <span class="variable">$AGENT_OPTS</span> -jar /app/app.jar  <span class="comment"># 这里去掉双引号</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;JAVA_CMD: <span class="variable">$JAVA_CMD</span>&quot;</span></span><br><span class="line">    java <span class="variable">$JAVA_CMD</span> -jar /app/app.jar              <span class="comment"># 这里去掉双引号</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>罪魁祸首：Shell 变量展开的分词机制<br>问题的本质在于 Shell 脚本中变量展开时的参数分割规则。当我们使用 <code>&quot;$VAR&quot;</code> 这种带引号的写法时，变量值中的所有内容会被视为一个整体参数，即使其中包含空格也不会被分割。而 Java 虚拟机要求每个参数必须作为独立的命令行参数传递。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;构建容器镜像对运维来说已经轻车熟路了，但是最近遇到个问题百思不得其解，准确的说就是手动执行 java -jar 带上所有参数，可以正常启动，但是打包成镜像就会报错：&lt;/p&gt;
&lt;p&gt;先附上 &lt;code&gt;entrypoint.sh&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span</summary>
        
      
    
    
    
    <category term="容器" scheme="https://zahui.fan/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
    <category term="Shell" scheme="https://zahui.fan/tags/Shell/"/>
    
    <category term="Docker" scheme="https://zahui.fan/tags/Docker/"/>
    
    <category term="java" scheme="https://zahui.fan/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>在 Hyper-V 下启用 Fedora 41 的增强会话模式</title>
    <link href="https://zahui.fan/posts/ssqj2c/"/>
    <id>https://zahui.fan/posts/ssqj2c/</id>
    <published>2025-03-07T03:58:59.000Z</published>
    <updated>2025-03-28T03:05:24.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装一些基础包"><a href="#安装一些基础包" class="headerlink" title="安装一些基础包"></a>安装一些基础包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install -y hyperv-tools</span><br><span class="line">sudo dnf install -y xrdp xrdp-selinux</span><br></pre></td></tr></table></figure><h2 id="配置-Fedora"><a href="#配置-Fedora" class="headerlink" title="配置 Fedora"></a>配置 Fedora</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> xrdp</span><br><span class="line">systemctl <span class="built_in">enable</span> xrdp-sesman</span><br><span class="line"></span><br><span class="line"><span class="comment"># use vsock transport.</span></span><br><span class="line">sed -i_orig -e <span class="string">&#x27;s/port=3389/port=vsock:\/\/-1:3389/g&#x27;</span> /etc/xrdp/xrdp.ini</span><br><span class="line"><span class="comment"># use rdp security.</span></span><br><span class="line">sed -i_orig -e <span class="string">&#x27;s/security_layer=negotiate/security_layer=rdp/g&#x27;</span> /etc/xrdp/xrdp.ini</span><br><span class="line"><span class="comment"># remove encryption validation.</span></span><br><span class="line">sed -i_orig -e <span class="string">&#x27;s/crypt_level=high/crypt_level=none/g&#x27;</span> /etc/xrdp/xrdp.ini</span><br><span class="line"><span class="comment"># disable bitmap compression since its local its much faster</span></span><br><span class="line">sed -i_orig -e <span class="string">&#x27;s/bitmap_compression=true/bitmap_compression=false/g&#x27;</span> /etc/xrdp/xrdp.ini</span><br><span class="line"><span class="comment"># rename the redirected drives to &#x27;shared-drives&#x27;</span></span><br><span class="line">sed -i_orig -e <span class="string">&#x27;s/FuseMountName=thinclient_drives/FuseMountName=shared-drives/g&#x27;</span> /etc/xrdp/sesman.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># Change the allowed_users</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;allowed_users=anybody&quot;</span> &gt; /etc/X11/Xwrapper.config</span><br><span class="line"></span><br><span class="line"><span class="comment">#Ensure hv_sock gets loaded</span></span><br><span class="line"><span class="keyword">if</span> [ ! -e /etc/modules-load.d/hv_sock.conf ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hv_sock&quot;</span> &gt; /etc/modules-load.d/hv_sock.conf</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Open port</span></span><br><span class="line">firewall-cmd --add-port=3389/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h2 id="配置-Hyper-V-虚拟机"><a href="#配置-Hyper-V-虚拟机" class="headerlink" title="配置 Hyper-V 虚拟机"></a>配置 Hyper-V 虚拟机</h2><p>将 Fedora 关机，以<strong>管理员</strong>身份运行 powershell：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-VM</span> <span class="literal">-VMName</span> &lt;your_vm_name&gt; <span class="literal">-EnhancedSessionTransportType</span> HvSocket</span><br></pre></td></tr></table></figure><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>代码来自：<a href="https://github.com/hu-ximing/Hyper-V-RHEL-Fedora-enhanced-session/">https://github.com/hu-ximing/Hyper-V-RHEL-Fedora-enhanced-session/</a></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;安装一些基础包&quot;&gt;&lt;a href=&quot;#安装一些基础包&quot; class=&quot;headerlink&quot; title=&quot;安装一些基础包&quot;&gt;&lt;/a&gt;安装一些基础包&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span</summary>
        
      
    
    
    
    <category term="工具" scheme="https://zahui.fan/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>Logstash 写入 ES：借助自定义模板优化数据映射与存储</title>
    <link href="https://zahui.fan/posts/ss9srz/"/>
    <id>https://zahui.fan/posts/ss9srz/</id>
    <published>2025-02-26T03:09:35.000Z</published>
    <updated>2025-02-26T03:41:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>我们的业务场景是 ES 存储的都是一些不太重要的日志，但是对存储比较敏感，但是查看了 ES 索引都是默认创建了一个副本的。这会造成存储空间翻倍。现在通过调整 logstash 配置来实现创建出来的索引应用自定义配置，比如可以实现 30 天前的日志自动清理，默认不创建副本等。</p><h2 id="创建生命周期策略"><a href="#创建生命周期策略" class="headerlink" title="创建生命周期策略"></a>创建生命周期策略</h2><p>在 ES 上创建一个生命周期策略，定义索引保留 14 天。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT _ilm/policy/user_monitor_point-retention-policy</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;phases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;hot&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0ms&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;14d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="创建-ES-模板配置文件"><a href="#创建-ES-模板配置文件" class="headerlink" title="创建 ES 模板配置文件"></a>创建 ES 模板配置文件</h2><p>准备一个 template 配置文件 <code>logstash-template.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user_monitor_point-*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;lifecycle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user_monitor_point-retention-policy&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这里定义了应用的模板规则，应用的生命周期规则，还有副本数。</p><p>logstash 配置文件 <code>logstash.conf</code></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [type] == <span class="string">&quot;logstash_mixins&quot;</span> &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">        action   =&gt; <span class="string">&quot;index&quot;</span></span><br><span class="line">        hosts    =&gt; [<span class="string">&quot;http://10.20.20.2:9200&quot;</span>, <span class="string">&quot;http://10.20.20.3:9200&quot;</span>,<span class="string">&quot;http://10.20.20.6:9200&quot;</span>]</span><br><span class="line">        index    =&gt; <span class="string">&quot;user_monitor_point-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">        user     =&gt; <span class="string">&quot;elastic&quot;</span></span><br><span class="line">        password =&gt; <span class="string">&quot;password&quot;</span></span><br><span class="line">        <span class="comment"># 这个设置控制是否自动管理索引模板。设置为 true 时，Logstash 会自动创建和管理索引模板（包括字段映射和设置）</span></span><br><span class="line">        manage_template =&gt; <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 如果已经存在相同名称的索引模板，设置 template_overwrite =&gt; true 会覆盖现有模板。</span></span><br><span class="line">        template_overwrite =&gt; <span class="literal">true</span></span><br><span class="line">        template =&gt; <span class="string">&#x27;/etc/logstash-template.json&#x27;</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样使用 logstash 创建索引的时候就会自动应用模板规则。</p><p>当然也可以将 <code>manage_template</code> 设置成 <code>false</code> 转而使用 ES 来管理索引模板配置。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;我们的业务场景是 ES 存储的都是一些不太重要的日志，但是对存储比较敏感，但是查看了 ES 索引都是默认创建了一个副本的。这会造成存储空间翻倍。现在通过调整 logstash 配置来实现创建出来的索引应用自定义配置，比如可以实现 30 天前的日志自动清理，默认不创建副本等。&lt;/p&gt;
&lt;h2 id=&quot;创建生命周期策略&quot;&gt;&lt;a href=&quot;#创建生命周期策略&quot;</summary>
        
      
    
    
    
    <category term="日志" scheme="https://zahui.fan/categories/%E6%97%A5%E5%BF%97/"/>
    
    
    <category term="Elasticsearch" scheme="https://zahui.fan/tags/Elasticsearch/"/>
    
    <category term="ES" scheme="https://zahui.fan/tags/ES/"/>
    
    <category term="logstash" scheme="https://zahui.fan/tags/logstash/"/>
    
  </entry>
  
  <entry>
    <title>使用Python识别验证码 ddddocr</title>
    <link href="https://zahui.fan/posts/ss2wk6/"/>
    <id>https://zahui.fan/posts/ss2wk6/</id>
    <published>2025-02-22T09:48:05.000Z</published>
    <updated>2025-04-01T06:36:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>GitHub 地址：<a href="https://github.com/sml2h3/ddddocr">https://github.com/sml2h3/ddddocr</a></p><p>安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install ddddocr</span><br></pre></td></tr></table></figure><p>如果 windows 安装报错：<code>ImportError：DLL load failed: 找不到指定的模块。</code><br>需要安装 vc 运行库：<br><a href="https://aka.ms/vs/16/release/VC_redist.x86.exe">https://aka.ms/vs/16/release/VC_redist.x86.exe</a></p><p><a href="https://aka.ms/vs/16/release/VC_redist.x64.exe">https://aka.ms/vs/16/release/VC_redist.x64.exe</a></p><p>基本使用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ddddocr</span><br><span class="line"></span><br><span class="line">ocr = ddddocr.DdddOcr(show_ad=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">image = <span class="built_in">open</span>(<span class="string">&quot;example.jpg&quot;</span>, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">result = ocr.classification(image)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>初始化传参 <code>show_ad=False</code> 输出就不带作者的广告了。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;GitHub 地址：&lt;a href=&quot;https://github.com/sml2h3/ddddocr&quot;&gt;https://github.com/sml2h3/ddddocr&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;安装&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span</summary>
        
      
    
    
    
    <category term="开发" scheme="https://zahui.fan/categories/%E5%BC%80%E5%8F%91/"/>
    
    
    <category term="Python" scheme="https://zahui.fan/tags/Python/"/>
    
    <category term="OCR" scheme="https://zahui.fan/tags/OCR/"/>
    
  </entry>
  
  <entry>
    <title>解决PyCharm终端使用zsh powerlevel10k主题时的乱码问题</title>
    <link href="https://zahui.fan/posts/srz9zs/"/>
    <id>https://zahui.fan/posts/srz9zs/</id>
    <published>2025-02-20T10:47:52.000Z</published>
    <updated>2025-02-20T15:12:52.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>powerlevel10k</code> 是 zsh 上很好看的主题，我一直是在 wsl 里用，配合 <code>Windows Terminal</code> 很好看，不过在 PyCharm 里打开会乱码，可以通过修改控制台字体为支持 powerline 的字体，不过还是不完美，有时候还有 BUG。</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250220230144904.png" alt="image.png|577"></p><p>想了下，我平时都是在 <code>Windows Terminal</code> 上用的，那么可以让使用 <code>Windows Terminal</code> 的时候显示成<strong>花里胡哨</strong>的主题，用其他软件比如 PyCharm 或者 VScode 的时候，换成<strong>朴素</strong>的主题。看了下，在 <code>Windows Terminal</code> 上有个特殊的环境变量 <code>WT_SESSION</code> 和 <code>WT_PROFILE_ID</code> ，看名字应该是和 Windows terminal 有关，测试了下也确实如此，那么可以修改 <code>~/.zshrc</code> 来实现。</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250220230859339.png" alt="image.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ <span class="variable">$WT_SESSION</span> ]]; <span class="keyword">then</span></span><br><span class="line">  ZSH_THEME=<span class="string">&quot;powerlevel10k/powerlevel10k&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  ZSH_THEME=<span class="string">&quot;robbyrussell&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>此时显示如下：</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250220231032118.png"></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;code&gt;powerlevel10k&lt;/code&gt; 是 zsh 上很好看的主题，我一直是在 wsl 里用，配合 &lt;code&gt;Windows Terminal&lt;/code&gt; 很好看，不过在 PyCharm 里打开会乱码，可以通过修改控制台字体为支持 powerline 的字体，不过还是不完美，有时候还有 BUG。&lt;/p&gt;
&lt;p&gt;&lt;img src=</summary>
        
      
    
    
    
    <category term="工具" scheme="https://zahui.fan/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
  <entry>
    <title>Nacos 2.0.3 集群升级为 2.1.0</title>
    <link href="https://zahui.fan/posts/srnwhe/"/>
    <id>https://zahui.fan/posts/srnwhe/</id>
    <published>2025-02-14T07:22:25.000Z</published>
    <updated>2025-02-14T07:40:13.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="2-0-3-版本的-BUG"><a href="#2-0-3-版本的-BUG" class="headerlink" title="2.0.3 版本的 BUG"></a>2.0.3 版本的 BUG</h2><p>详细 bug 在 GitHub 上有，比如：<br><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250214153333408.webp" alt="image.png"></p><p>issue 链接见：<br><a href="https://github.com/alibaba/nacos/issues/9332">https://github.com/alibaba/nacos/issues/9332</a><br><a href="https://github.com/alibaba/nacos/issues/8492">https://github.com/alibaba/nacos/issues/8492</a></p><p>我们遇到的 bug 简单一句话总结就是：集群方式部署的 nacos 其中一个节点重启后可能会有节点数据不一致的现象（服务注册与服务发现里面的服务数量不一致）比如说一个服务注册到了 nacos 中，我在 nacos 网页控制台 <code>服务管理</code> <code>服务列表</code> 里查看有 10 个服务注册进来，刷新下网页可能就变成了 9 个，再刷新又变成 10 个，这种情况就是 nacos 的多个节点数据不同步了（nacos 配置中心数据是从 MySQL 取的，不受这个 bug 的影响），这种情况可以直接将 nacos 副本数设置成 1 临时解决，想要彻底解决我们验证了升级到 2.1.0 就能修复。</p><h2 id="升级数据库表结构"><a href="#升级数据库表结构" class="headerlink" title="升级数据库表结构"></a>升级数据库表结构</h2><blockquote><p>nacos 官网文档写的太敷衍了，版本之间的差异需要自己找，哪怕你上个 flyway 也好啊。</p></blockquote><p>其中有三个表（config_info、config_info_beta、his_config_info）都加了 encrypted_data_key 这个字段。 所以升级方法也很简单，在这三张表上都加上 encrypted_data_key 这个字段就行了。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> nacos.config_info <span class="keyword">ADD</span> encrypted_data_key TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>; </span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> nacos.config_info_beta <span class="keyword">ADD</span> encrypted_data_key TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>; </span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> nacos.his_config_info <span class="keyword">ADD</span> encrypted_data_key TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure><h2 id="升级版本到-2-1-0"><a href="#升级版本到-2-1-0" class="headerlink" title="升级版本到 2.1.0"></a>升级版本到 2.1.0</h2><p>我们是部署在 Kubernetes 中的，只需要升级镜像版本就行了。一个镜像代理地址：<code>registry.cn-hangzhou.aliyuncs.com/iuxt/nacos-server:v2.1.0</code></p><p>具体部署配置查看：<a href="/posts/sebxm6/">在Kubernetes中部署nacos 2.1.0</a></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;2-0-3-版本的-BUG&quot;&gt;&lt;a href=&quot;#2-0-3-版本的-BUG&quot; class=&quot;headerlink&quot; title=&quot;2.0.3 版本的 BUG&quot;&gt;&lt;/a&gt;2.0.3 版本的 BUG&lt;/h2&gt;&lt;p&gt;详细 bug 在 GitHub 上有，比如：&lt;br&gt;&lt;img src= &quot;https://s3.babudiu.com/iuxt/public/nes.gif&quot;</summary>
        
      
    
    
    
    <category term="容器" scheme="https://zahui.fan/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
    <category term="Kubernetes" scheme="https://zahui.fan/tags/Kubernetes/"/>
    
    <category term="nacos" scheme="https://zahui.fan/tags/nacos/"/>
    
  </entry>
  
  <entry>
    <title>群晖NAS部署zerotier内网穿透访问</title>
    <link href="https://zahui.fan/posts/spi492/"/>
    <id>https://zahui.fan/posts/spi492/</id>
    <published>2025-01-03T07:17:25.000Z</published>
    <updated>2025-01-03T15:40:32.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>完成这个教程，你主要需要完成以下流程：</p><ul><li>在 NAS 上启用 SSH</li><li>创建一个持久的 TUN</li><li>安装 Docker</li><li>设置 Docker</li></ul><h2 id="创建一个持久的-TUN"><a href="#创建一个持久的-TUN" class="headerlink" title="创建一个持久的 TUN"></a>创建一个持久的 TUN</h2><div class="note info flat"><p>如果有 <code>/dev/net/tun</code> 就不用再执行了</p></div><p>使用 SSH 连接到你的 NAS，切换为 root 身份</p><p>创建一个开机自启动脚本: <code>/usr/local/etc/rc.d/tun.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建开机自启动脚本</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;#!/bin/sh -e \ninsmod /lib/modules/tun.ko&#x27;</span> &gt; /usr/local/etc/rc.d/tun.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加可执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> a+x /usr/local/etc/rc.d/tun.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动执行一下</span></span><br><span class="line">/usr/local/etc/rc.d/tun.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看是否有tun设备</span></span><br><span class="line"><span class="built_in">ls</span> /dev/net/tun</span><br></pre></td></tr></table></figure><h2 id="安装-Docker-到你的-NAS-上"><a href="#安装-Docker-到你的-NAS-上" class="headerlink" title="安装 Docker 到你的 NAS 上"></a>安装 Docker 到你的 NAS 上</h2><p>直接到套件中心去安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /var/lib/zerotier-one</span><br></pre></td></tr></table></figure><p>创建一个容器，这里将它命名为 zerotier，这里会自动下载最新版的 zerotier</p><p>要在 ssh 里创建，不要在群晖控制台创建。创建完成后可以在控制台进行管理。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d           \</span><br><span class="line">  --name zerotier       \</span><br><span class="line">  --restart=always      \</span><br><span class="line">  --device=/dev/net/tun \</span><br><span class="line">  --net=host            \</span><br><span class="line">  --cap-add=NET_ADMIN   \</span><br><span class="line">  --cap-add=SYS_ADMIN   \</span><br><span class="line">  -v /var/lib/zerotier-one:/var/lib/zerotier-one \</span><br><span class="line">  registry.cn-hangzhou.aliyuncs.com/iuxt/zerotier-synology:1.14.0</span><br></pre></td></tr></table></figure><blockquote><p>注：官方镜像：<code>zerotier/zerotier-synology:latest</code></p></blockquote><h2 id="使用与配置"><a href="#使用与配置" class="headerlink" title="使用与配置"></a>使用与配置</h2><p>查看状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it zerotier zerotier-cli status</span><br></pre></td></tr></table></figure><p>添加网络</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it zerotier zerotier-cli <span class="built_in">join</span> &lt;你的网络ID&gt;</span><br></pre></td></tr></table></figure><p>在 zerotier 后台授权当前设备，然后查看状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it zerotier zerotier-cli listnetworks</span><br></pre></td></tr></table></figure><h2 id="使局域网网段可以访问"><a href="#使局域网网段可以访问" class="headerlink" title="使局域网网段可以访问"></a>使局域网网段可以访问</h2><h3 id="1-添加路由"><a href="#1-添加路由" class="headerlink" title="1. 添加路由"></a>1. 添加路由</h3><p>假设家里的机器：zerotier 地址是：172.28.135.11，内网 IP 地址是 192.168.1.11</p><p>在 zerotier 网站的 networks 里面的 Managed Routes 下配置路由表,增加如下内容</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250103135337663.png" alt="image.png"></p><p>加过路由后，可以访问这台 zerotier 节点的内网 ip（192.168.1.11） 了，但是不能访问内网的其他 ip，还需要做一下转发。</p><h3 id="2-开启内核转发"><a href="#2-开启内核转发" class="headerlink" title="2. 开启内核转发"></a>2. 开启内核转发</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure><p>重启后配置会丢失，要持久化可以写入到 <code>/etc/sysctl.conf</code></p><h3 id="3-防火墙设置"><a href="#3-防火墙设置" class="headerlink" title="3. 防火墙设置"></a>3. 防火墙设置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PHY_IF=ovs_eth0 <span class="comment"># 物理网卡设备名</span></span><br><span class="line"><span class="built_in">export</span> ZT_IF=ztre4xmo4y <span class="comment"># Zerotier虚拟网卡设备名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加转发规则</span></span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o <span class="variable">$PHY_IF</span> -j MASQUERADE</span><br><span class="line">sudo iptables -A FORWARD -i <span class="variable">$PHY_IF</span> -o <span class="variable">$ZT_IF</span> -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">sudo iptables -A FORWARD -i <span class="variable">$ZT_IF</span> -o <span class="variable">$PHY_IF</span> -j ACCEPT</span><br></pre></td></tr></table></figure><p>防火墙规则没保存的话重启后会丢失。</p><div class="note info flat"><p>这三条 iptables 规则用于配置网络地址转换（NAT）和数据包转发；</p><p>含义如下：</p><p>规则 1： <code>sudo iptables -t nat -A POSTROUTING -o $PHY_IF -j MASQUERADE</code></p><p>这条规则在 nat 表的 POSTROUTING 链中添加了一条规则。-o $PHY_IF 表示这条规则适用于所有通过 $PHY_IF 这个网络接口（通常是物理接口）出去的数据包。-j MASQUERADE 指定了 NAT 操作中的伪装（masquerading）。这意味着，当数据包从 $PHY_IF 发送出去时，其源 IP 地址会被替换为 $PHY_IF 的 IP 地址。这通常用于允许内部网络通过一个公共 IP 地址进行外部通信；</p><p>规则 2： <code>sudo iptables -A FORWARD -i $PHY_IF -o $ZT_IF -m state --state RELATED,ESTABLISHED -j ACCEPT</code></p><p>这条规则在 filter 表的 FORWARD 链中添加了一条规则。-i $PHY_IF 表示适用于从 $PHY_IF 这个接口进入的数据包，-o $ZT_IF 表示这些数据包要转发到 $ZT_IF 这个接口。-m state –state RELATED,ESTABLISHED 指定了只有那些与已有连接相关或已经建立的连接的数据包才被接受（ACCEPT）。这个规则通常用于允许来自外部网络的返回流量进入内部网络，从而支持诸如 HTTP 会话等；</p><p>规则 3： <code>sudo iptables -A FORWARD -i $ZT_IF -o $PHY_IF -j ACCEPT</code></p><p>这条规则在 filter 表的 FORWARD 链中添加了一条规则。-i $ZT_IF 表示适用于从 $ZT_IF 这个接口进入的数据包，-o $PHY_IF 表示这些数据包要转发到 $PHY_IF 这个接口。-j ACCEPT 表示这些数据包会被接受并转发。这条规则允许来自 $ZT_IF 的流量经过路由器转发到 $PHY_IF，从而实现网络之间的数据传输；</p><p>总结：</p><p>第一条规则用于设置源地址伪装，允许内部网络设备通过一个公共 IP 地址进行外部通信；<br>第二条规则允许返回流量和已经建立的连接的数据包从外部网络进入内部网络；<br>第三条规则允许来自内部网络的数据包被转发到外部网络；</p></div><p>网卡设备名参考 在机器上使用命令 <code>ip a</code> 查看：</p><p><img src= "https://s3.babudiu.com/iuxt/public/nes.gif" data-lazy-src="https://s3.babudiu.com/iuxt/images/20250103232323506.png" alt="image.png"></p><h2 id="引用与文献"><a href="#引用与文献" class="headerlink" title="引用与文献"></a>引用与文献</h2><blockquote><p>本文基于官方原文进行翻译和补充 <a href="https://docs.zerotier.com/synology/#set-up-container">https://docs.zerotier.com/synology/#set-up-container</a><br>  iptables 规则转载自：<a href="https://jasonkayzk.github.io/2024/08/21/Zerotier%E9%85%8D%E7%BD%AE%E5%86%85%E7%BD%91%E6%B5%81%E9%87%8F%E8%BD%AC%E5%8F%91/">https://jasonkayzk.github.io/2024/08/21/Zerotier%E9%85%8D%E7%BD%AE%E5%86%85%E7%BD%91%E6%B5%81%E9%87%8F%E8%BD%AC%E5%8F%91/</a></p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;完成这个教程，你主要需要完成以下流程：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在 NAS 上启用 SSH&lt;/li&gt;
&lt;li&gt;创建一个持久的 TUN&lt;/li&gt;
&lt;li&gt;安装 Docker&lt;/li&gt;
&lt;li&gt;设置 Docker&lt;/li&gt;
&lt;/ul&gt;
&lt;h2</summary>
        
      
    
    
    
    <category term="工具" scheme="https://zahui.fan/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="网络" scheme="https://zahui.fan/tags/%E7%BD%91%E7%BB%9C/"/>
    
    <category term="nas" scheme="https://zahui.fan/tags/nas/"/>
    
  </entry>
  
</feed>
